(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function r(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=r(n);fetch(n.href,a)}})();const V=()=>{document.body.classList.add("dark-mode"),sessionStorage.setItem("dark-mode","active")},ie=()=>{document.body.classList.remove("dark-mode"),sessionStorage.setItem("dark-mode","inactive")},oe=()=>{let t=sessionStorage.getItem("dark-mode");t==="active"&&V();const e=document.getElementById("theme-switch");e!==null&&e.addEventListener("click",()=>{t=sessionStorage.getItem("dark-mode"),t!=="active"?V():ie()})};oe();var A=typeof Float32Array<"u"?Float32Array:Array;function M(){var t=new A(16);return A!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function le(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function he(t,e,r){var s=r[0],n=r[1],a=r[2],c,h,m,o,l,d,p,v,f,x,g,w;return e===t?(t[12]=e[0]*s+e[4]*n+e[8]*a+e[12],t[13]=e[1]*s+e[5]*n+e[9]*a+e[13],t[14]=e[2]*s+e[6]*n+e[10]*a+e[14],t[15]=e[3]*s+e[7]*n+e[11]*a+e[15]):(c=e[0],h=e[1],m=e[2],o=e[3],l=e[4],d=e[5],p=e[6],v=e[7],f=e[8],x=e[9],g=e[10],w=e[11],t[0]=c,t[1]=h,t[2]=m,t[3]=o,t[4]=l,t[5]=d,t[6]=p,t[7]=v,t[8]=f,t[9]=x,t[10]=g,t[11]=w,t[12]=c*s+l*n+f*a+e[12],t[13]=h*s+d*n+x*a+e[13],t[14]=m*s+p*n+g*a+e[14],t[15]=o*s+v*n+w*a+e[15]),t}function me(t,e,r){var s=Math.sin(r),n=Math.cos(r),a=e[4],c=e[5],h=e[6],m=e[7],o=e[8],l=e[9],d=e[10],p=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=a*n+o*s,t[5]=c*n+l*s,t[6]=h*n+d*s,t[7]=m*n+p*s,t[8]=o*n-a*s,t[9]=l*n-c*s,t[10]=d*n-h*s,t[11]=p*n-m*s,t}function de(t,e,r){var s=Math.sin(r),n=Math.cos(r),a=e[0],c=e[1],h=e[2],m=e[3],o=e[8],l=e[9],d=e[10],p=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=a*n-o*s,t[1]=c*n-l*s,t[2]=h*n-d*s,t[3]=m*n-p*s,t[8]=a*s+o*n,t[9]=c*s+l*n,t[10]=h*s+d*n,t[11]=m*s+p*n,t}function q(t,e,r,s){var n=e[0],a=e[1],c=e[2],h=e[3],m=n+n,o=a+a,l=c+c,d=n*m,p=n*o,v=n*l,f=a*o,x=a*l,g=c*l,w=h*m,C=h*o,y=h*l,P=s[0],b=s[1],D=s[2];return t[0]=(1-(f+g))*P,t[1]=(p+y)*P,t[2]=(v-C)*P,t[3]=0,t[4]=(p-y)*b,t[5]=(1-(d+g))*b,t[6]=(x+w)*b,t[7]=0,t[8]=(v+C)*D,t[9]=(x-w)*D,t[10]=(1-(d+f))*D,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function B(){var t=new A(3);return A!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function pe(t){var e=new A(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function ee(t){var e=t[0],r=t[1],s=t[2];return Math.sqrt(e*e+r*r+s*s)}function I(t,e,r){var s=new A(3);return s[0]=t,s[1]=e,s[2]=r,s}function fe(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function ve(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function k(t,e){var r=e[0],s=e[1],n=e[2],a=r*r+s*s+n*n;return a>0&&(a=1/Math.sqrt(a)),t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a,t}function N(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function xe(t,e,r){var s=e[0],n=e[1],a=e[2],c=r[3]*s+r[7]*n+r[11]*a+r[15];return c=c||1,t[0]=(r[0]*s+r[4]*n+r[8]*a+r[12])/c,t[1]=(r[1]*s+r[5]*n+r[9]*a+r[13])/c,t[2]=(r[2]*s+r[6]*n+r[10]*a+r[14])/c,t}(function(){var t=B();return function(e,r,s,n,a,c){var h,m;for(r||(r=3),s||(s=0),n?m=Math.min(n*r+s,e.length):m=e.length,h=s;h<m;h+=r)t[0]=e[h],t[1]=e[h+1],t[2]=e[h+2],a(t,t,c),e[h]=t[0],e[h+1]=t[1],e[h+2]=t[2];return e}})();class ye{orbitCentre;cameraDistance;cameraTransform;pitch;yaw;constructor(){this.orbitCentre=M(),this.cameraDistance=3,this.pitch=0,this.yaw=0,this.cameraTransform=M(),this.updateCameraTransform()}rotateCamera(e,r){this.pitch=Math.min(Math.max(this.pitch+e,-Math.PI/2),Math.PI/2),this.yaw+=r,this.updateCameraTransform()}getAngles(){return[this.pitch,this.yaw]}getRotationMatrix(e){return e[0]=this.cameraTransform[0],e[1]=this.cameraTransform[1],e[2]=this.cameraTransform[2],e[3]=0,e[4]=this.cameraTransform[4],e[5]=this.cameraTransform[5],e[6]=this.cameraTransform[6],e[7]=0,e[8]=this.cameraTransform[8],e[9]=this.cameraTransform[9],e[10]=this.cameraTransform[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getCameraPosition(e){return e[0]=this.cameraTransform[12],e[1]=this.cameraTransform[13],e[2]=this.cameraTransform[14],e}getCameraMatrix(e){return le(e,this.cameraTransform),e}setAngles(e,r){this.pitch=Math.min(Math.max(e,-Math.PI/2),Math.PI/2),this.yaw=r,this.updateCameraTransform()}getPosition(e){return e[0]=this.cameraTransform[12],e[1]=this.cameraTransform[13],e[2]=this.cameraTransform[14],e}transformDirection(e,r){const s=this.cameraTransform,n=r[0],a=r[1],c=r[2];return e[0]=s[0]*n+s[4]*a+s[8]*c,e[1]=s[1]*n+s[5]*a+s[9]*c,e[2]=s[2]*n+s[6]*a+s[10]*c,e}updateCameraTransform(){const e=M();de(e,M(),this.yaw),me(this.orbitCentre,e,this.pitch),he(this.cameraTransform,this.orbitCentre,I(0,0,Math.abs(this.cameraDistance)))}}class K{transform;constructor(e){this.transform=e}sdf(e){const r=B();return xe(r,e,this.transform),this.localSdf(r)}}class ge extends K{radius;constructor(e,r){super(e),this.radius=r}localSdf(e){return ee(e)-this.radius}}class we extends K{halfSize;constructor(e,r){super(e),this.halfSize=pe(r)}localSdf(e){const r=I(Math.abs(e[0])-this.halfSize[0],Math.abs(e[1])-this.halfSize[1],Math.abs(e[2])-this.halfSize[2]),s=I(Math.max(r[0],0),Math.max(r[1],0),Math.max(r[2],0)),n=ee(s),a=Math.min(Math.max(r[0],Math.max(r[1],r[2])),0);return n+a}}class Se extends K{majorRadius;minorRadius;constructor(e,r,s){super(e),this.majorRadius=r,this.minorRadius=s}localSdf(e){const r=e[0],s=e[1],n=e[2],a=Math.sqrt(r*r+n*n)-this.majorRadius,c=s;return Math.sqrt(a*a+c*c)-this.minorRadius}}class i{static createSphere(e,r,s,n){const a=M();return q(a,[0,0,0,1],[e,r,s],[1,1,1]),new ge(a,n)}static createBox(e,r,s,n){const a=M();return q(a,[0,0,0,1],[e,r,s],[1,1,1]),new we(a,n)}static createTorus(e,r,s,n){const a=M();return q(a,[0,0,0,1],[e,r,s],[1,1,1]),new Se(a,n,n/4)}static presets=[{name:"Sphere",objects:[i.createSphere(0,0,0,1.5)]},{name:"Grid of Spheres",objects:[i.createSphere(-1,-1,0,.3),i.createSphere(0,-1,0,.3),i.createSphere(1,-1,0,.3),i.createSphere(-1,0,0,.3),i.createSphere(0,0,0,.3),i.createSphere(1,0,0,.3),i.createSphere(-1,1,0,.3),i.createSphere(0,1,0,.3),i.createSphere(1,1,0,.3)]},{name:"Atom",objects:[i.createSphere(0,0,0,.5),i.createSphere(1.2,0,0,.3),i.createSphere(-1.2,0,0,.3),i.createSphere(0,1.2,0,.3),i.createSphere(0,-1.2,0,.3),i.createSphere(0,0,1.2,.3),i.createSphere(0,0,-1.2,.3)]},{name:"Random Spheres",objects:[i.createSphere(.8,-.3,.2,.4),i.createSphere(-.5,.9,-.1,.5),i.createSphere(.2,.1,.8,.3),i.createSphere(-.9,-.4,-.6,.6),i.createSphere(.4,-.8,.5,.35),i.createSphere(-.2,.6,-.9,.4),i.createSphere(.7,.3,-.4,.25)]},{name:"Cube",objects:[i.createBox(0,0,0,I(1,1,1))]},{name:"Sphere and Cube",objects:[i.createSphere(-.7,0,0,.5),i.createBox(1,0,0,I(.5,.5,.5))]},{name:"Pyramid of Boxes",objects:[i.createBox(0,-.5,0,I(.9,.25,.9)),i.createBox(0,0,0,I(.6,.25,.6)),i.createBox(0,.5,0,I(.3,.25,.3))]},{name:"Torus",objects:[i.createTorus(0,0,0,1.3)]}];static getPreset(e){return this.presets[Math.max(0,Math.min(e,this.presets.length-1))]}static getPresetCount(){return this.presets.length}static populateSceneDropdown(e,r=0){e.innerHTML="";for(let s=0;s<this.presets.length;s++){const n=this.getPreset(s),a=document.createElement("option");a.value=s.toString(),a.textContent=n.name,a.selected=s===r,e.appendChild(a)}}}class ue{objectSDFs;camera;currentPresetIndex=0;constructor(){this.camera=new ye,this.objectSDFs=new Array,this.loadPreset(0)}loadPreset(e){this.currentPresetIndex=Math.max(0,Math.min(e,i.getPresetCount()-1));const r=i.getPreset(this.currentPresetIndex);this.objectSDFs=[...r.objects]}nextPreset(){this.loadPreset(Math.min(this.currentPresetIndex+1,i.getPresetCount()))}previousPreset(){this.loadPreset(Math.max(this.currentPresetIndex-1,0))}getCurrentPresetInfo(){const e=i.getPreset(this.currentPresetIndex);return{index:this.currentPresetIndex,name:e.name,total:i.getPresetCount()}}}class O{}class Ie extends O{shade(e,r,s,n,a,c,h){const m=I(1,-1,1.5);k(m,m);const o=B(),l=B(),d=I(0,0,1),p=.1,v=.5,f=32;for(let x=0;x<h;x++)for(let g=0;g<c;g++){const w=x*c+g,C=w*3,y=w*4,P=r[w];if(P>=255){e[y+0]=10,e[y+1]=10,e[y+2]=20,e[y+3]=255;continue}o[0]=s[C]/127.5-1,o[1]=s[C+1]/127.5-1,o[2]=s[C+2]/127.5-1,k(o,o);const b=Math.max(N(o,m),0);ve(l,o,2*N(o,m)),fe(l,l,m),k(l,l);const D=v*Math.pow(Math.max(N(d,l),0),f),X=Math.min(p+b+D,1),U=1-P/255,E=255*X*U;e[y+0]=E,e[y+1]=E,e[y+2]=E,e[y+3]=255}return e}}class Y extends O{shade(e,r,s,n,a,c,h){for(let m=0;m<h;m++)for(let o=0;o<c;o++){const l=m*c+o,d=l*3,p=l*4;e[p]=s[d],e[p+1]=s[d+1],e[p+2]=s[d+2],e[p+3]=255}return e}}class Ce extends O{shade(e,r,s,n,a,c,h){const o=I(1,-1,1.5);k(o,o);for(let l=0;l<h;l++)for(let d=0;d<c;d++){const p=l*c+d,v=p*4,f=n[p]*5%256;e[v+0]=Math.min(2*f,255),e[v+1]=Math.min(-2*f+512,255),e[v+2]=0,e[v+3]=255}return e}}class Pe extends O{shade(e,r,s,n,a,c,h){const o=I(1,-1,1.5);k(o,o);for(let l=0;l<h;l++)for(let d=0;d<c;d++){const p=l*c+d,v=p*4,f=a[p]*5%256;e[v+0]=Math.min(2*f,255),e[v+1]=Math.min(-2*f+512,255),e[v+2]=0,e[v+3]=255}return e}}const z=document.getElementById("shader-canvas"),De=z.getContext("2d"),u=z.width,S=z.height,be=document.getElementById("fps"),Me=document.getElementById("average-sdf-calls"),Fe=document.getElementById("max-sdf-calls"),Te=document.getElementById("min-sdf-calls"),Ae=document.getElementById("average-iterations");let F=new Y;document.getElementById("shading-models").addEventListener("change",t=>{switch(t.target.value){case"phong":F=new Ie;break;case"normal":F=new Y;break;case"sdf-heatmap":F=new Ce;break;case"iteration-heatmap":F=new Pe;break;default:F=new Y}});let R="sphere-tracer";document.getElementById("algorithm").addEventListener("change",t=>{switch(t.target.value){case"sphere-tracer":R="sphere-tracer";break;case"fixed-step":R="fixed-step";break;default:R="sphere-tracer"}});let J=performance.now();const j=new ue,te=document.getElementById("scene-select");te.addEventListener("change",t=>{const e=parseInt(t.target.value);j.loadPreset(e)});const Ee=j.getCurrentPresetInfo();i.populateSceneDropdown(te,Ee.index);const re=Math.max(1,Math.min(4,(navigator.hardwareConcurrency||4)-1)),ke=Array.from({length:re},()=>new Worker(new URL("/raymarcher-test/assets/raymarchWorker-BaUhmDtg.js",import.meta.url),{type:"module"})),Q=new Uint8ClampedArray(u*S),Z=new Uint8ClampedArray(u*S*3),W=new Uint16Array(u*S),H=new Uint16Array(u*S),_=new Uint8ClampedArray(u*S*4);let T=1;function G(){z.style.width=`${u*T}px`,z.style.height=`${S*T}px`}G();async function se(t){const e=Math.ceil(S/re),[r,s]=j.camera.getAngles(),n=ke.map((f,x)=>{const g=Math.min(x*e,S),w=Math.min((x+1)*e,S);return g>=w?Promise.resolve(null):new Promise(C=>{const y=b=>{f.removeEventListener("message",y);const{yStart:D,yEnd:X,depth:U,normal:E,sdfEval:ne,iters:ae}=b.data,$=D*u;Q.set(U,$),W.set(ne,$),H.set(ae,$);const ce=D*u*3;Z.set(E,ce),C(null)};f.addEventListener("message",y);const P=j.getCurrentPresetInfo();f.postMessage({width:u,height:S,time:t,yStart:g,yEnd:w,camera:{pitch:r,yaw:s},algorithm:R,scenePresetIndex:P.index})})});await Promise.all(n),F.shade(_,Q,Z,W,H,u,S);const a=new ImageData(_,u,S);De.putImageData(a,0,0);const c=performance.now();be.textContent=`Frame length: ${(c-J).toPrecision(4)}`,J=c;const h=u*S;let m=0,o=0,l=Number.MAX_SAFE_INTEGER,d=0;for(let f=0;f<h;f++){const x=W[f];m+=x,d+=H[f],x>o&&(o=x),x<l&&(l=x)}const p=m/h,v=d/h;Me.textContent=`Average SDF calls: ${p.toFixed(2)}`,Fe.textContent=`Max SDF calls: ${o}`,Te.textContent=`Min SDF calls: ${l}`,Ae.textContent=`Average iterations: ${v.toFixed(2)}`,requestAnimationFrame(se)}window.addEventListener("keydown",t=>{switch(t.key){case"ArrowUp":L(0,.1);break;case"ArrowDown":L(0,-.1);break;case"ArrowLeft":L(.1,0);break;case"ArrowRight":L(-.1,0);break;case"-":case"_":T=Math.max(.25,T-.25),G();break;case"+":case"=":T=Math.min(8,T+.25),G();break}});function L(t,e){j.camera.rotateCamera(-e,t)}requestAnimationFrame(se);
