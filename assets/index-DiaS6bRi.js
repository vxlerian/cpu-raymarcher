(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function r(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=r(n);fetch(n.href,a)}})();var F=typeof Float32Array<"u"?Float32Array:Array;function T(){var t=new F(16);return F!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function re(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function se(t,e,r){var s=r[0],n=r[1],a=r[2],c,o,l,h,m,p,d,f,x,v,P,w;return e===t?(t[12]=e[0]*s+e[4]*n+e[8]*a+e[12],t[13]=e[1]*s+e[5]*n+e[9]*a+e[13],t[14]=e[2]*s+e[6]*n+e[10]*a+e[14],t[15]=e[3]*s+e[7]*n+e[11]*a+e[15]):(c=e[0],o=e[1],l=e[2],h=e[3],m=e[4],p=e[5],d=e[6],f=e[7],x=e[8],v=e[9],P=e[10],w=e[11],t[0]=c,t[1]=o,t[2]=l,t[3]=h,t[4]=m,t[5]=p,t[6]=d,t[7]=f,t[8]=x,t[9]=v,t[10]=P,t[11]=w,t[12]=c*s+m*n+x*a+e[12],t[13]=o*s+p*n+v*a+e[13],t[14]=l*s+d*n+P*a+e[14],t[15]=h*s+f*n+w*a+e[15]),t}function ne(t,e,r){var s=Math.sin(r),n=Math.cos(r),a=e[4],c=e[5],o=e[6],l=e[7],h=e[8],m=e[9],p=e[10],d=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=a*n+h*s,t[5]=c*n+m*s,t[6]=o*n+p*s,t[7]=l*n+d*s,t[8]=h*n-a*s,t[9]=m*n-c*s,t[10]=p*n-o*s,t[11]=d*n-l*s,t}function ae(t,e,r){var s=Math.sin(r),n=Math.cos(r),a=e[0],c=e[1],o=e[2],l=e[3],h=e[8],m=e[9],p=e[10],d=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=a*n-h*s,t[1]=c*n-m*s,t[2]=o*n-p*s,t[3]=l*n-d*s,t[8]=a*s+h*n,t[9]=c*s+m*n,t[10]=o*s+p*n,t[11]=l*s+d*n,t}function q(t,e,r,s){var n=e[0],a=e[1],c=e[2],o=e[3],l=n+n,h=a+a,m=c+c,p=n*l,d=n*h,f=n*m,x=a*h,v=a*m,P=c*m,w=o*l,b=o*h,y=o*m,C=s[0],S=s[1],M=s[2];return t[0]=(1-(x+P))*C,t[1]=(d+y)*C,t[2]=(f-b)*C,t[3]=0,t[4]=(d-y)*S,t[5]=(1-(p+P))*S,t[6]=(v+w)*S,t[7]=0,t[8]=(f+b)*M,t[9]=(v-w)*M,t[10]=(1-(p+x))*M,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function k(){var t=new F(3);return F!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function ce(t){var e=new F(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function X(t){var e=t[0],r=t[1],s=t[2];return Math.sqrt(e*e+r*r+s*s)}function u(t,e,r){var s=new F(3);return s[0]=t,s[1]=e,s[2]=r,s}function ie(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function oe(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function z(t,e){var r=e[0],s=e[1],n=e[2],a=r*r+s*s+n*n;return a>0&&(a=1/Math.sqrt(a)),t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a,t}function B(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function he(t,e,r){var s=e[0],n=e[1],a=e[2],c=r[3]*s+r[7]*n+r[11]*a+r[15];return c=c||1,t[0]=(r[0]*s+r[4]*n+r[8]*a+r[12])/c,t[1]=(r[1]*s+r[5]*n+r[9]*a+r[13])/c,t[2]=(r[2]*s+r[6]*n+r[10]*a+r[14])/c,t}(function(){var t=k();return function(e,r,s,n,a,c){var o,l;for(r||(r=3),s||(s=0),n?l=Math.min(n*r+s,e.length):l=e.length,o=s;o<l;o+=r)t[0]=e[o],t[1]=e[o+1],t[2]=e[o+2],a(t,t,c),e[o]=t[0],e[o+1]=t[1],e[o+2]=t[2];return e}})();class me{orbitCentre;cameraDistance;cameraTransform;pitch;yaw;constructor(){this.orbitCentre=T(),this.cameraDistance=3,this.pitch=0,this.yaw=0,this.cameraTransform=T(),this.updateCameraTransform()}rotateCamera(e,r){this.pitch=Math.min(Math.max(this.pitch+e,-Math.PI/2),Math.PI/2),this.yaw+=r,this.updateCameraTransform()}getAngles(){return[this.pitch,this.yaw]}getRotationMatrix(e){return e[0]=this.cameraTransform[0],e[1]=this.cameraTransform[1],e[2]=this.cameraTransform[2],e[3]=0,e[4]=this.cameraTransform[4],e[5]=this.cameraTransform[5],e[6]=this.cameraTransform[6],e[7]=0,e[8]=this.cameraTransform[8],e[9]=this.cameraTransform[9],e[10]=this.cameraTransform[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getCameraPosition(e){return e[0]=this.cameraTransform[12],e[1]=this.cameraTransform[13],e[2]=this.cameraTransform[14],e}getCameraMatrix(e){return re(e,this.cameraTransform),e}setAngles(e,r){this.pitch=Math.min(Math.max(e,-Math.PI/2),Math.PI/2),this.yaw=r,this.updateCameraTransform()}getPosition(e){return e[0]=this.cameraTransform[12],e[1]=this.cameraTransform[13],e[2]=this.cameraTransform[14],e}transformDirection(e,r){const s=this.cameraTransform,n=r[0],a=r[1],c=r[2];return e[0]=s[0]*n+s[4]*a+s[8]*c,e[1]=s[1]*n+s[5]*a+s[9]*c,e[2]=s[2]*n+s[6]*a+s[10]*c,e}updateCameraTransform(){const e=T();ae(e,T(),this.yaw),ne(this.orbitCentre,e,this.pitch),se(this.cameraTransform,this.orbitCentre,u(0,0,Math.abs(this.cameraDistance)))}}class H{transform;constructor(e){this.transform=e}sdf(e){const r=k();return he(r,e,this.transform),this.localSdf(r)}}class le extends H{radius;constructor(e,r){super(e),this.radius=r}localSdf(e){return X(e)-this.radius}}class pe extends H{halfSize;constructor(e,r){super(e),this.halfSize=ce(r)}localSdf(e){const r=u(Math.abs(e[0])-this.halfSize[0],Math.abs(e[1])-this.halfSize[1],Math.abs(e[2])-this.halfSize[2]),s=u(Math.max(r[0],0),Math.max(r[1],0),Math.max(r[2],0)),n=X(s),a=Math.min(Math.max(r[0],Math.max(r[1],r[2])),0);return n+a}}class de extends H{majorRadius;minorRadius;constructor(e,r,s){super(e),this.majorRadius=r,this.minorRadius=s}localSdf(e){const r=e[0],s=e[1],n=e[2],a=Math.sqrt(r*r+n*n)-this.majorRadius,c=s;return Math.sqrt(a*a+c*c)-this.minorRadius}}class i{static createSphere(e,r,s,n){const a=T();return q(a,[0,0,0,1],[e,r,s],[1,1,1]),new le(a,n)}static createBox(e,r,s,n){const a=T();return q(a,[0,0,0,1],[e,r,s],[1,1,1]),new pe(a,n)}static createTorus(e,r,s,n){const a=T();return q(a,[0,0,0,1],[e,r,s],[1,1,1]),new de(a,n,n/4)}static presets=[{name:"Single sphere",objects:[i.createSphere(0,0,0,1.5)]},{name:"Grid of spheres",objects:[i.createSphere(-1,-1,0,.3),i.createSphere(0,-1,0,.3),i.createSphere(1,-1,0,.3),i.createSphere(-1,0,0,.3),i.createSphere(0,0,0,.3),i.createSphere(1,0,0,.3),i.createSphere(-1,1,0,.3),i.createSphere(0,1,0,.3),i.createSphere(1,1,0,.3)]},{name:"Atom",objects:[i.createSphere(0,0,0,.5),i.createSphere(1.2,0,0,.3),i.createSphere(-1.2,0,0,.3),i.createSphere(0,1.2,0,.3),i.createSphere(0,-1.2,0,.3),i.createSphere(0,0,1.2,.3),i.createSphere(0,0,-1.2,.3)]},{name:"Random spheres",objects:[i.createSphere(.8,-.3,.2,.4),i.createSphere(-.5,.9,-.1,.5),i.createSphere(.2,.1,.8,.3),i.createSphere(-.9,-.4,-.6,.6),i.createSphere(.4,-.8,.5,.35),i.createSphere(-.2,.6,-.9,.4),i.createSphere(.7,.3,-.4,.25)]},{name:"Cube",objects:[i.createBox(0,0,0,u(1,1,1))]},{name:"Sphere and Cube",objects:[i.createSphere(-.7,0,0,.5),i.createBox(1,0,0,u(.5,.5,.5))]},{name:"Pyramid of Boxes",objects:[i.createBox(0,-.5,0,u(.9,.25,.9)),i.createBox(0,0,0,u(.6,.25,.6)),i.createBox(0,.5,0,u(.3,.25,.3))]},{name:"Torus",objects:[i.createTorus(0,0,0,1.3)]}];static getPreset(e){return this.presets[Math.max(0,Math.min(e,this.presets.length-1))]}static getPresetCount(){return this.presets.length}static populateSceneDropdown(e,r=0){e.innerHTML="";for(let s=0;s<this.presets.length;s++){const n=this.getPreset(s),a=document.createElement("option");a.value=s.toString(),a.textContent=n.name,a.selected=s===r,e.appendChild(a)}}}class fe{objectSDFs;camera;currentPresetIndex=0;constructor(){this.camera=new me,this.objectSDFs=new Array,this.loadPreset(0)}loadPreset(e){this.currentPresetIndex=Math.max(0,Math.min(e,i.getPresetCount()-1));const r=i.getPreset(this.currentPresetIndex);this.objectSDFs=[...r.objects]}nextPreset(){this.loadPreset(Math.min(this.currentPresetIndex+1,i.getPresetCount()))}previousPreset(){this.loadPreset(Math.max(this.currentPresetIndex-1,0))}getCurrentPresetInfo(){const e=i.getPreset(this.currentPresetIndex);return{index:this.currentPresetIndex,name:e.name,total:i.getPresetCount()}}}class O{}class xe extends O{shade(e,r,s,n,a,c,o){const l=u(1,-1,1.5);z(l,l);const h=k(),m=k(),p=u(0,0,1),d=.1,f=.5,x=32;for(let v=0;v<o;v++)for(let P=0;P<c;P++){const w=v*c+P,b=w*3,y=w*4,C=r[w];if(C>=255){e[y+0]=10,e[y+1]=10,e[y+2]=20,e[y+3]=255;continue}h[0]=s[b]/127.5-1,h[1]=s[b+1]/127.5-1,h[2]=s[b+2]/127.5-1,z(h,h);const S=Math.max(B(h,l),0);oe(m,h,2*B(h,l)),ie(m,m,l),z(m,m);const M=f*Math.pow(Math.max(B(p,m),0),x),ee=Math.min(d+S+M,1),te=1-C/255,U=255*ee*te;e[y+0]=U,e[y+1]=U,e[y+2]=U,e[y+3]=255}return e}}class N extends O{shade(e,r,s,n,a,c,o){for(let l=0;l<o;l++)for(let h=0;h<c;h++){const m=l*c+h,p=m*3,d=m*4;e[d]=s[p],e[d+1]=s[p+1],e[d+2]=s[p+2],e[d+3]=255}return e}}class ve extends O{shade(e,r,s,n,a,c,o){const h=u(1,-1,1.5);z(h,h);for(let m=0;m<o;m++)for(let p=0;p<c;p++){const d=m*c+p,f=d*4,x=n[d]*5%256;e[f+0]=Math.min(2*x,255),e[f+1]=Math.min(-2*x+512,255),e[f+2]=0,e[f+3]=255}return e}}class ye extends O{shade(e,r,s,n,a,c,o){const h=u(1,-1,1.5);z(h,h);for(let m=0;m<o;m++)for(let p=0;p<c;p++){const d=m*c+p,f=d*4,x=a[d]*5%256;e[f+0]=Math.min(2*x,255),e[f+1]=Math.min(-2*x+512,255),e[f+2]=0,e[f+3]=255}return e}}const E=document.getElementById("shader-canvas"),we=E.getContext("2d"),I=E.width,g=E.height,ge=document.getElementById("fps"),ue=document.getElementById("status");let D=new N;document.getElementById("shading-models").addEventListener("change",t=>{switch(t.target.value){case"phong":D=new xe;break;case"normal":D=new N;break;case"sdf-heatmap":D=new ve;break;case"iteration-heatmap":D=new ye;break;default:D=new N}});let L="sphere-tracer";document.getElementById("algorithm").addEventListener("change",t=>{switch(t.target.value){case"sphere-tracer":L="sphere-tracer";break;case"fixed-step":L="fixed-step";break;default:L="sphere-tracer"}});let W=performance.now();const j=new fe,Q=document.getElementById("scene-select");Q.addEventListener("change",t=>{const e=parseInt(t.target.value);j.loadPreset(e)});const Pe=j.getCurrentPresetInfo();i.populateSceneDropdown(Q,Pe.index);const Z=Math.max(1,Math.min(4,(navigator.hardwareConcurrency||4)-1)),Ie=Array.from({length:Z},()=>new Worker(new URL("/raymarcher-test/assets/raymarchWorker-CUHwUudJ.js",import.meta.url),{type:"module"})),Y=new Uint8ClampedArray(I*g),K=new Uint8ClampedArray(I*g*3),G=new Uint16Array(I*g),J=new Uint16Array(I*g),V=new Uint8ClampedArray(I*g*4);let A=1;function $(){E.style.width=`${I*A}px`,E.style.height=`${g*A}px`,ue.textContent=`Status: scale ${A.toFixed(2)}x`}$();async function _(t){const e=Math.ceil(g/Z),[r,s]=j.camera.getAngles(),n=Ie.map((o,l)=>{const h=Math.min(l*e,g),m=Math.min((l+1)*e,g);return h>=m?Promise.resolve(null):new Promise(p=>{const d=x=>{o.removeEventListener("message",d);const{yStart:v,yEnd:P,depth:w,normal:b,sdfEval:y,iters:C}=x.data,S=v*I;Y.set(w,S),G.set(y,S),J.set(C,S);const M=v*I*3;K.set(b,M),p(null)};o.addEventListener("message",d);const f=j.getCurrentPresetInfo();o.postMessage({width:I,height:g,time:t,yStart:h,yEnd:m,camera:{pitch:r,yaw:s},algorithm:L,scenePresetIndex:f.index})})});await Promise.all(n),D.shade(V,Y,K,G,J,I,g);const a=new ImageData(V,I,g);we.putImageData(a,0,0);const c=performance.now();ge.textContent=`Frame length: ${(c-W).toPrecision(4)}`,W=c,requestAnimationFrame(_)}window.addEventListener("keydown",t=>{switch(t.key){case"ArrowUp":R(0,.1);break;case"ArrowDown":R(0,-.1);break;case"ArrowLeft":R(.1,0);break;case"ArrowRight":R(-.1,0);break;case"-":case"_":A=Math.max(.25,A-.25),$();break;case"+":case"=":A=Math.min(8,A+.25),$();break}});function R(t,e){j.camera.rotateCamera(-e,t)}requestAnimationFrame(_);
