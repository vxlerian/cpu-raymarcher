(function(){"use strict";var g=typeof Float32Array<"u"?Float32Array:Array;function O(){var e=new g(9);return g!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function Y(e,r){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[4],e[4]=r[5],e[5]=r[6],e[6]=r[8],e[7]=r[9],e[8]=r[10],e}function D(){var e=new g(16);return g!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function F(e,r){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],e}function H(e,r,t){var s=t[0],a=t[1],n=t[2],c,i,o,m,l,f,p,v,d,b,S,P;return r===e?(e[12]=r[0]*s+r[4]*a+r[8]*n+r[12],e[13]=r[1]*s+r[5]*a+r[9]*n+r[13],e[14]=r[2]*s+r[6]*a+r[10]*n+r[14],e[15]=r[3]*s+r[7]*a+r[11]*n+r[15]):(c=r[0],i=r[1],o=r[2],m=r[3],l=r[4],f=r[5],p=r[6],v=r[7],d=r[8],b=r[9],S=r[10],P=r[11],e[0]=c,e[1]=i,e[2]=o,e[3]=m,e[4]=l,e[5]=f,e[6]=p,e[7]=v,e[8]=d,e[9]=b,e[10]=S,e[11]=P,e[12]=c*s+l*a+d*n+r[12],e[13]=i*s+f*a+b*n+r[13],e[14]=o*s+p*a+S*n+r[14],e[15]=m*s+v*a+P*n+r[15]),e}function G(e,r,t){var s=Math.sin(t),a=Math.cos(t),n=r[4],c=r[5],i=r[6],o=r[7],m=r[8],l=r[9],f=r[10],p=r[11];return r!==e&&(e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15]),e[4]=n*a+m*s,e[5]=c*a+l*s,e[6]=i*a+f*s,e[7]=o*a+p*s,e[8]=m*a-n*s,e[9]=l*a-c*s,e[10]=f*a-i*s,e[11]=p*a-o*s,e}function V(e,r,t){var s=Math.sin(t),a=Math.cos(t),n=r[0],c=r[1],i=r[2],o=r[3],m=r[8],l=r[9],f=r[10],p=r[11];return r!==e&&(e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15]),e[0]=n*a-m*s,e[1]=c*a-l*s,e[2]=i*a-f*s,e[3]=o*a-p*s,e[8]=n*s+m*a,e[9]=c*s+l*a,e[10]=i*s+f*a,e[11]=o*s+p*a,e}function k(e,r,t,s){var a=r[0],n=r[1],c=r[2],i=r[3],o=a+a,m=n+n,l=c+c,f=a*o,p=a*m,v=a*l,d=n*m,b=n*l,S=c*l,P=i*o,T=i*m,A=i*l,z=s[0],y=s[1],w=s[2];return e[0]=(1-(d+S))*z,e[1]=(p+A)*z,e[2]=(v-T)*z,e[3]=0,e[4]=(p-A)*y,e[5]=(1-(f+S))*y,e[6]=(b+P)*y,e[7]=0,e[8]=(v+T)*w,e[9]=(b-P)*w,e[10]=(1-(f+d))*w,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function C(){var e=new g(3);return g!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function Z(e){var r=new g(3);return r[0]=e[0],r[1]=e[1],r[2]=e[2],r}function $(e){var r=e[0],t=e[1],s=e[2];return Math.sqrt(r*r+t*t+s*s)}function x(e,r,t){var s=new g(3);return s[0]=e,s[1]=r,s[2]=t,s}function j(e,r,t,s){return e[0]=r[0]+t[0]*s,e[1]=r[1]+t[1]*s,e[2]=r[2]+t[2]*s,e}function R(e,r){var t=r[0],s=r[1],a=r[2],n=t*t+s*s+a*a;return n>0&&(n=1/Math.sqrt(n)),e[0]=r[0]*n,e[1]=r[1]*n,e[2]=r[2]*n,e}function J(e,r,t){var s=r[0],a=r[1],n=r[2],c=t[3]*s+t[7]*a+t[11]*n+t[15];return c=c||1,e[0]=(t[0]*s+t[4]*a+t[8]*n+t[12])/c,e[1]=(t[1]*s+t[5]*a+t[9]*n+t[13])/c,e[2]=(t[2]*s+t[6]*a+t[10]*n+t[14])/c,e}function q(e,r,t){var s=r[0],a=r[1],n=r[2];return e[0]=s*t[0]+a*t[3]+n*t[6],e[1]=s*t[1]+a*t[4]+n*t[7],e[2]=s*t[2]+a*t[5]+n*t[8],e}(function(){var e=C();return function(r,t,s,a,n,c){var i,o;for(t||(t=3),s||(s=0),a?o=Math.min(a*t+s,r.length):o=r.length,i=s;i<o;i+=t)e[0]=r[i],e[1]=r[i+1],e[2]=r[i+2],n(e,e,c),r[i]=e[0],r[i+1]=e[1],r[i+2]=e[2];return r}})();class K{orbitCentre;cameraDistance;cameraTransform;pitch;yaw;constructor(){this.orbitCentre=D(),this.cameraDistance=3,this.pitch=0,this.yaw=0,this.cameraTransform=D(),this.updateCameraTransform()}rotateCamera(r,t){this.pitch=Math.min(Math.max(this.pitch+r,-Math.PI/2),Math.PI/2),this.yaw+=t,this.updateCameraTransform()}getAngles(){return[this.pitch,this.yaw]}getRotationMatrix(r){return r[0]=this.cameraTransform[0],r[1]=this.cameraTransform[1],r[2]=this.cameraTransform[2],r[3]=0,r[4]=this.cameraTransform[4],r[5]=this.cameraTransform[5],r[6]=this.cameraTransform[6],r[7]=0,r[8]=this.cameraTransform[8],r[9]=this.cameraTransform[9],r[10]=this.cameraTransform[10],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}getCameraPosition(r){return r[0]=this.cameraTransform[12],r[1]=this.cameraTransform[13],r[2]=this.cameraTransform[14],r}getCameraMatrix(r){return F(r,this.cameraTransform),r}setAngles(r,t){this.pitch=Math.min(Math.max(r,-Math.PI/2),Math.PI/2),this.yaw=t,this.updateCameraTransform()}getPosition(r){return r[0]=this.cameraTransform[12],r[1]=this.cameraTransform[13],r[2]=this.cameraTransform[14],r}transformDirection(r,t){const s=this.cameraTransform,a=t[0],n=t[1],c=t[2];return r[0]=s[0]*a+s[4]*n+s[8]*c,r[1]=s[1]*a+s[5]*n+s[9]*c,r[2]=s[2]*a+s[6]*n+s[10]*c,r}updateCameraTransform(){const r=D();V(r,D(),this.yaw),G(this.orbitCentre,r,this.pitch),H(this.cameraTransform,this.orbitCentre,x(0,0,Math.abs(this.cameraDistance)))}}class N{transform;constructor(r){this.transform=r}sdf(r){const t=C();return J(t,r,this.transform),this.localSdf(t)}}class Q extends N{radius;constructor(r,t){super(r),this.radius=t}localSdf(r){return $(r)-this.radius}}class W extends N{halfSize;constructor(r,t){super(r),this.halfSize=Z(t)}localSdf(r){const t=x(Math.abs(r[0])-this.halfSize[0],Math.abs(r[1])-this.halfSize[1],Math.abs(r[2])-this.halfSize[2]),s=x(Math.max(t[0],0),Math.max(t[1],0),Math.max(t[2],0)),a=$(s),n=Math.min(Math.max(t[0],Math.max(t[1],t[2])),0);return a+n}}class B extends N{majorRadius;minorRadius;constructor(r,t,s){super(r),this.majorRadius=t,this.minorRadius=s}localSdf(r){const t=r[0],s=r[1],a=r[2],n=Math.sqrt(t*t+a*a)-this.majorRadius,c=s;return Math.sqrt(n*n+c*c)-this.minorRadius}}class h{static createSphere(r,t,s,a){const n=D();return k(n,[0,0,0,1],[r,t,s],[1,1,1]),new Q(n,a)}static createBox(r,t,s,a){const n=D();return k(n,[0,0,0,1],[r,t,s],[1,1,1]),new W(n,a)}static createTorus(r,t,s,a){const n=D();return k(n,[0,0,0,1],[r,t,s],[1,1,1]),new B(n,a,a/4)}static presets=[{name:"Single sphere",objects:[h.createSphere(0,0,0,1.5)]},{name:"Grid of spheres",objects:[h.createSphere(-1,-1,0,.3),h.createSphere(0,-1,0,.3),h.createSphere(1,-1,0,.3),h.createSphere(-1,0,0,.3),h.createSphere(0,0,0,.3),h.createSphere(1,0,0,.3),h.createSphere(-1,1,0,.3),h.createSphere(0,1,0,.3),h.createSphere(1,1,0,.3)]},{name:"Atom",objects:[h.createSphere(0,0,0,.5),h.createSphere(1.2,0,0,.3),h.createSphere(-1.2,0,0,.3),h.createSphere(0,1.2,0,.3),h.createSphere(0,-1.2,0,.3),h.createSphere(0,0,1.2,.3),h.createSphere(0,0,-1.2,.3)]},{name:"Random spheres",objects:[h.createSphere(.8,-.3,.2,.4),h.createSphere(-.5,.9,-.1,.5),h.createSphere(.2,.1,.8,.3),h.createSphere(-.9,-.4,-.6,.6),h.createSphere(.4,-.8,.5,.35),h.createSphere(-.2,.6,-.9,.4),h.createSphere(.7,.3,-.4,.25)]},{name:"Cube",objects:[h.createBox(0,0,0,x(1,1,1))]},{name:"Sphere and Cube",objects:[h.createSphere(-.7,0,0,.5),h.createBox(1,0,0,x(.5,.5,.5))]},{name:"Pyramid of Boxes",objects:[h.createBox(0,-.5,0,x(.9,.25,.9)),h.createBox(0,0,0,x(.6,.25,.6)),h.createBox(0,.5,0,x(.3,.25,.3))]},{name:"Torus",objects:[h.createTorus(0,0,0,1.3)]}];static getPreset(r){return this.presets[Math.max(0,Math.min(r,this.presets.length-1))]}static getPresetCount(){return this.presets.length}static populateSceneDropdown(r,t=0){r.innerHTML="";for(let s=0;s<this.presets.length;s++){const a=this.getPreset(s),n=document.createElement("option");n.value=s.toString(),n.textContent=a.name,n.selected=s===t,r.appendChild(n)}}}class _{objectSDFs;camera;currentPresetIndex=0;constructor(){this.camera=new K,this.objectSDFs=new Array,this.loadPreset(0)}loadPreset(r){this.currentPresetIndex=Math.max(0,Math.min(r,h.getPresetCount()-1));const t=h.getPreset(this.currentPresetIndex);this.objectSDFs=[...t.objects]}nextPreset(){this.loadPreset(Math.min(this.currentPresetIndex+1,h.getPresetCount()))}previousPreset(){this.loadPreset(Math.max(this.currentPresetIndex-1,0))}getCurrentPresetInfo(){const r=h.getPreset(this.currentPresetIndex);return{index:this.currentPresetIndex,name:r.name,total:h.getPresetCount()}}}class U{}const u=100,X=10,rr=.001;class L extends U{runRaymarcher(r,t,s,a,n,c,i,o,m=0,l=i){const f=r.camera.getRotationMatrix(D()),p=O();Y(p,f);const v=C();r.camera.getPosition(v);for(let d=m;d<l;d++){const b=d-m,S=(d/i-.5)*2;for(let P=0;P<c;P++){const T=b*c+P,A=T*3;a[T]=0,n[T]=0;const z=(P/c-.5)*2,y=x(z,S,-1);q(y,y,p),R(y,y);const w=this.rayMarch(r,v,y,T,a,n),I=C();j(I,v,y,w);let M;w>=X?M=x(0,0,0):M=this.getNormal(r,I,T,a),s[A]=(M[0]+1)*.5*255,s[A+1]=(M[1]+1)*.5*255,s[A+2]=(M[2]+1)*.5*255,t[T]=w}}}getSceneDistance(r,t,s,a){a[s]+=1;let n=X;for(const c of r.objectSDFs)n=Math.min(c.sdf(t),n);return n}getNormal(r,t,s,a){let n=this.getSceneDistance(r,t,s,a);const c=[.01,0,0],i=C();return i[0]=n-this.getSceneDistance(r,x(t[0]-c[0],t[1],t[2]),s,a),i[1]=n-this.getSceneDistance(r,x(t[0],t[1]-c[0],t[2]),s,a),i[2]=n-this.getSceneDistance(r,x(t[0],t[1],t[2]-c[0]),s,a),R(i,i),i}rayMarch(r,t,s,a,n,c){let i=0;for(let o=0;o<u;o++){const m=C();j(m,t,s,i);const l=this.getSceneDistance(r,m,a,n);if(i+=l,c[a]+=1,l<rr||i>X)break}return i}}const er=200,E=10,tr=.001,sr=.1;class ar extends U{runRaymarcher(r,t,s,a,n,c,i,o,m=0,l=i){const f=r.camera.getRotationMatrix(D()),p=O();Y(p,f);const v=C();r.camera.getPosition(v);for(let d=m;d<l;d++){const b=d-m,S=(d/i-.5)*2;for(let P=0;P<c;P++){const T=b*c+P,A=T*3;a[T]=0,n[T]=0;const z=(P/c-.5)*2,y=x(z,S,-1);q(y,y,p),R(y,y);const w=this.fixedStepMarch(r,v,y,T,a,n),I=C();j(I,v,y,w);let M;w>=E?M=x(0,0,0):M=this.getNormal(r,I,T,a),s[A]=(M[0]+1)*.5*255,s[A+1]=(M[1]+1)*.5*255,s[A+2]=(M[2]+1)*.5*255,t[T]=w}}}getSceneDistance(r,t,s,a){a[s]+=1;let n=E;for(const c of r.objectSDFs)n=Math.min(c.sdf(t),n);return n}getNormal(r,t,s,a){let n=this.getSceneDistance(r,t,s,a);const c=[.01,0,0],i=C();return i[0]=n-this.getSceneDistance(r,x(t[0]-c[0],t[1],t[2]),s,a),i[1]=n-this.getSceneDistance(r,x(t[0],t[1]-c[0],t[2]),s,a),i[2]=n-this.getSceneDistance(r,x(t[0],t[1],t[2]-c[0]),s,a),R(i,i),i}fixedStepMarch(r,t,s,a,n,c){let i=0,o=!1;for(let m=0;m<er;m++){const l=C();j(l,t,s,i);const f=this.getSceneDistance(r,l,a,n);if(c[a]+=1,f<tr){o=!0;break}if(i+=sr,i>E)break}return o?i:E}}self.onmessage=e=>{const{width:r,height:t,time:s,yStart:a,yEnd:n,camera:c,algorithm:i,scenePresetIndex:o}=e.data,m=new _;m.loadPreset(o),m.camera.setAngles(c.pitch,c.yaw);const l=Math.max(0,n-a),f=new Uint8ClampedArray(r*l),p=new Uint8ClampedArray(r*l*3),v=new Uint16Array(r*l),d=new Uint16Array(r*l);let b;switch(i){case"sphere-tracer":b=new L;break;case"fixed-step":b=new ar;break;default:b=new L}b.runRaymarcher(m,f,p,v,d,r,t,s,a,n);const S={yStart:a,yEnd:n,depth:f,normal:p,sdfEval:v,iters:d};self.postMessage(S,[f.buffer,p.buffer,v.buffer,d.buffer])}})();
