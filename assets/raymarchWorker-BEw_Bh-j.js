(function(){"use strict";var N=typeof Float32Array<"u"?Float32Array:Array;function nt(){var r=new N(9);return N!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function at(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[4],r[4]=t[5],r[5]=t[6],r[6]=t[8],r[7]=t[9],r[8]=t[10],r}function R(){var r=new N(16);return N!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function ct(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r}function z(r,t){var e=t[0],i=t[1],s=t[2],n=t[3],c=t[4],a=t[5],o=t[6],h=t[7],m=t[8],f=t[9],u=t[10],x=t[11],p=t[12],v=t[13],S=t[14],D=t[15],y=e*a-i*c,T=e*o-s*c,w=e*h-n*c,g=i*o-s*a,M=i*h-n*a,E=s*h-n*o,W=m*v-f*p,B=m*S-u*p,q=m*D-x*p,V=f*S-u*v,H=f*D-x*v,O=u*D-x*S,P=y*O-T*H+w*V+g*q-M*B+E*W;return P?(P=1/P,r[0]=(a*O-o*H+h*V)*P,r[1]=(s*H-i*O-n*V)*P,r[2]=(v*E-S*M+D*g)*P,r[3]=(u*M-f*E-x*g)*P,r[4]=(o*q-c*O-h*B)*P,r[5]=(e*O-s*q+n*B)*P,r[6]=(S*w-p*E-D*T)*P,r[7]=(m*E-u*w+x*T)*P,r[8]=(c*H-a*q+h*W)*P,r[9]=(i*q-e*H-n*W)*P,r[10]=(p*M-v*w+D*y)*P,r[11]=(f*w-m*M-x*y)*P,r[12]=(a*B-c*V-o*W)*P,r[13]=(e*V-i*B+s*W)*P,r[14]=(v*T-p*g-S*y)*P,r[15]=(m*g-f*T+u*y)*P,r):null}function ot(r,t,e){var i=e[0],s=e[1],n=e[2],c,a,o,h,m,f,u,x,p,v,S,D;return t===r?(r[12]=t[0]*i+t[4]*s+t[8]*n+t[12],r[13]=t[1]*i+t[5]*s+t[9]*n+t[13],r[14]=t[2]*i+t[6]*s+t[10]*n+t[14],r[15]=t[3]*i+t[7]*s+t[11]*n+t[15]):(c=t[0],a=t[1],o=t[2],h=t[3],m=t[4],f=t[5],u=t[6],x=t[7],p=t[8],v=t[9],S=t[10],D=t[11],r[0]=c,r[1]=a,r[2]=o,r[3]=h,r[4]=m,r[5]=f,r[6]=u,r[7]=x,r[8]=p,r[9]=v,r[10]=S,r[11]=D,r[12]=c*i+m*s+p*n+t[12],r[13]=a*i+f*s+v*n+t[13],r[14]=o*i+u*s+S*n+t[14],r[15]=h*i+x*s+D*n+t[15]),r}function ht(r,t,e){var i=e[0],s=e[1],n=e[2];return r[0]=t[0]*i,r[1]=t[1]*i,r[2]=t[2]*i,r[3]=t[3]*i,r[4]=t[4]*s,r[5]=t[5]*s,r[6]=t[6]*s,r[7]=t[7]*s,r[8]=t[8]*n,r[9]=t[9]*n,r[10]=t[10]*n,r[11]=t[11]*n,r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r}function K(r,t,e){var i=Math.sin(e),s=Math.cos(e),n=t[4],c=t[5],a=t[6],o=t[7],h=t[8],m=t[9],f=t[10],u=t[11];return t!==r&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[4]=n*s+h*i,r[5]=c*s+m*i,r[6]=a*s+f*i,r[7]=o*s+u*i,r[8]=h*s-n*i,r[9]=m*s-c*i,r[10]=f*s-a*i,r[11]=u*s-o*i,r}function Q(r,t,e){var i=Math.sin(e),s=Math.cos(e),n=t[0],c=t[1],a=t[2],o=t[3],h=t[8],m=t[9],f=t[10],u=t[11];return t!==r&&(r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[0]=n*s-h*i,r[1]=c*s-m*i,r[2]=a*s-f*i,r[3]=o*s-u*i,r[8]=n*i+h*s,r[9]=c*i+m*s,r[10]=a*i+f*s,r[11]=o*i+u*s,r}function mt(r,t,e){var i=Math.sin(e),s=Math.cos(e),n=t[0],c=t[1],a=t[2],o=t[3],h=t[4],m=t[5],f=t[6],u=t[7];return t!==r&&(r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[0]=n*s+h*i,r[1]=c*s+m*i,r[2]=a*s+f*i,r[3]=o*s+u*i,r[4]=h*s-n*i,r[5]=m*s-c*i,r[6]=f*s-a*i,r[7]=u*s-o*i,r}function lt(r,t){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r}function ft(r,t,e,i){var s=t[0],n=t[1],c=t[2],a=t[3],o=s+s,h=n+n,m=c+c,f=s*o,u=s*h,x=s*m,p=n*h,v=n*m,S=c*m,D=a*o,y=a*h,T=a*m,w=i[0],g=i[1],M=i[2];return r[0]=(1-(p+S))*w,r[1]=(u+T)*w,r[2]=(x-y)*w,r[3]=0,r[4]=(u-T)*g,r[5]=(1-(f+S))*g,r[6]=(v+D)*g,r[7]=0,r[8]=(x+y)*M,r[9]=(v-D)*M,r[10]=(1-(f+p))*M,r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r}function b(){var r=new N(3);return N!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function Y(r){var t=new N(3);return t[0]=r[0],t[1]=r[1],t[2]=r[2],t}function Z(r){var t=r[0],e=r[1],i=r[2];return Math.sqrt(t*t+e*e+i*i)}function d(r,t,e){var i=new N(3);return i[0]=r,i[1]=t,i[2]=e,i}function _(r,t,e){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r}function dt(r,t,e){return r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r}function k(r,t,e,i){return r[0]=t[0]+e[0]*i,r[1]=t[1]+e[1]*i,r[2]=t[2]+e[2]*i,r}function ut(r,t){var e=t[0]-r[0],i=t[1]-r[1],s=t[2]-r[2];return Math.sqrt(e*e+i*i+s*s)}function G(r,t){var e=t[0],i=t[1],s=t[2],n=e*e+i*i+s*s;return n>0&&(n=1/Math.sqrt(n)),r[0]=t[0]*n,r[1]=t[1]*n,r[2]=t[2]*n,r}function X(r,t,e){var i=t[0],s=t[1],n=t[2],c=e[3]*i+e[7]*s+e[11]*n+e[15];return c=c||1,r[0]=(e[0]*i+e[4]*s+e[8]*n+e[12])/c,r[1]=(e[1]*i+e[5]*s+e[9]*n+e[13])/c,r[2]=(e[2]*i+e[6]*s+e[10]*n+e[14])/c,r}function pt(r,t,e){var i=t[0],s=t[1],n=t[2];return r[0]=i*e[0]+s*e[3]+n*e[6],r[1]=i*e[1]+s*e[4]+n*e[7],r[2]=i*e[2]+s*e[5]+n*e[8],r}(function(){var r=b();return function(t,e,i,s,n,c){var a,o;for(e||(e=3),i||(i=0),s?o=Math.min(s*e+i,t.length):o=t.length,a=i;a<o;a+=e)r[0]=t[a],r[1]=t[a+1],r[2]=t[a+2],n(r,r,c),t[a]=r[0],t[a+1]=r[1],t[a+2]=r[2];return t}})();class xt{orbitCentre;cameraDistance;cameraTransform;pitch;yaw;constructor(){this.orbitCentre=R(),this.cameraDistance=3,this.pitch=0,this.yaw=0,this.cameraTransform=R(),this.updateCameraTransform()}rotateCamera(t,e){this.pitch=Math.min(Math.max(this.pitch+t,-Math.PI/2),Math.PI/2),this.yaw+=e,this.updateCameraTransform()}getAngles(){return[this.pitch,this.yaw]}getRotationMatrix(t){return t[0]=this.cameraTransform[0],t[1]=this.cameraTransform[1],t[2]=this.cameraTransform[2],t[3]=0,t[4]=this.cameraTransform[4],t[5]=this.cameraTransform[5],t[6]=this.cameraTransform[6],t[7]=0,t[8]=this.cameraTransform[8],t[9]=this.cameraTransform[9],t[10]=this.cameraTransform[10],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}getCameraPosition(t){return t[0]=this.cameraTransform[12],t[1]=this.cameraTransform[13],t[2]=this.cameraTransform[14],t}getCameraMatrix(t){return ct(t,this.cameraTransform),t}setAngles(t,e){this.pitch=Math.min(Math.max(t,-Math.PI/2),Math.PI/2),this.yaw=e,this.updateCameraTransform()}getPosition(t){return t[0]=this.cameraTransform[12],t[1]=this.cameraTransform[13],t[2]=this.cameraTransform[14],t}transformDirection(t,e){const i=this.cameraTransform,s=e[0],n=e[1],c=e[2];return t[0]=i[0]*s+i[4]*n+i[8]*c,t[1]=i[1]*s+i[5]*n+i[9]*c,t[2]=i[2]*s+i[6]*n+i[10]*c,t}updateCameraTransform(){const t=R();Q(t,R(),this.yaw),K(this.orbitCentre,t,this.pitch),ot(this.cameraTransform,this.orbitCentre,d(0,0,Math.abs(this.cameraDistance)))}}class A{transform;constructor(t){this.transform=t}getWorldPosition(){const t=R();return z(t,this.transform),d(t[12],t[13],t[14])}sdf(t){const e=b();return X(e,t,this.transform),this.localSdf(e)}setTime(t){}}class vt extends A{radius;constructor(t,e){super(t),this.radius=e}localSdf(t){return Z(t)-this.radius}getLocalBoundingRadius(){return this.radius}}class yt extends A{halfSize;constructor(t,e){super(t),this.halfSize=Y(e)}localSdf(t){const e=d(Math.abs(t[0])-this.halfSize[0],Math.abs(t[1])-this.halfSize[1],Math.abs(t[2])-this.halfSize[2]),i=d(Math.max(e[0],0),Math.max(e[1],0),Math.max(e[2],0)),s=Z(i),n=Math.min(Math.max(e[0],Math.max(e[1],e[2])),0);return s+n}getLocalBoundingRadius(){return Z(this.halfSize)}}class St extends A{majorRadius;minorRadius;constructor(t,e,i){super(t),this.majorRadius=e,this.minorRadius=i}localSdf(t){const e=t[0],i=t[1],s=t[2],n=Math.sqrt(e*e+s*s)-this.majorRadius,c=i;return Math.sqrt(n*n+c*c)-this.minorRadius}getLocalBoundingRadius(){return this.majorRadius+this.minorRadius}}class Dt extends A{power;iterations;enableAnimation;animationSpeed;time;constructor(t,e=8,i=9,s=!0,n=-.2){super(t),this.power=e,this.iterations=i,this.enableAnimation=s,this.animationSpeed=n,this.time=0}setTime(t){this.time=t}localSdf(t){const e=d(t[0],t[2],t[1]);let i=Y(e),s=1,n=0;for(let c=0;c<this.iterations&&(n=Z(i),!(n>2));c++){let a=Math.atan2(i[1],i[0]),o=Math.asin(i[2]/n);this.enableAnimation&&(o+=this.time*this.animationSpeed),s=Math.pow(n,this.power-1)*s*this.power+1,n=Math.pow(n,this.power),a=a*this.power,o=o*this.power,i[0]=n*Math.cos(a)*Math.cos(o)+e[0],i[1]=n*Math.sin(a)*Math.cos(o)+e[1],i[2]=n*Math.sin(o)+e[2]}return .5*Math.log(n)*n/s}getLocalBoundingRadius(){return 2.5}}class bt extends A{prim1;prim2;smoothness;constructor(t,e,i){super(R()),this.prim1=t,this.prim2=e,this.smoothness=i}localSdf(t){const e=b(),i=R();z(i,this.transform),X(e,t,i);const s=this.prim1.sdf(e),n=this.prim2.sdf(e),c=this.smoothness*4,a=Math.max(c-Math.abs(s-n),0);return Math.min(s,n)-a*a*.25/c}getLocalBoundingRadius(){const t=this.prim1.getLocalBoundingRadius(),e=this.prim2.getLocalBoundingRadius(),i=this.prim1.getWorldPosition(),s=this.prim2.getWorldPosition(),n=ut(i,s);return Math.max(t,e)+n*.5}getWorldPosition(){const t=this.prim1.getWorldPosition(),e=this.prim2.getWorldPosition();return d((t[0]+e[0])/2,(t[1]+e[1])/2,(t[2]+e[2])/2)}setTime(t){this.prim1.setTime(t),this.prim2.setTime(t)}}class Pt extends A{primitive;twistAmount;constructor(t,e=10){super(t.transform),this.primitive=t,this.twistAmount=e}localSdf(t){const e=b(),i=R();z(i,this.transform),X(e,t,i);const s=this.twistAmount,n=Math.cos(s*e[1]),c=Math.sin(s*e[1]),a=d(n*e[0]-c*e[2],e[1],c*e[0]+n*e[2]);return this.primitive.sdf(a)}getLocalBoundingRadius(){return this.primitive.getLocalBoundingRadius()}getWorldPosition(){return this.primitive.getWorldPosition()}setTime(t){this.primitive.setTime(t)}}class Tt extends A{primitive;radius;constructor(t,e){super(t.transform),this.primitive=t,this.radius=e}localSdf(t){const e=b(),i=R();return z(i,this.transform),X(e,t,i),this.primitive.sdf(e)-this.radius}getLocalBoundingRadius(){return this.primitive.getLocalBoundingRadius()+this.radius}getWorldPosition(){return this.primitive.getWorldPosition()}setTime(t){this.primitive.setTime(t)}}class Rt extends A{prim1;prim2;smoothness;constructor(t,e,i){super(R()),this.prim1=t,this.prim2=e,this.smoothness=i}localSdf(t){const e=b(),i=R();z(i,this.transform),X(e,t,i);const s=this.prim1.sdf(e),n=this.prim2.sdf(e),c=this.smoothness*4,a=Math.max(c-Math.abs(s+n),0);return Math.max(s,-n)+a*a*.25/c}getLocalBoundingRadius(){return this.prim1.getLocalBoundingRadius()}getWorldPosition(){return this.prim1.getWorldPosition()}setTime(t){this.prim1.setTime(t),this.prim2.setTime(t)}}class Mt extends A{primitive;spacing;constructor(t,e){super(t.transform),this.primitive=t,this.spacing=e}localSdf(t){const e=b(),i=R();z(i,this.transform),X(e,t,i);const s=b();return s[0]=e[0]-this.spacing[0]*Math.round(e[0]/this.spacing[0]),s[1]=e[1]-this.spacing[1]*Math.round(e[1]/this.spacing[1]),s[2]=e[2]-this.spacing[2]*Math.round(e[2]/this.spacing[2]),this.primitive.sdf(s)}getLocalBoundingRadius(){return 1/0}getWorldPosition(){return this.primitive.getWorldPosition()}setTime(t){this.primitive.setTime(t)}}class wt extends A{primitive;direction;amplitude;speed;time;constructor(t,e=d(1,0,0),i=2,s=.5){super(t.transform),this.primitive=t,this.direction=b(),G(this.direction,e),this.amplitude=i,this.speed=s,this.time=0}setTime(t){this.time=t}localSdf(t){const e=Math.sin(this.time*this.speed)*this.amplitude,i=b();dt(i,this.direction,e);const s=b();return _(s,t,i),this.primitive.sdf(s)}getLocalBoundingRadius(){return this.primitive.getLocalBoundingRadius()+this.amplitude}getWorldPosition(){return this.primitive.getWorldPosition()}}class l{static getTransform(t,e,i,s){const n=R();s?(lt(n,[t,e,i]),K(n,n,s[0]),Q(n,n,s[1]),mt(n,n,s[2])):ft(n,[0,0,0,1],[t,e,i],[1,1,1]);const c=R();return z(c,n),c}static createSphere(t,e,i,s,n){return new vt(l.getTransform(t,e,i,n),s)}static createBox(t,e,i,s,n){return new yt(l.getTransform(t,e,i,n),s)}static createTorus(t,e,i,s,n){return new St(l.getTransform(t,e,i,n),s,s/4)}static createMandelbulb(t,e,i,s=8,n=9,c=!0,a=.05,o){const h=l.getTransform(t,e,i,o);return ht(h,h,[.5,.5,.5]),new Dt(h,s,n,c,a)}static createSmoothUnion(t,e,i){return new bt(t,e,i)}static createSmoothSubtract(t,e,i){return new Rt(t,e,i)}static createTwist(t,e){return new Pt(t,e)}static createRound(t,e){return new Tt(t,e)}static createRepetition(t,e){return new Mt(t,e)}static createAnimatedTranslate(t,e=d(1,0,0),i=2,s=.5){return new wt(t,e,i,s)}static presets=[{name:"Sphere",objects:[l.createSphere(0,0,0,1.5)]},{name:"Random Spheres",objects:[l.createSphere(.8,-.3,.2,.4),l.createSphere(-.5,.9,-.1,.5),l.createSphere(.2,.1,.8,.3),l.createSphere(-.9,-.4,-.6,.6),l.createSphere(.4,-.8,.5,.35),l.createSphere(-.2,.6,-.9,.4),l.createSphere(.7,.3,-.4,.25)]},{name:"Grid of Spheres",objects:[l.createSphere(-1,-1,0,.3),l.createSphere(0,-1,0,.3),l.createSphere(1,-1,0,.3),l.createSphere(-1,0,0,.3),l.createSphere(0,0,0,.3),l.createSphere(1,0,0,.3),l.createSphere(-1,1,0,.3),l.createSphere(0,1,0,.3),l.createSphere(1,1,0,.3)]},{name:"Dense Sphere Grid",objects:(()=>{const t=[];for(let n=0;n<5;n++)for(let c=0;c<5;c++)for(let a=0;a<5;a++)t.push(l.createSphere(n*.6-1.2,c*.6-1.2,a*.6-1.2,.15));return t})()},{name:"Atom",objects:[l.createSphere(0,0,0,.5),l.createSphere(1.2,0,0,.3),l.createSphere(-1.2,0,0,.3),l.createSphere(0,1.2,0,.3),l.createSphere(0,-1.2,0,.3),l.createSphere(0,0,1.2,.3),l.createSphere(0,0,-1.2,.3)]},{name:"Torus",objects:[l.createTorus(0,0,0,1.3,d(-Math.PI/2,0,0))]},{name:"Rounded Box",objects:[l.createRound(l.createBox(0,0,0,d(.4,.4,.4)),.3)]},{name:"Cube",objects:[l.createBox(0,0,0,d(1,1,1))]},{name:"Sphere and Cube",objects:[l.createSphere(-.7,0,0,.5),l.createBox(1,0,0,d(.5,.5,.5))]},{name:"Pyramid of Boxes",objects:[l.createBox(0,.5,0,d(.9,.25,.9)),l.createBox(0,0,0,d(.6,.25,.6)),l.createBox(0,-.5,0,d(.3,.25,.3))]},{name:"Smooth Union",objects:[l.createSmoothUnion(l.createSphere(0,0,0,.5),l.createBox(0,.5,0,d(1,.2,1)),.2)]},{name:"Smooth Subtraction",objects:[l.createSmoothSubtract(l.createRound(l.createBox(0,0,0,d(1,1,1),d(0,Math.PI/4,0)),.1),l.createSphere(0,0,0,.9),.2)]},{name:"Smooth Union [A]",objects:[l.createSmoothUnion(l.createAnimatedTranslate(l.createSphere(0,0,0,1),d(1,0,0),3,.005),l.createSphere(0,0,0,1),.2)]},{name:"Mandelbulb [A]",objects:[l.createMandelbulb(0,0,0,8,80,!0,-1e-4,void 0)]},{name:"Twisted Torus",objects:[l.createTwist(l.createTorus(0,0,0,1.3,d(-Math.PI/2,0,0)),3)]},{name:"Infinite Spheres",objects:[l.createRepetition(l.createSphere(0,0,0,.3),d(1.5,1.5,1.5))]},{name:"Screw",objects:[l.createRound(l.createTwist(l.createBox(0,0,0,d(.4,1.5,.4)),4),.1)]},{name:"Chicken",objects:[l.createSmoothUnion(l.createSmoothUnion(l.createSmoothUnion(l.createSmoothUnion(l.createSmoothUnion(l.createSmoothUnion(l.createSmoothUnion(l.createSmoothUnion(l.createSmoothUnion(l.createBox(0,0,0,d(.6,.6,.8)),l.createBox(0,-.2,0,d(.8,.4,.6)),1e-4),l.createBox(0,-.8,.8,d(.4,.6,.3)),1e-4),l.createBox(0,-.8,1.2,d(.4,.2,.2)),1e-4),l.createBox(0,-.4,1,d(.2,.2,.2)),1e-4),l.createBox(.3,1,0,d(.1,.6,.01)),1e-4),l.createBox(-.3,1,0,d(.1,.6,.01)),1e-4),l.createBox(0,1.6,.2,d(.6,.01,.2)),1e-4),l.createBox(.3,1.6,.5,d(.1,.01,.1)),1e-4),l.createBox(-.3,1.6,.5,d(.1,.01,.1)),1e-4)]},{name:"67",objects:[l.createSmoothUnion(l.createRound(l.createBox(-1.25,-.8,0,d(.05,.7,.05),d(0,0,Math.PI/5)),.2),l.createRound(l.createTorus(-1.25,.5,0,.8,d(-Math.PI/2,0,0)),.05),1e-4),l.createSmoothUnion(l.createRound(l.createBox(1.35,0,0,d(.05,1.5,.05),d(0,0,Math.PI/7)),.2),l.createRound(l.createBox(1.25,-1.4,0,d(.05,.8,.05),d(0,0,Math.PI/2)),.2),1e-4)]}];static getPreset(t){return this.presets[Math.max(0,Math.min(t,this.presets.length-1))]}static getPresetCount(){return this.presets.length}static populateSceneDropdown(t,e=0){t.innerHTML="";for(let i=0;i<this.presets.length;i++){const s=this.getPreset(i),n=document.createElement("option");n.value=i.toString(),n.textContent=s.name,n.selected=i===e,t.appendChild(n)}}}class I{min;max;constructor(t,e){this.min=Y(t),this.max=Y(e)}contains(t){return t[0]>=this.min[0]&&t[0]<=this.max[0]&&t[1]>=this.min[1]&&t[1]<=this.max[1]&&t[2]>=this.min[2]&&t[2]<=this.max[2]}intersects(t){return this.min[0]<=t.max[0]&&this.max[0]>=t.min[0]&&this.min[1]<=t.max[1]&&this.max[1]>=t.min[1]&&this.min[2]<=t.max[2]&&this.max[2]>=t.min[2]}distanceToBox(t){let e=0;this.max[0]<t.min[0]?e=t.min[0]-this.max[0]:t.max[0]<this.min[0]&&(e=this.min[0]-t.max[0]);let i=0;this.max[1]<t.min[1]?i=t.min[1]-this.max[1]:t.max[1]<this.min[1]&&(i=this.min[1]-t.max[1]);let s=0;return this.max[2]<t.min[2]?s=t.min[2]-this.max[2]:t.max[2]<this.min[2]&&(s=this.min[2]-t.max[2]),Math.hypot(e,i,s)}distanceToPoint(t){let e=0;t[0]<this.min[0]?e=this.min[0]-t[0]:t[0]>this.max[0]&&(e=t[0]-this.max[0]);let i=0;t[1]<this.min[1]?i=this.min[1]-t[1]:t[1]>this.max[1]&&(i=t[1]-this.max[1]);let s=0;return t[2]<this.min[2]?s=this.min[2]-t[2]:t[2]>this.max[2]&&(s=t[2]-this.max[2]),Math.hypot(e,i,s)}intersectRay(t,e){let i=-1/0,s=1/0;for(let n=0;n<3;n++)if(Math.abs(e[n])<1e-10){if(t[n]<this.min[n]||t[n]>this.max[n])return null}else{const c=1/e[n];let a=(this.min[n]-t[n])*c,o=(this.max[n]-t[n])*c;if(a>o){const h=a;a=o,o=h}if(i=Math.max(i,a),s=Math.min(s,o),i>s)return null}return[i,s]}center(){return d((this.min[0]+this.max[0])/2,(this.min[1]+this.max[1])/2,(this.min[2]+this.max[2])/2)}merge(t){return new I(d(Math.min(this.min[0],t.min[0]),Math.min(this.min[1],t.min[1]),Math.min(this.min[2],t.min[2])),d(Math.max(this.max[0],t.max[0]),Math.max(this.max[1],t.max[1]),Math.max(this.max[2],t.max[2])))}static fromPrimitive(t){const e=t.getWorldPosition(),i=t.getLocalBoundingRadius(),s=R(),c=z(s,t.transform)?s:t.transform,a=Math.hypot(c[0],c[1],c[2]),o=Math.hypot(c[4],c[5],c[6]),h=Math.hypot(c[8],c[9],c[10]),m=Math.max(a,o,h),f=i*m*1.5;return new I(d(e[0]-f,e[1]-f,e[2]-f),d(e[0]+f,e[1]+f,e[2]+f))}}function J(r){if(r.length===0)return new I(d(0,0,0),d(0,0,0));let t=I.fromPrimitive(r[0]);for(let e=1;e<r.length;e++)t=t.merge(I.fromPrimitive(r[e]));return t}class tt{bounds;primitives;children;level;isEmpty;minDistance;constructor(t,e,i){this.bounds=t,this.primitives=e,this.children=null,this.level=i,this.isEmpty=!0,this.minDistance=0}isLeaf(){return this.children===null}}class gt{root;maxDepth;maxPrimitivesPerNode;primitives;sceneBounds;primitiveBounds;constructor(t,e,i=6,s=4){this.maxDepth=i,this.maxPrimitivesPerNode=s,this.primitives=t,this.sceneBounds=e,this.primitiveBounds=t.map(n=>I.fromPrimitive(n)),this.root=this.buildNode(t,e,0),this.computeMinDistances(this.root)}buildNode(t,e,i){const s=new tt(e,[],i);if(i>=this.maxDepth||t.length<=this.maxPrimitivesPerNode)return s.primitives=t,s;const n=e.center(),c=[];for(let o=0;o<2;o++)for(let h=0;h<2;h++)for(let m=0;m<2;m++){const f=m===0?e.min[0]:n[0],u=m===0?n[0]:e.max[0],x=h===0?e.min[1]:n[1],p=h===0?n[1]:e.max[1],v=o===0?e.min[2]:n[2],S=o===0?n[2]:e.max[2];c.push(new I(d(f,x,v),d(u,p,S)))}const a=Array.from({length:8},()=>[]);for(const o of t){const h=I.fromPrimitive(o);for(let m=0;m<8;m++)c[m].intersects(h)&&a[m].push(o)}s.children=[];for(let o=0;o<8;o++)if(a[o].length>0)s.children.push(this.buildNode(a[o],c[o],i+1));else{const h=new tt(c[o],[],i+1);s.children.push(h)}return s}getPrimitivesAt(t){const e=new Set;return this.queryNode(this.root,t,e),Array.from(e)}queryNode(t,e,i){if(t.bounds.contains(e)){if(t.isLeaf()){for(const s of t.primitives)i.add(s);return}if(t.children)for(const s of t.children)this.queryNode(s,e,i)}}computeMinDistances(t){if(t.isLeaf()){const i=t.primitives.length>0;if(t.isEmpty=!i,i)t.minDistance=0;else{let s=1/0;for(let n=0;n<this.primitiveBounds.length;n++){const c=t.bounds.distanceToBox(this.primitiveBounds[n]);c<s&&(s=c)}t.minDistance=s!==1/0?Math.max(0,s):0}return{hasPrims:i}}let e=!1;if(t.children)for(const i of t.children)this.computeMinDistances(i).hasPrims&&(e=!0);if(t.isEmpty=!e,t.isEmpty){let i=1/0;for(let s=0;s<this.primitiveBounds.length;s++){const n=t.bounds.distanceToBox(this.primitiveBounds[s]);n<i&&(i=n)}t.minDistance=i!==1/0?Math.max(0,i):0}else t.minDistance=0;return{hasPrims:e}}intersectRayBox(t,e,i){const s=b(),n=b();for(let o=0;o<3;o++){const h=1/e[o];let m=(i.min[o]-t[o])*h,f=(i.max[o]-t[o])*h;h<0&&([m,f]=[f,m]),s[o]=m,n[o]=f}const c=Math.max(s[0],s[1],s[2]),a=Math.min(n[0],n[1],n[2]);return c>a||a<0?null:[Math.max(0,c),a]}findNode(t){return this.findNodeRecursive(this.root,t)}findNodeRecursive(t,e){if(!t.bounds.contains(e))return null;if(t.isLeaf()||t.level===this.maxDepth)return t;if(t.children)for(const i of t.children){const s=this.findNodeRecursive(i,e);if(s)return s}return t}marchRay(t,e,i){const s=b();k(s,t,e,i);const n=this.findNode(s);if(!n)return 0;if(n.isEmpty){const c=this.intersectRayBox(t,e,n.bounds);if(c){const[a,o]=c,h=Math.max(0,o-i),m=Math.max(0,Math.min(h,n.minDistance*.99));return m>0?m+.001:0}}return 0}onRayMarchStart(t){return{data:null}}onRayMarchStep(t,e){return this.marchRay(t.rayOrigin,t.rayDirection,t.currentDistance)}}class Bt{bounds;primitives;left;right;constructor(t,e){this.bounds=t,this.primitives=e,this.left=null,this.right=null}isLeaf(){return this.left===null&&this.right===null}}class At{root;maxDepth;maxPrimitivesPerNode;constructor(t,e,i=20,s=2){this.maxDepth=i,this.maxPrimitivesPerNode=s;const n=J(t);this.root=this.buildNode(t,n,0)}buildNode(t,e,i){const s=new Bt(e,[]);if(i>=this.maxDepth||t.length<=this.maxPrimitivesPerNode)return s.primitives=t,s;const n=b();_(n,e.max,e.min);let c=0;n[1]>n[0]&&(c=1),n[2]>n[c]&&(c=2);const a=[...t].sort((x,p)=>{const v=x.getWorldPosition()[c],S=p.getWorldPosition()[c];return v-S}),o=Math.floor(a.length/2),h=a.slice(0,o),m=a.slice(o);if(h.length===0||m.length===0)return s.primitives=t,s;const f=J(h),u=J(m);return s.left=this.buildNode(h,f,i+1),s.right=this.buildNode(m,u,i+1),s}getPrimitivesAt(t){const e=new Set;return this.queryNode(this.root,t,e),Array.from(e)}queryNode(t,e,i){if(t.bounds.contains(e)){if(t.isLeaf()){for(const s of t.primitives)i.add(s);return}t.left&&this.queryNode(t.left,e,i),t.right&&this.queryNode(t.right,e,i)}}findRayIntersections(t,e,i=0,s=1/0){const n=[],c=[this.root];for(;c.length>0;){const a=c.pop(),o=a.bounds.intersectRay(t,e);if(!o)continue;const[h,m]=o;if(m<i||h>s)continue;const f=Math.max(h,i),u=Math.min(m,s);a.isLeaf()?a.primitives&&a.primitives.length>0&&n.push({tEnter:f,tExit:u,node:a}):(a.left&&c.push(a.left),a.right&&c.push(a.right))}return n.sort((a,o)=>a.tEnter-o.tEnter),n}onRayMarchStart(t){const e=this.findRayIntersections(t.rayOrigin,t.rayDirection,0,t.maxDistance);return e.length===0?{data:{intervals:[],terminate:!0}}:{data:{intervals:e,currentIntervalIdx:0,terminate:!1}}}onRayMarchStep(t,e){if(!e.data||e.data.terminate)return-1;const{intervals:i,currentIntervalIdx:s}=e.data;if(s>=i.length)return-1;const n=i[s];if(t.currentDistance<n.tEnter)return n.tEnter-t.currentDistance;if(t.currentDistance>n.tExit)if(e.data.currentIntervalIdx++,e.data.currentIntervalIdx<i.length){const c=i[e.data.currentIntervalIdx];if(c.tEnter>t.currentDistance)return c.tEnter-t.currentDistance}else return-1;return 0}}class It{objectSDFs;camera;octree=null;bvh=null;accelerationStructure="None";currentPresetIndex=0;cachedBounds=null;constructor(t="None"){this.camera=new xt,this.objectSDFs=new Array,this.accelerationStructure=t,this.loadPreset(0)}getAccelerationStructure(){return this.accelerationStructure==="Octree"?this.octree:this.accelerationStructure==="BVH"?this.bvh:null}loadPreset(t){this.currentPresetIndex=Math.max(0,Math.min(t,l.getPresetCount()-1));const e=l.getPreset(this.currentPresetIndex);this.objectSDFs=[...e.objects],this.cachedBounds=null,this.accelerationStructure=="Octree"?(this.buildOctree(),this.bvh=null):this.accelerationStructure=="BVH"?(this.buildBVH(),this.octree=null):(this.octree=null,this.bvh=null)}buildOctree(){const t=this.getSceneBounds();this.octree=new gt(this.objectSDFs,t)}buildBVH(){const t=this.getSceneBounds();this.bvh=new At(this.objectSDFs,t)}getSceneBounds(){return this.cachedBounds||(this.cachedBounds=this.calculateSceneBounds()),this.cachedBounds}calculateSceneBounds(){return new I(d(-10,-10,-10),d(10,10,10))}nextPreset(){this.loadPreset(Math.min(this.currentPresetIndex+1,l.getPresetCount()))}previousPreset(){this.loadPreset(Math.max(this.currentPresetIndex-1,0))}getCurrentPresetInfo(){const t=l.getPreset(this.currentPresetIndex);return{index:this.currentPresetIndex,name:t.name,total:l.getPresetCount()}}updateTime(t){for(const e of this.objectSDFs)e.setTime(t)}getDistance(t,e){let s=10;if(this.accelerationStructure==="Octree"&&this.octree){const n=this.octree.findNode(t);if(n){if(n.primitives.length>0)for(const c of n.primitives)e&&e.count++,s=Math.min(c.sdf(t),s);else n.isEmpty&&(s=Math.min(s,n.minDistance*.99));return s}}else if(this.accelerationStructure==="BVH"&&this.bvh){let n=this.bvh.getPrimitivesAt(t);n=n.length===0?this.objectSDFs:n;for(const c of n)e&&e.count++,s=Math.min(c.sdf(t),s);return s}for(const n of this.objectSDFs)e&&e.count++,s=Math.min(n.sdf(t),s);return s}}class ${runRaymarcher(t,e,i,s,n,c,a,o,h=0,m=a){t.updateTime(o);const f=t.camera.getRotationMatrix(R()),u=nt();at(u,f);const x=b();t.camera.getPosition(x);const p=this.getMaxDistance();for(let v=h;v<m;v++){const S=v-h,D=(v/a-.5)*2;for(let y=0;y<c;y++){const T=S*c+y,w=T*3;s[T]=0,n[T]=0;const g=(y/c-.5)*2,M=d(g,D,-1);pt(M,M,u),G(M,M);const E=this.rayMarch(t,x,M,T,s,n),W=b();k(W,x,M,E);let B;E>=p?B=d(0,0,0):B=this.getNormal(t,W,T,s),i[w]=(B[0]+1)*.5*255,i[w+1]=(B[1]+1)*.5*255,i[w+2]=(B[2]+1)*.5*255,e[T]=E}}}getSceneDistance(t,e,i,s){const n={count:0},c=t.getDistance(e,n);return s[i]+=n.count,c}getNormal(t,e,i,s){let n=this.getSceneDistance(t,e,i,s);const c=[.01,0,0],a=b();return a[0]=n-this.getSceneDistance(t,d(e[0]-c[0],e[1],e[2]),i,s),a[1]=n-this.getSceneDistance(t,d(e[0],e[1]-c[0],e[2]),i,s),a[2]=n-this.getSceneDistance(t,d(e[0],e[1],e[2]-c[0]),i,s),G(a,a),a}}const Et=100,C=10,Nt=.001;class et extends ${getMaxDistance(){return C}rayMarch(t,e,i,s,n,c){let a=0;const o=t.getAccelerationStructure();let h=null;if(o&&o.onRayMarchStart&&(h=o.onRayMarchStart({rayOrigin:e,rayDirection:i,currentDistance:a,maxDistance:C}),h&&h.data&&h.data.terminate))return C;for(let m=0;m<Et;m++){const f=b();if(k(f,e,i,a),o&&o.onRayMarchStep&&h){const x=o.onRayMarchStep({rayOrigin:e,rayDirection:i,currentDistance:a,maxDistance:C},h);if(x===-1)return C;if(x>0){if(a+=x,a>C)break;continue}}const u=this.getSceneDistance(t,f,s,n);if(a+=u,c[s]+=1,u<Nt||a>C)break}return o&&o.onRayMarchEnd&&h&&o.onRayMarchEnd(h),a}}const zt=200,j=10,kt=.001;class jt extends ${stepSize;constructor(t=.1){super(),this.stepSize=t}getMaxDistance(){return j}rayMarch(t,e,i,s,n,c){let a=0,o=!1;const h=t.getAccelerationStructure();let m=null;if(h&&h.onRayMarchStart&&(m=h.onRayMarchStart({rayOrigin:e,rayDirection:i,currentDistance:a,maxDistance:j}),m&&m.data&&m.data.terminate))return j;for(let f=0;f<zt;f++){const u=b();if(k(u,e,i,a),h&&h.onRayMarchStep&&m){const p=h.onRayMarchStep({rayOrigin:e,rayDirection:i,currentDistance:a,maxDistance:j},m);if(p===-1)return j;if(p>0){if(a+=p,a>j)break;continue}}const x=this.getSceneDistance(t,u,s,n);if(c[s]+=1,x<kt){o=!0;break}if(a+=this.stepSize,a>j)break}return h&&h.onRayMarchEnd&&m&&h.onRayMarchEnd(m),o?a:j}}const Lt=200,L=10,Wt=.001,rt=.1,Ct=.8,it=rt*.25,st=rt*5,Ut=.1,Ft=.01;class Xt extends ${getMaxDistance(){return L}rayMarch(t,e,i,s,n,c){let a=0,o=!1;const h=t.getAccelerationStructure();let m=null;if(h&&h.onRayMarchStart&&(m=h.onRayMarchStart({rayOrigin:e,rayDirection:i,currentDistance:a,maxDistance:L}),m&&m.data&&m.data.terminate))return L;for(let f=0;f<Lt;f++){const u=b();if(k(u,e,i,a),h&&h.onRayMarchStep&&m){const v=h.onRayMarchStep({rayOrigin:e,rayDirection:i,currentDistance:a,maxDistance:L},m);if(v===-1)return L;if(v>0){if(a+=v,a>L)break;continue}}const x=this.getSceneDistance(t,u,s,n);if(c[s]+=1,x<Wt){o=!0;break}let p;if(x<Ut?p=Ft:(p=Ct*x,p<it&&(p=it),p>st&&(p=st)),a+=p,a>L)break}return h&&h.onRayMarchEnd&&m&&h.onRayMarchEnd(m),o?a:L}}const $t=100,U=10,qt=.001;class Vt extends ${overshootFactor;constructor(t=1.2){super(),this.overshootFactor=t}getMaxDistance(){return U}rayMarch(t,e,i,s,n,c){let a=0,o=0,h=0;const m=t.getAccelerationStructure();let f=null;if(m&&m.onRayMarchStart&&(f=m.onRayMarchStart({rayOrigin:e,rayDirection:i,currentDistance:a,maxDistance:U}),f&&f.data&&f.data.terminate))return U;for(let u=0;u<$t;u++){const x=b();if(k(x,e,i,a),m&&m.onRayMarchStep&&f){const v=m.onRayMarchStep({rayOrigin:e,rayDirection:i,currentDistance:a,maxDistance:U},f);if(v===-1)return U;if(v>0){if(a+=v,a>U)break;o=0,h=0;continue}}const p=this.getSceneDistance(t,x,s,n);if(c[s]+=1,p<qt||a>U)break;if(u===0||o==0){const v=p;a+=v,o=p,h=v}else if(h<=o+p){const S=p*this.overshootFactor;a+=S,o=p,h=S}else a-=h,a+=o,h=o}return m&&m.onRayMarchEnd&&f&&m.onRayMarchEnd(f),a}}const Ht=100,F=10,Ot=.001;class Yt extends ${overshootFactor;constructor(t=1.2){super(),this.overshootFactor=t}getMaxDistance(){return F}rayMarch(t,e,i,s,n,c){let a=0,o=0,h=0;const m=t.getAccelerationStructure();let f=null;if(m&&m.onRayMarchStart&&(f=m.onRayMarchStart({rayOrigin:e,rayDirection:i,currentDistance:a,maxDistance:F}),f&&f.data&&f.data.terminate))return F;const u=b();for(let x=0;x<Ht;x++){if(k(u,e,i,a),m&&m.onRayMarchStep&&f){const y=m.onRayMarchStep({rayOrigin:e,rayDirection:i,currentDistance:a,maxDistance:F},f);if(y===-1)return F;if(y>0){if(a+=y,a>F)break;o=0,h=0;continue}}const p=this.getSceneDistance(t,u,s,n);if(c[s]+=1,p<Ot||a>F)break;if(x===0||o===0){const y=p;a+=y,o=p,h=y;continue}if(h<=o+p){const y=p*this.overshootFactor;a+=y,o=p,h=y;continue}const S=a-h;a=S+o,k(u,e,i,a);const D=this.getSceneDistance(t,u,s,n);if(c[s]+=1,o+p+D>=h){a=S+h+p,o=p,h=p;continue}o=D,h=D,a+=D}return m&&m.onRayMarchEnd&&f&&m.onRayMarchEnd(f),a}}self.onmessage=r=>{const{width:t,height:e,time:i,yStart:s,yEnd:n,camera:c,algorithm:a,scenePresetIndex:o,accelerationStructure:h,overshootFactor:m,stepSize:f}=r.data,u=new It(h);u.loadPreset(o),u.camera.setAngles(c.pitch,c.yaw);const x=Math.max(0,n-s),p=new Uint8ClampedArray(t*x),v=new Uint8ClampedArray(t*x*3),S=new Uint16Array(t*x),D=new Uint16Array(t*x);let y;switch(a){case"sphere-tracer":y=new et;break;case"fixed-step":y=new jt(f);break;case"adaptive-step":y=new Xt;break;case"adaptive-step-v2":y=new Vt(m);break;case"adaptive-step-v3":y=new Yt(m);break;default:y=new et}y.runRaymarcher(u,p,v,S,D,t,e,i,s,n);const T={yStart:s,yEnd:n,depth:p,normal:v,sdfEval:S,iters:D};self.postMessage(T,[p.buffer,v.buffer,S.buffer,D.buffer])}})();
