(function(){"use strict";var C=typeof Float32Array<"u"?Float32Array:Array;function Z(){var e=new C(9);return C!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function F(e,r){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[4],e[4]=r[5],e[5]=r[6],e[6]=r[8],e[7]=r[9],e[8]=r[10],e}function R(){var e=new C(16);return C!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function K(e,r){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],e}function Q(e,r){var t=r[0],s=r[1],n=r[2],i=r[3],a=r[4],c=r[5],h=r[6],o=r[7],m=r[8],f=r[9],d=r[10],v=r[11],x=r[12],P=r[13],S=r[14],y=r[15],g=t*c-s*a,z=t*h-n*a,A=t*o-i*a,b=s*h-n*c,w=s*o-i*c,M=n*o-i*h,D=m*P-f*x,N=m*S-d*x,u=m*y-v*x,O=f*S-d*P,X=f*y-v*P,L=d*y-v*S,T=g*L-z*X+A*O+b*u-w*N+M*D;return T?(T=1/T,e[0]=(c*L-h*X+o*O)*T,e[1]=(n*X-s*L-i*O)*T,e[2]=(P*M-S*w+y*b)*T,e[3]=(d*w-f*M-v*b)*T,e[4]=(h*u-a*L-o*N)*T,e[5]=(t*L-n*u+i*N)*T,e[6]=(S*A-x*M-y*z)*T,e[7]=(m*M-d*A+v*z)*T,e[8]=(a*X-c*u+o*D)*T,e[9]=(s*u-t*X-i*D)*T,e[10]=(x*w-P*A+y*g)*T,e[11]=(f*A-m*w-v*g)*T,e[12]=(c*N-a*O-h*D)*T,e[13]=(t*O-s*N+n*D)*T,e[14]=(P*z-x*b-S*g)*T,e[15]=(m*b-f*z+d*g)*T,e):null}function _(e,r,t){var s=t[0],n=t[1],i=t[2],a,c,h,o,m,f,d,v,x,P,S,y;return r===e?(e[12]=r[0]*s+r[4]*n+r[8]*i+r[12],e[13]=r[1]*s+r[5]*n+r[9]*i+r[13],e[14]=r[2]*s+r[6]*n+r[10]*i+r[14],e[15]=r[3]*s+r[7]*n+r[11]*i+r[15]):(a=r[0],c=r[1],h=r[2],o=r[3],m=r[4],f=r[5],d=r[6],v=r[7],x=r[8],P=r[9],S=r[10],y=r[11],e[0]=a,e[1]=c,e[2]=h,e[3]=o,e[4]=m,e[5]=f,e[6]=d,e[7]=v,e[8]=x,e[9]=P,e[10]=S,e[11]=y,e[12]=a*s+m*n+x*i+r[12],e[13]=c*s+f*n+P*i+r[13],e[14]=h*s+d*n+S*i+r[14],e[15]=o*s+v*n+y*i+r[15]),e}function rr(e,r,t){var s=Math.sin(t),n=Math.cos(t),i=r[4],a=r[5],c=r[6],h=r[7],o=r[8],m=r[9],f=r[10],d=r[11];return r!==e&&(e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15]),e[4]=i*n+o*s,e[5]=a*n+m*s,e[6]=c*n+f*s,e[7]=h*n+d*s,e[8]=o*n-i*s,e[9]=m*n-a*s,e[10]=f*n-c*s,e[11]=d*n-h*s,e}function er(e,r,t){var s=Math.sin(t),n=Math.cos(t),i=r[0],a=r[1],c=r[2],h=r[3],o=r[8],m=r[9],f=r[10],d=r[11];return r!==e&&(e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15]),e[0]=i*n-o*s,e[1]=a*n-m*s,e[2]=c*n-f*s,e[3]=h*n-d*s,e[8]=i*s+o*n,e[9]=a*s+m*n,e[10]=c*s+f*n,e[11]=h*s+d*n,e}function Y(e,r,t,s){var n=r[0],i=r[1],a=r[2],c=r[3],h=n+n,o=i+i,m=a+a,f=n*h,d=n*o,v=n*m,x=i*o,P=i*m,S=a*m,y=c*h,g=c*o,z=c*m,A=s[0],b=s[1],w=s[2];return e[0]=(1-(x+S))*A,e[1]=(d+z)*A,e[2]=(v-g)*A,e[3]=0,e[4]=(d-z)*b,e[5]=(1-(f+S))*b,e[6]=(P+y)*b,e[7]=0,e[8]=(v+g)*w,e[9]=(P-y)*w,e[10]=(1-(f+x))*w,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function I(){var e=new C(3);return C!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function k(e){var r=new C(3);return r[0]=e[0],r[1]=e[1],r[2]=e[2],r}function $(e){var r=e[0],t=e[1],s=e[2];return Math.sqrt(r*r+t*t+s*s)}function p(e,r,t){var s=new C(3);return s[0]=e,s[1]=r,s[2]=t,s}function q(e,r,t,s){return e[0]=r[0]+t[0]*s,e[1]=r[1]+t[1]*s,e[2]=r[2]+t[2]*s,e}function E(e,r){var t=r[0],s=r[1],n=r[2],i=t*t+s*s+n*n;return i>0&&(i=1/Math.sqrt(i)),e[0]=r[0]*i,e[1]=r[1]*i,e[2]=r[2]*i,e}function tr(e,r,t){var s=r[0],n=r[1],i=r[2],a=t[3]*s+t[7]*n+t[11]*i+t[15];return a=a||1,e[0]=(t[0]*s+t[4]*n+t[8]*i+t[12])/a,e[1]=(t[1]*s+t[5]*n+t[9]*i+t[13])/a,e[2]=(t[2]*s+t[6]*n+t[10]*i+t[14])/a,e}function G(e,r,t){var s=r[0],n=r[1],i=r[2];return e[0]=s*t[0]+n*t[3]+i*t[6],e[1]=s*t[1]+n*t[4]+i*t[7],e[2]=s*t[2]+n*t[5]+i*t[8],e}(function(){var e=I();return function(r,t,s,n,i,a){var c,h;for(t||(t=3),s||(s=0),n?h=Math.min(n*t+s,r.length):h=r.length,c=s;c<h;c+=t)e[0]=r[c],e[1]=r[c+1],e[2]=r[c+2],i(e,e,a),r[c]=e[0],r[c+1]=e[1],r[c+2]=e[2];return r}})();class sr{orbitCentre;cameraDistance;cameraTransform;pitch;yaw;constructor(){this.orbitCentre=R(),this.cameraDistance=3,this.pitch=0,this.yaw=0,this.cameraTransform=R(),this.updateCameraTransform()}rotateCamera(r,t){this.pitch=Math.min(Math.max(this.pitch+r,-Math.PI/2),Math.PI/2),this.yaw+=t,this.updateCameraTransform()}getAngles(){return[this.pitch,this.yaw]}getRotationMatrix(r){return r[0]=this.cameraTransform[0],r[1]=this.cameraTransform[1],r[2]=this.cameraTransform[2],r[3]=0,r[4]=this.cameraTransform[4],r[5]=this.cameraTransform[5],r[6]=this.cameraTransform[6],r[7]=0,r[8]=this.cameraTransform[8],r[9]=this.cameraTransform[9],r[10]=this.cameraTransform[10],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}getCameraPosition(r){return r[0]=this.cameraTransform[12],r[1]=this.cameraTransform[13],r[2]=this.cameraTransform[14],r}getCameraMatrix(r){return K(r,this.cameraTransform),r}setAngles(r,t){this.pitch=Math.min(Math.max(r,-Math.PI/2),Math.PI/2),this.yaw=t,this.updateCameraTransform()}getPosition(r){return r[0]=this.cameraTransform[12],r[1]=this.cameraTransform[13],r[2]=this.cameraTransform[14],r}transformDirection(r,t){const s=this.cameraTransform,n=t[0],i=t[1],a=t[2];return r[0]=s[0]*n+s[4]*i+s[8]*a,r[1]=s[1]*n+s[5]*i+s[9]*a,r[2]=s[2]*n+s[6]*i+s[10]*a,r}updateCameraTransform(){const r=R();er(r,R(),this.yaw),rr(this.orbitCentre,r,this.pitch),_(this.cameraTransform,this.orbitCentre,p(0,0,Math.abs(this.cameraDistance)))}}class U{transform;constructor(r){this.transform=r}getWorldPosition(){const r=R();return Q(r,this.transform),p(r[12],r[13],r[14])}sdf(r){const t=I();return tr(t,r,this.transform),this.localSdf(t)}}class nr extends U{radius;constructor(r,t){super(r),this.radius=t}localSdf(r){return $(r)-this.radius}getLocalBoundingRadius(){return this.radius}}class ir extends U{halfSize;constructor(r,t){super(r),this.halfSize=k(t)}localSdf(r){const t=p(Math.abs(r[0])-this.halfSize[0],Math.abs(r[1])-this.halfSize[1],Math.abs(r[2])-this.halfSize[2]),s=p(Math.max(t[0],0),Math.max(t[1],0),Math.max(t[2],0)),n=$(s),i=Math.min(Math.max(t[0],Math.max(t[1],t[2])),0);return n+i}getLocalBoundingRadius(){return $(this.halfSize)}}class ar extends U{majorRadius;minorRadius;constructor(r,t,s){super(r),this.majorRadius=t,this.minorRadius=s}localSdf(r){const t=r[0],s=r[1],n=r[2],i=Math.sqrt(t*t+n*n)-this.majorRadius,a=s;return Math.sqrt(i*i+a*a)-this.minorRadius}getLocalBoundingRadius(){return this.majorRadius+this.minorRadius}}class l{static createSphere(r,t,s,n){const i=R();return Y(i,[0,0,0,1],[r,t,s],[1,1,1]),new nr(i,n)}static createBox(r,t,s,n){const i=R();return Y(i,[0,0,0,1],[r,t,s],[1,1,1]),new ir(i,n)}static createTorus(r,t,s,n){const i=R();return Y(i,[0,0,0,1],[r,t,s],[1,1,1]),new ar(i,n,n/4)}static presets=[{name:"Sphere",objects:[l.createSphere(0,0,0,1.5)]},{name:"Grid of Spheres",objects:[l.createSphere(-1,-1,0,.3),l.createSphere(0,-1,0,.3),l.createSphere(1,-1,0,.3),l.createSphere(-1,0,0,.3),l.createSphere(0,0,0,.3),l.createSphere(1,0,0,.3),l.createSphere(-1,1,0,.3),l.createSphere(0,1,0,.3),l.createSphere(1,1,0,.3)]},{name:"Atom",objects:[l.createSphere(0,0,0,.5),l.createSphere(1.2,0,0,.3),l.createSphere(-1.2,0,0,.3),l.createSphere(0,1.2,0,.3),l.createSphere(0,-1.2,0,.3),l.createSphere(0,0,1.2,.3),l.createSphere(0,0,-1.2,.3)]},{name:"Random Spheres",objects:[l.createSphere(.8,-.3,.2,.4),l.createSphere(-.5,.9,-.1,.5),l.createSphere(.2,.1,.8,.3),l.createSphere(-.9,-.4,-.6,.6),l.createSphere(.4,-.8,.5,.35),l.createSphere(-.2,.6,-.9,.4),l.createSphere(.7,.3,-.4,.25)]},{name:"Cube",objects:[l.createBox(0,0,0,p(1,1,1))]},{name:"Sphere and Cube",objects:[l.createSphere(-.7,0,0,.5),l.createBox(1,0,0,p(.5,.5,.5))]},{name:"Pyramid of Boxes",objects:[l.createBox(0,-.5,0,p(.9,.25,.9)),l.createBox(0,0,0,p(.6,.25,.6)),l.createBox(0,.5,0,p(.3,.25,.3))]},{name:"Torus",objects:[l.createTorus(0,0,0,1.3)]},{name:"Dense Sphere Grid",objects:(()=>{const r=[];for(let i=0;i<5;i++)for(let a=0;a<5;a++)for(let c=0;c<5;c++)r.push(l.createSphere(i*.6-1.2,a*.6-1.2,c*.6-1.2,.15));return r})()}];static getPreset(r){return this.presets[Math.max(0,Math.min(r,this.presets.length-1))]}static getPresetCount(){return this.presets.length}static populateSceneDropdown(r,t=0){r.innerHTML="";for(let s=0;s<this.presets.length;s++){const n=this.getPreset(s),i=document.createElement("option");i.value=s.toString(),i.textContent=n.name,i.selected=s===t,r.appendChild(i)}}}class j{min;max;constructor(r,t){this.min=k(r),this.max=k(t)}contains(r){return r[0]>=this.min[0]&&r[0]<=this.max[0]&&r[1]>=this.min[1]&&r[1]<=this.max[1]&&r[2]>=this.min[2]&&r[2]<=this.max[2]}intersects(r){return this.min[0]<=r.max[0]&&this.max[0]>=r.min[0]&&this.min[1]<=r.max[1]&&this.max[1]>=r.min[1]&&this.min[2]<=r.max[2]&&this.max[2]>=r.min[2]}center(){return p((this.min[0]+this.max[0])/2,(this.min[1]+this.max[1])/2,(this.min[2]+this.max[2])/2)}static fromPrimitive(r){const t=r.getWorldPosition(),n=r.getLocalBoundingRadius()*1.1;return new j(p(t[0]-n,t[1]-n,t[2]-n),p(t[0]+n,t[1]+n,t[2]+n))}}class H{bounds;primitives;children;constructor(r,t){this.bounds=r,this.primitives=t,this.children=null}isLeaf(){return this.children===null}}class cr{root;maxDepth;maxPrimitivesPerNode;constructor(r,t,s=6,n=4){this.maxDepth=s,this.maxPrimitivesPerNode=n,this.root=this.buildNode(r,t,0)}buildNode(r,t,s){const n=new H(t,[]);if(s>=this.maxDepth||r.length<=this.maxPrimitivesPerNode)return n.primitives=r,n;const i=t.center(),a=[];for(let h=0;h<2;h++)for(let o=0;o<2;o++)for(let m=0;m<2;m++){const f=m===0?t.min[0]:i[0],d=m===0?i[0]:t.max[0],v=o===0?t.min[1]:i[1],x=o===0?i[1]:t.max[1],P=h===0?t.min[2]:i[2],S=h===0?i[2]:t.max[2];a.push(new j(p(f,v,P),p(d,x,S)))}const c=Array.from({length:8},()=>[]);for(const h of r){const o=j.fromPrimitive(h);for(let m=0;m<8;m++)a[m].intersects(o)&&c[m].push(h)}n.children=[];for(let h=0;h<8;h++)c[h].length>0?n.children.push(this.buildNode(c[h],a[h],s+1)):n.children.push(new H(a[h],[]));return n}getPrimitivesAt(r){const t=new Set;return this.queryNode(this.root,r,t),Array.from(t)}queryNode(r,t,s){if(r.bounds.contains(t)){if(r.isLeaf()){for(const n of r.primitives)s.add(n);return}if(r.children)for(const n of r.children)this.queryNode(n,t,s)}}}class hr{objectSDFs;camera;octree=null;accelerationStructure="None";currentPresetIndex=0;constructor(r="None"){this.camera=new sr,this.objectSDFs=new Array,this.accelerationStructure=r,this.loadPreset(0)}loadPreset(r){this.currentPresetIndex=Math.max(0,Math.min(r,l.getPresetCount()-1));const t=l.getPreset(this.currentPresetIndex);this.objectSDFs=[...t.objects],this.accelerationStructure=="Octree"?this.buildOctree():this.octree=null}buildOctree(){const r=this.calculateSceneBounds();this.octree=new cr(this.objectSDFs,r)}calculateSceneBounds(){const r=p(-10,-10,-10),t=p(10,10,10);return new j(r,t)}nextPreset(){this.loadPreset(Math.min(this.currentPresetIndex+1,l.getPresetCount()))}previousPreset(){this.loadPreset(Math.max(this.currentPresetIndex-1,0))}getCurrentPresetInfo(){const r=l.getPreset(this.currentPresetIndex);return{index:this.currentPresetIndex,name:r.name,total:l.getPresetCount()}}getDistance(r,t){let n=.5;if(this.accelerationStructure==="Octree"&&this.octree){const i=this.octree.getPrimitivesAt(r);for(const a of i)t&&t.count++,n=Math.min(a.sdf(r),n)}else for(const i of this.objectSDFs)t&&t.count++,n=Math.min(i.sdf(r),n);return n}}class V{}const mr=100,B=10,or=.001;class J extends V{runRaymarcher(r,t,s,n,i,a,c,h,o=0,m=c){const f=r.camera.getRotationMatrix(R()),d=Z();F(d,f);const v=I();r.camera.getPosition(v);for(let x=o;x<m;x++){const P=x-o,S=(x/c-.5)*2;for(let y=0;y<a;y++){const g=P*a+y,z=g*3;n[g]=0,i[g]=0;const A=(y/a-.5)*2,b=p(A,S,-1);G(b,b,d),E(b,b);const w=this.rayMarch(r,v,b,g,n,i),M=I();q(M,v,b,w);let D;w>=B?D=p(0,0,0):D=this.getNormal(r,M,g,n),s[z]=(D[0]+1)*.5*255,s[z+1]=(D[1]+1)*.5*255,s[z+2]=(D[2]+1)*.5*255,t[g]=w}}}getSceneDistance(r,t,s,n){const i={count:0},a=r.getDistance(t,i);return n[s]+=i.count,a}getNormal(r,t,s,n){let i=this.getSceneDistance(r,t,s,n);const a=[.01,0,0],c=I();return c[0]=i-this.getSceneDistance(r,p(t[0]-a[0],t[1],t[2]),s,n),c[1]=i-this.getSceneDistance(r,p(t[0],t[1]-a[0],t[2]),s,n),c[2]=i-this.getSceneDistance(r,p(t[0],t[1],t[2]-a[0]),s,n),E(c,c),c}rayMarch(r,t,s,n,i,a){let c=0;for(let h=0;h<mr;h++){const o=I();q(o,t,s,c);const m=this.getSceneDistance(r,o,n,i);if(c+=m,a[n]+=1,m<or||c>B)break}return c}}const lr=200,W=10,fr=.001,dr=.1;class xr extends V{runRaymarcher(r,t,s,n,i,a,c,h,o=0,m=c){const f=r.camera.getRotationMatrix(R()),d=Z();F(d,f);const v=I();r.camera.getPosition(v);for(let x=o;x<m;x++){const P=x-o,S=(x/c-.5)*2;for(let y=0;y<a;y++){const g=P*a+y,z=g*3;n[g]=0,i[g]=0;const A=(y/a-.5)*2,b=p(A,S,-1);G(b,b,d),E(b,b);const w=this.fixedStepMarch(r,v,b,g,n,i),M=I();q(M,v,b,w);let D;w>=W?D=p(0,0,0):D=this.getNormal(r,M,g,n),s[z]=(D[0]+1)*.5*255,s[z+1]=(D[1]+1)*.5*255,s[z+2]=(D[2]+1)*.5*255,t[g]=w}}}getSceneDistance(r,t,s,n){const i={count:0},a=r.getDistance(t,i);return n[s]+=i.count,a}getNormal(r,t,s,n){let i=this.getSceneDistance(r,t,s,n);const a=[.01,0,0],c=I();return c[0]=i-this.getSceneDistance(r,p(t[0]-a[0],t[1],t[2]),s,n),c[1]=i-this.getSceneDistance(r,p(t[0],t[1]-a[0],t[2]),s,n),c[2]=i-this.getSceneDistance(r,p(t[0],t[1],t[2]-a[0]),s,n),E(c,c),c}fixedStepMarch(r,t,s,n,i,a){let c=0,h=!1;for(let o=0;o<lr;o++){const m=I();q(m,t,s,c);const f=this.getSceneDistance(r,m,n,i);if(a[n]+=1,f<fr){h=!0;break}if(c+=dr,c>W)break}return h?c:W}}self.onmessage=e=>{const{width:r,height:t,time:s,yStart:n,yEnd:i,camera:a,algorithm:c,scenePresetIndex:h,accelerationStructure:o}=e.data,m=new hr(o);m.loadPreset(h),m.camera.setAngles(a.pitch,a.yaw);const f=Math.max(0,i-n),d=new Uint8ClampedArray(r*f),v=new Uint8ClampedArray(r*f*3),x=new Uint16Array(r*f),P=new Uint16Array(r*f);let S;switch(c){case"sphere-tracer":S=new J;break;case"fixed-step":S=new xr;break;default:S=new J}S.runRaymarcher(m,d,v,x,P,r,t,s,n,i);const y={yStart:n,yEnd:i,depth:d,normal:v,sdfEval:x,iters:P};self.postMessage(y,[d.buffer,v.buffer,x.buffer,P.buffer])}})();
