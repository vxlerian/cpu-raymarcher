(function(){"use strict";var X=typeof Float32Array<"u"?Float32Array:Array;function A(){var r=new X(16);return X!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function O(r,e){var t=e[0],s=e[1],a=e[2],n=e[3],c=e[4],i=e[5],f=e[6],m=e[7],o=e[8],S=e[9],h=e[10],g=e[11],M=e[12],p=e[13],P=e[14],T=e[15],b=t*i-s*c,x=t*f-a*c,v=t*m-n*c,l=s*f-a*i,y=s*m-n*i,j=a*m-n*f,I=o*p-S*M,F=o*P-h*M,C=o*T-g*M,N=S*P-h*p,R=S*T-g*p,q=h*T-g*P,w=b*q-x*R+v*N+l*C-y*F+j*I;return w?(w=1/w,r[0]=(i*q-f*R+m*N)*w,r[1]=(a*R-s*q-n*N)*w,r[2]=(p*j-P*y+T*l)*w,r[3]=(h*y-S*j-g*l)*w,r[4]=(f*C-c*q-m*F)*w,r[5]=(t*q-a*C+n*F)*w,r[6]=(P*v-M*j-T*x)*w,r[7]=(o*j-h*v+g*x)*w,r[8]=(c*R-i*C+m*I)*w,r[9]=(s*C-t*R-n*I)*w,r[10]=(M*y-p*v+T*b)*w,r[11]=(S*v-o*y-g*b)*w,r[12]=(i*F-c*N-f*I)*w,r[13]=(t*N-s*F+a*I)*w,r[14]=(p*x-M*l-P*b)*w,r[15]=(o*l-S*x+h*b)*w,r):null}function J(r,e,t){var s=e[0],a=e[1],n=e[2],c=e[3],i=e[4],f=e[5],m=e[6],o=e[7],S=e[8],h=e[9],g=e[10],M=e[11],p=e[12],P=e[13],T=e[14],b=e[15],x=t[0],v=t[1],l=t[2],y=t[3];return r[0]=x*s+v*i+l*S+y*p,r[1]=x*a+v*f+l*h+y*P,r[2]=x*n+v*m+l*g+y*T,r[3]=x*c+v*o+l*M+y*b,x=t[4],v=t[5],l=t[6],y=t[7],r[4]=x*s+v*i+l*S+y*p,r[5]=x*a+v*f+l*h+y*P,r[6]=x*n+v*m+l*g+y*T,r[7]=x*c+v*o+l*M+y*b,x=t[8],v=t[9],l=t[10],y=t[11],r[8]=x*s+v*i+l*S+y*p,r[9]=x*a+v*f+l*h+y*P,r[10]=x*n+v*m+l*g+y*T,r[11]=x*c+v*o+l*M+y*b,x=t[12],v=t[13],l=t[14],y=t[15],r[12]=x*s+v*i+l*S+y*p,r[13]=x*a+v*f+l*h+y*P,r[14]=x*n+v*m+l*g+y*T,r[15]=x*c+v*o+l*M+y*b,r}function K(r,e,t){var s=t[0],a=t[1],n=t[2],c,i,f,m,o,S,h,g,M,p,P,T;return e===r?(r[12]=e[0]*s+e[4]*a+e[8]*n+e[12],r[13]=e[1]*s+e[5]*a+e[9]*n+e[13],r[14]=e[2]*s+e[6]*a+e[10]*n+e[14],r[15]=e[3]*s+e[7]*a+e[11]*n+e[15]):(c=e[0],i=e[1],f=e[2],m=e[3],o=e[4],S=e[5],h=e[6],g=e[7],M=e[8],p=e[9],P=e[10],T=e[11],r[0]=c,r[1]=i,r[2]=f,r[3]=m,r[4]=o,r[5]=S,r[6]=h,r[7]=g,r[8]=M,r[9]=p,r[10]=P,r[11]=T,r[12]=c*s+o*a+M*n+e[12],r[13]=i*s+S*a+p*n+e[13],r[14]=f*s+h*a+P*n+e[14],r[15]=m*s+g*a+T*n+e[15]),r}function Q(r,e,t){var s=Math.sin(t),a=Math.cos(t),n=e[4],c=e[5],i=e[6],f=e[7],m=e[8],o=e[9],S=e[10],h=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=n*a+m*s,r[5]=c*a+o*s,r[6]=i*a+S*s,r[7]=f*a+h*s,r[8]=m*a-n*s,r[9]=o*a-c*s,r[10]=S*a-i*s,r[11]=h*a-f*s,r}function B(r,e,t){var s=Math.sin(t),a=Math.cos(t),n=e[0],c=e[1],i=e[2],f=e[3],m=e[8],o=e[9],S=e[10],h=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=n*a-m*s,r[1]=c*a-o*s,r[2]=i*a-S*s,r[3]=f*a-h*s,r[8]=n*s+m*a,r[9]=c*s+o*a,r[10]=i*s+S*a,r[11]=f*s+h*a,r}function U(r,e,t,s){var a=e[0],n=e[1],c=e[2],i=e[3],f=a+a,m=n+n,o=c+c,S=a*f,h=a*m,g=a*o,M=n*m,p=n*o,P=c*o,T=i*f,b=i*m,x=i*o,v=s[0],l=s[1],y=s[2];return r[0]=(1-(M+P))*v,r[1]=(h+x)*v,r[2]=(g-b)*v,r[3]=0,r[4]=(h-x)*l,r[5]=(1-(S+P))*l,r[6]=(p+T)*l,r[7]=0,r[8]=(g+b)*y,r[9]=(p-T)*y,r[10]=(1-(S+M))*y,r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r}function z(){var r=new X(3);return X!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function u(r){var e=new X(3);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e}function $(r){var e=r[0],t=r[1],s=r[2];return Math.sqrt(e*e+t*t+s*s)}function D(r,e,t){var s=new X(3);return s[0]=r,s[1]=e,s[2]=t,s}function _(r,e,t,s){return r[0]=e,r[1]=t,r[2]=s,r}function H(r,e,t){return r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r}function k(r,e){var t=e[0],s=e[1],a=e[2],n=t*t+s*s+a*a;return n>0&&(n=1/Math.sqrt(n)),r[0]=e[0]*n,r[1]=e[1]*n,r[2]=e[2]*n,r}function ee(r,e,t){var s=e[0],a=e[1],n=e[2],c=t[3]*s+t[7]*a+t[11]*n+t[15];return c=c||1,r[0]=(t[0]*s+t[4]*a+t[8]*n+t[12])/c,r[1]=(t[1]*s+t[5]*a+t[9]*n+t[13])/c,r[2]=(t[2]*s+t[6]*a+t[10]*n+t[14])/c,r}(function(){var r=z();return function(e,t,s,a,n,c){var i,f;for(t||(t=3),s||(s=0),a?f=Math.min(a*t+s,e.length):f=e.length,i=s;i<f;i+=t)r[0]=e[i],r[1]=e[i+1],r[2]=e[i+2],n(r,r,c),e[i]=r[0],e[i+1]=r[1],e[i+2]=r[2];return e}})();class re{constructor(){this.orbitCentre=A(),this.cameraDistance=5,this.pitch=0,this.yaw=0,this.cameraTransform=A(),this.updateCameraTransform()}rotateCamera(e,t){this.pitch=Math.min(Math.max(this.pitch+e,-Math.PI/2),Math.PI/2),this.yaw+=t,this.updateCameraTransform()}getAngles(){return[this.pitch,this.yaw]}setAngles(e,t){this.pitch=Math.min(Math.max(e,-Math.PI/2),Math.PI/2),this.yaw=t,this.updateCameraTransform()}getPosition(e){return e[0]=this.cameraTransform[12],e[1]=this.cameraTransform[13],e[2]=this.cameraTransform[14],e}transformDirection(e,t){const s=this.cameraTransform,a=t[0],n=t[1],c=t[2];return e[0]=s[0]*a+s[4]*n+s[8]*c,e[1]=s[1]*a+s[5]*n+s[9]*c,e[2]=s[2]*a+s[6]*n+s[10]*c,e}updateCameraTransform(){const e=A();B(e,A(),this.yaw),Q(this.orbitCentre,e,this.pitch),K(this.cameraTransform,this.orbitCentre,D(0,0,Math.abs(this.cameraDistance)))}}class L{constructor(e){this.transform=e,this.invSceneTransform=A()}updateInverseSceneTransform(e){const t=A();O(t,e),J(this.invSceneTransform,t,this.transform),O(this.invSceneTransform,this.invSceneTransform)}sdf(e){const t=z();return ee(t,e,this.invSceneTransform),this.localSdf(t)}}class te extends L{constructor(e,t){super(e),this.radius=t}localSdf(e){return $(e)-this.radius}}class se extends L{constructor(e,t){super(e),this.halfSize=u(t)}localSdf(e){const t=D(Math.abs(e[0])-this.halfSize[0],Math.abs(e[1])-this.halfSize[1],Math.abs(e[2])-this.halfSize[2]),s=D(Math.max(t[0],0),Math.max(t[1],0),Math.max(t[2],0)),a=$(s),n=Math.min(Math.max(t[0],Math.max(t[1],t[2])),0);return a+n}}class ae extends L{constructor(e,t,s){super(e),this.majorRadius=t,this.minorRadius=s}localSdf(e){const t=e[0],s=e[1],a=e[2],n=Math.sqrt(t*t+a*a)-this.majorRadius,c=s;return Math.sqrt(n*n+c*c)-this.minorRadius}}const d=class d{static createSphere(e,t,s,a){const n=A();return U(n,[0,0,0,1],[e,t,s],[1,1,1]),new te(n,a)}static createBox(e,t,s,a){const n=A();return U(n,[0,0,0,1],[e,t,s],[1,1,1]),new se(n,a)}static createTorus(e,t,s,a){const n=A();return U(n,[0,0,0,1],[e,t,s],[1,1,1]),new ae(n,a,a/4)}static getPreset(e){return this.presets[Math.max(0,Math.min(e,this.presets.length-1))]}static getPresetCount(){return this.presets.length}static populateSceneDropdown(e,t=0){e.innerHTML="";for(let s=0;s<this.presets.length;s++){const a=this.getPreset(s),n=document.createElement("option");n.value=s.toString(),n.textContent=a.name,n.selected=s===t,e.appendChild(n)}}};d.presets=[{name:"Single sphere",objects:[d.createSphere(0,0,0,1.5)]},{name:"Grid of spheres",objects:[d.createSphere(-1,-1,0,.3),d.createSphere(0,-1,0,.3),d.createSphere(1,-1,0,.3),d.createSphere(-1,0,0,.3),d.createSphere(0,0,0,.3),d.createSphere(1,0,0,.3),d.createSphere(-1,1,0,.3),d.createSphere(0,1,0,.3),d.createSphere(1,1,0,.3)]},{name:"Atom",objects:[d.createSphere(0,0,0,.5),d.createSphere(1.2,0,0,.3),d.createSphere(-1.2,0,0,.3),d.createSphere(0,1.2,0,.3),d.createSphere(0,-1.2,0,.3),d.createSphere(0,0,1.2,.3),d.createSphere(0,0,-1.2,.3)]},{name:"Random spheres",objects:[d.createSphere(.8,-.3,.2,.4),d.createSphere(-.5,.9,-.1,.5),d.createSphere(.2,.1,.8,.3),d.createSphere(-.9,-.4,-.6,.6),d.createSphere(.4,-.8,.5,.35),d.createSphere(-.2,.6,-.9,.4),d.createSphere(.7,.3,-.4,.25)]},{name:"Cube",objects:[d.createBox(0,0,0,D(1,1,1))]},{name:"Sphere and Cube",objects:[d.createSphere(-.7,0,0,.5),d.createBox(1,0,0,D(.5,.5,.5))]},{name:"Pyramid of Boxes",objects:[d.createBox(0,.5,0,D(.9,.25,.9)),d.createBox(0,0,0,D(.6,.25,.6)),d.createBox(0,-.5,0,D(.3,.25,.3))]},{name:"Torus",objects:[d.createTorus(0,0,0,1.3)]}];let E=d;class ne{constructor(){this.currentPresetIndex=0,this.camera=new re,this.objectSDFs=new Array,this.loadPreset(0)}loadPreset(e){this.currentPresetIndex=Math.max(0,Math.min(e,E.getPresetCount()-1));const t=E.getPreset(this.currentPresetIndex);this.objectSDFs=[...t.objects]}nextPreset(){this.loadPreset(Math.min(this.currentPresetIndex+1,E.getPresetCount()))}previousPreset(){this.loadPreset(Math.max(this.currentPresetIndex-1,0))}getCurrentPresetInfo(){const e=E.getPreset(this.currentPresetIndex);return{index:this.currentPresetIndex,name:e.name,total:E.getPresetCount()}}updateInverseSceneTransforms(){for(const e of this.objectSDFs)e.updateInverseSceneTransform(this.camera.cameraTransform)}}class G{}const ce=100,V=500,ie=.001;class W extends G{runRaymarcher(e,t,s,a,n,c,i,f,m=0,o=i){for(let S=m;S<o;S++){const h=S-m,g=S/i-.5;for(let M=0;M<c;M++){const p=h*c+M,P=p*3;a[p]=0,n[p]=0;const T=z(),b=M/c-.5;k(T,D(b,g,-1));const x=this.rayMarch(e,T,p,a,n),v=z();H(v,T,x);const l=this.getNormal(e,v,p,a);s[P]=(l[0]+1)*.5*255,s[P+1]=(l[1]+1)*.5*255,s[P+2]=(l[2]+1)*.5*255,t[p]=x}}}getSceneDistance(e,t,s,a){a[s]+=1;let n=V;for(const c of e.objectSDFs)n=Math.min(c.sdf(t),n);return n}getNormal(e,t,s,a){let n=this.getSceneDistance(e,t,s,a);const c=[.01,0,0],i=z();return i[0]=n-this.getSceneDistance(e,D(t[0]-c[0],t[1],t[2]),s,a),i[1]=n-this.getSceneDistance(e,D(t[0],t[1]-c[0],t[2]),s,a),i[2]=n-this.getSceneDistance(e,D(t[0],t[1],t[2]-c[0]),s,a),k(i,i),i}rayMarch(e,t,s,a,n){let c=0;for(let i=0;i<ce;i++){const f=D(0,0,0);H(f,t,c);let m=this.getSceneDistance(e,f,s,a);if(c+=m,c>V||m<ie)break;n[s]+=1}return Math.min(c,255)}}const Y=10,Z=.2,he=.01;class me extends G{runRaymarcher(e,t,s,a,n,c,i,f,m=0,o=i){const S=Math.ceil(Y/Z),h=z(),g=z(),M=z();for(let p=m;p<o;p++){const P=p-m,T=p/i-.5;for(let b=0;b<c;b++){const x=b/c-.5;_(h,x,T,-1),k(h,h),e.camera.transformDirection(h,h),k(h,h),e.camera.getPosition(M);let v=0,l=0,y=0,j=!1;for(;l<S&&v<=Y;l++,v+=Z){g[0]=M[0]+h[0]*v,g[1]=M[1]+h[1]*v,g[2]=M[2]+h[2]*v;let C=Y;for(const N of e.objectSDFs){const R=N.sdf(g);R<C&&(C=R),y++}if(C<he){j=!0;break}}const I=P*c+b,F=Math.min(v,Y);if(t[I]=Math.round(255*F/Y),n[I]=l,a[I]=y,j){const C=this.getNormal(e,g);s[I*3+0]=Math.round((C[0]*.5+.5)*255),s[I*3+1]=Math.round((C[1]*.5+.5)*255),s[I*3+2]=Math.round((C[2]*.5+.5)*255)}else s[I*3+0]=127,s[I*3+1]=127,s[I*3+2]=255}}}getSceneDistance(e,t){let s=Y;for(const a of e.objectSDFs)s=Math.min(a.sdf(t),s);return s}getNormal(e,t){let s=this.getSceneDistance(e,t);const a=[.01,0,0],n=z();return n[0]=s-this.getSceneDistance(e,D(t[0]-a[0],t[1],t[2])),n[1]=s-this.getSceneDistance(e,D(t[0],t[1]-a[0],t[2])),n[2]=s-this.getSceneDistance(e,D(t[0],t[1],t[2]-a[0])),k(n,n),n}}self.onmessage=r=>{const{width:e,height:t,time:s,yStart:a,yEnd:n,camera:c,algorithm:i,scenePresetIndex:f}=r.data,m=new ne;m.loadPreset(f),m.camera.setAngles(c.pitch,c.yaw),m.updateInverseSceneTransforms();const o=Math.max(0,n-a),S=new Uint8ClampedArray(e*o),h=new Uint8ClampedArray(e*o*3),g=new Uint16Array(e*o),M=new Uint16Array(e*o);let p;switch(i){case"sphere-tracer":p=new W;break;case"fixed-step":p=new me;break;default:p=new W}p.runRaymarcher(m,S,h,g,M,e,t,s,a,n);const P={yStart:a,yEnd:n,depth:S,normal:h,sdfEval:g,iters:M};self.postMessage(P,[S.buffer,h.buffer,g.buffer,M.buffer])}})();
