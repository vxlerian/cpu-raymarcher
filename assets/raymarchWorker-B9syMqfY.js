(function(){"use strict";var A=typeof Float32Array<"u"?Float32Array:Array;function U(){var r=new A(9);return A!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function V(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[4],r[4]=t[5],r[5]=t[6],r[6]=t[8],r[7]=t[9],r[8]=t[10],r}function w(){var r=new A(16);return A!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function nt(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r}function N(r,t){var e=t[0],s=t[1],i=t[2],n=t[3],a=t[4],c=t[5],h=t[6],o=t[7],m=t[8],f=t[9],u=t[10],p=t[11],x=t[12],v=t[13],g=t[14],y=t[15],S=e*c-s*a,M=e*h-i*a,I=e*o-n*a,P=s*h-i*c,R=s*o-n*c,B=i*o-n*h,D=m*v-f*x,q=m*g-u*x,H=m*y-p*x,Y=f*g-u*v,$=f*y-p*v,O=u*y-p*g,T=S*O-M*$+I*Y+P*H-R*q+B*D;return T?(T=1/T,r[0]=(c*O-h*$+o*Y)*T,r[1]=(i*$-s*O-n*Y)*T,r[2]=(v*B-g*R+y*P)*T,r[3]=(u*R-f*B-p*P)*T,r[4]=(h*H-a*O-o*q)*T,r[5]=(e*O-i*H+n*q)*T,r[6]=(g*I-x*B-y*M)*T,r[7]=(m*B-u*I+p*M)*T,r[8]=(a*$-c*H+o*D)*T,r[9]=(s*H-e*$-n*D)*T,r[10]=(x*R-v*I+y*S)*T,r[11]=(f*I-m*R-p*S)*T,r[12]=(c*q-a*Y-h*D)*T,r[13]=(e*Y-s*q+i*D)*T,r[14]=(v*M-x*P-g*S)*T,r[15]=(m*P-f*M+u*S)*T,r):null}function at(r,t,e){var s=e[0],i=e[1],n=e[2],a,c,h,o,m,f,u,p,x,v,g,y;return t===r?(r[12]=t[0]*s+t[4]*i+t[8]*n+t[12],r[13]=t[1]*s+t[5]*i+t[9]*n+t[13],r[14]=t[2]*s+t[6]*i+t[10]*n+t[14],r[15]=t[3]*s+t[7]*i+t[11]*n+t[15]):(a=t[0],c=t[1],h=t[2],o=t[3],m=t[4],f=t[5],u=t[6],p=t[7],x=t[8],v=t[9],g=t[10],y=t[11],r[0]=a,r[1]=c,r[2]=h,r[3]=o,r[4]=m,r[5]=f,r[6]=u,r[7]=p,r[8]=x,r[9]=v,r[10]=g,r[11]=y,r[12]=a*s+m*i+x*n+t[12],r[13]=c*s+f*i+v*n+t[13],r[14]=h*s+u*i+g*n+t[14],r[15]=o*s+p*i+y*n+t[15]),r}function Q(r,t,e){var s=Math.sin(e),i=Math.cos(e),n=t[4],a=t[5],c=t[6],h=t[7],o=t[8],m=t[9],f=t[10],u=t[11];return t!==r&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[4]=n*i+o*s,r[5]=a*i+m*s,r[6]=c*i+f*s,r[7]=h*i+u*s,r[8]=o*i-n*s,r[9]=m*i-a*s,r[10]=f*i-c*s,r[11]=u*i-h*s,r}function _(r,t,e){var s=Math.sin(e),i=Math.cos(e),n=t[0],a=t[1],c=t[2],h=t[3],o=t[8],m=t[9],f=t[10],u=t[11];return t!==r&&(r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[0]=n*i-o*s,r[1]=a*i-m*s,r[2]=c*i-f*s,r[3]=h*i-u*s,r[8]=n*s+o*i,r[9]=a*s+m*i,r[10]=c*s+f*i,r[11]=h*s+u*i,r}function ct(r,t,e){var s=Math.sin(e),i=Math.cos(e),n=t[0],a=t[1],c=t[2],h=t[3],o=t[4],m=t[5],f=t[6],u=t[7];return t!==r&&(r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[0]=n*i+o*s,r[1]=a*i+m*s,r[2]=c*i+f*s,r[3]=h*i+u*s,r[4]=o*i-n*s,r[5]=m*i-a*s,r[6]=f*i-c*s,r[7]=u*i-h*s,r}function ht(r,t){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r}function ot(r,t,e,s){var i=t[0],n=t[1],a=t[2],c=t[3],h=i+i,o=n+n,m=a+a,f=i*h,u=i*o,p=i*m,x=n*o,v=n*m,g=a*m,y=c*h,S=c*o,M=c*m,I=s[0],P=s[1],R=s[2];return r[0]=(1-(x+g))*I,r[1]=(u+M)*I,r[2]=(p-S)*I,r[3]=0,r[4]=(u-M)*P,r[5]=(1-(f+g))*P,r[6]=(v+y)*P,r[7]=0,r[8]=(p+S)*R,r[9]=(v-y)*R,r[10]=(1-(f+x))*R,r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r}function b(){var r=new A(3);return A!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function Z(r){var t=new A(3);return t[0]=r[0],t[1]=r[1],t[2]=r[2],t}function G(r){var t=r[0],e=r[1],s=r[2];return Math.sqrt(t*t+e*e+s*s)}function d(r,t,e){var s=new A(3);return s[0]=r,s[1]=t,s[2]=e,s}function mt(r,t,e){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r}function k(r,t,e,s){return r[0]=t[0]+e[0]*s,r[1]=t[1]+e[1]*s,r[2]=t[2]+e[2]*s,r}function lt(r,t){var e=t[0]-r[0],s=t[1]-r[1],i=t[2]-r[2];return Math.sqrt(e*e+s*s+i*i)}function C(r,t){var e=t[0],s=t[1],i=t[2],n=e*e+s*s+i*i;return n>0&&(n=1/Math.sqrt(n)),r[0]=t[0]*n,r[1]=t[1]*n,r[2]=t[2]*n,r}function X(r,t,e){var s=t[0],i=t[1],n=t[2],a=e[3]*s+e[7]*i+e[11]*n+e[15];return a=a||1,r[0]=(e[0]*s+e[4]*i+e[8]*n+e[12])/a,r[1]=(e[1]*s+e[5]*i+e[9]*n+e[13])/a,r[2]=(e[2]*s+e[6]*i+e[10]*n+e[14])/a,r}function F(r,t,e){var s=t[0],i=t[1],n=t[2];return r[0]=s*e[0]+i*e[3]+n*e[6],r[1]=s*e[1]+i*e[4]+n*e[7],r[2]=s*e[2]+i*e[5]+n*e[8],r}(function(){var r=b();return function(t,e,s,i,n,a){var c,h;for(e||(e=3),s||(s=0),i?h=Math.min(i*e+s,t.length):h=t.length,c=s;c<h;c+=e)r[0]=t[c],r[1]=t[c+1],r[2]=t[c+2],n(r,r,a),t[c]=r[0],t[c+1]=r[1],t[c+2]=r[2];return t}})();class dt{orbitCentre;cameraDistance;cameraTransform;pitch;yaw;constructor(){this.orbitCentre=w(),this.cameraDistance=3,this.pitch=0,this.yaw=0,this.cameraTransform=w(),this.updateCameraTransform()}rotateCamera(t,e){this.pitch=Math.min(Math.max(this.pitch+t,-Math.PI/2),Math.PI/2),this.yaw+=e,this.updateCameraTransform()}getAngles(){return[this.pitch,this.yaw]}getRotationMatrix(t){return t[0]=this.cameraTransform[0],t[1]=this.cameraTransform[1],t[2]=this.cameraTransform[2],t[3]=0,t[4]=this.cameraTransform[4],t[5]=this.cameraTransform[5],t[6]=this.cameraTransform[6],t[7]=0,t[8]=this.cameraTransform[8],t[9]=this.cameraTransform[9],t[10]=this.cameraTransform[10],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}getCameraPosition(t){return t[0]=this.cameraTransform[12],t[1]=this.cameraTransform[13],t[2]=this.cameraTransform[14],t}getCameraMatrix(t){return nt(t,this.cameraTransform),t}setAngles(t,e){this.pitch=Math.min(Math.max(t,-Math.PI/2),Math.PI/2),this.yaw=e,this.updateCameraTransform()}getPosition(t){return t[0]=this.cameraTransform[12],t[1]=this.cameraTransform[13],t[2]=this.cameraTransform[14],t}transformDirection(t,e){const s=this.cameraTransform,i=e[0],n=e[1],a=e[2];return t[0]=s[0]*i+s[4]*n+s[8]*a,t[1]=s[1]*i+s[5]*n+s[9]*a,t[2]=s[2]*i+s[6]*n+s[10]*a,t}updateCameraTransform(){const t=w();_(t,w(),this.yaw),Q(this.orbitCentre,t,this.pitch),at(this.cameraTransform,this.orbitCentre,d(0,0,Math.abs(this.cameraDistance)))}}class z{transform;constructor(t){this.transform=t}getWorldPosition(){const t=w();return N(t,this.transform),d(t[12],t[13],t[14])}sdf(t){const e=b();return X(e,t,this.transform),this.localSdf(e)}}class ft extends z{radius;constructor(t,e){super(t),this.radius=e}localSdf(t){return G(t)-this.radius}getLocalBoundingRadius(){return this.radius}}class ut extends z{halfSize;constructor(t,e){super(t),this.halfSize=Z(e)}localSdf(t){const e=d(Math.abs(t[0])-this.halfSize[0],Math.abs(t[1])-this.halfSize[1],Math.abs(t[2])-this.halfSize[2]),s=d(Math.max(e[0],0),Math.max(e[1],0),Math.max(e[2],0)),i=G(s),n=Math.min(Math.max(e[0],Math.max(e[1],e[2])),0);return i+n}getLocalBoundingRadius(){return G(this.halfSize)}}class xt extends z{majorRadius;minorRadius;constructor(t,e,s){super(t),this.majorRadius=e,this.minorRadius=s}localSdf(t){const e=t[0],s=t[1],i=t[2],n=Math.sqrt(e*e+i*i)-this.majorRadius,a=s;return Math.sqrt(n*n+a*a)-this.minorRadius}getLocalBoundingRadius(){return this.majorRadius+this.minorRadius}}class pt extends z{prim1;prim2;smoothness;constructor(t,e,s){super(w()),this.prim1=t,this.prim2=e,this.smoothness=s}localSdf(t){const e=b(),s=w();N(s,this.transform),X(e,t,s);const i=this.prim1.sdf(e),n=this.prim2.sdf(e),a=this.smoothness*4,c=Math.max(a-Math.abs(i-n),0);return Math.min(i,n)-c*c*.25/a}getLocalBoundingRadius(){const t=this.prim1.getLocalBoundingRadius(),e=this.prim2.getLocalBoundingRadius(),s=this.prim1.getWorldPosition(),i=this.prim2.getWorldPosition(),n=lt(s,i);return Math.max(t,e)+n*.5}getWorldPosition(){const t=this.prim1.getWorldPosition(),e=this.prim2.getWorldPosition();return d((t[0]+e[0])/2,(t[1]+e[1])/2,(t[2]+e[2])/2)}}class vt extends z{primitive;twistAmount;constructor(t,e=10){super(t.transform),this.primitive=t,this.twistAmount=e}localSdf(t){const e=b(),s=w();N(s,this.transform),X(e,t,s);const i=this.twistAmount,n=Math.cos(i*e[1]),a=Math.sin(i*e[1]),c=d(n*e[0]-a*e[2],e[1],a*e[0]+n*e[2]);return this.primitive.sdf(c)}getLocalBoundingRadius(){return this.primitive.getLocalBoundingRadius()}getWorldPosition(){return this.primitive.getWorldPosition()}}class yt extends z{primitive;radius;constructor(t,e){super(t.transform),this.primitive=t,this.radius=e}localSdf(t){const e=b(),s=w();return N(s,this.transform),X(e,t,s),this.primitive.sdf(e)-this.radius}getLocalBoundingRadius(){return this.primitive.getLocalBoundingRadius()+this.radius}getWorldPosition(){return this.primitive.getWorldPosition()}}class Pt extends z{prim1;prim2;smoothness;constructor(t,e,s){super(w()),this.prim1=t,this.prim2=e,this.smoothness=s}localSdf(t){const e=b(),s=w();N(s,this.transform),X(e,t,s);const i=this.prim1.sdf(e),n=this.prim2.sdf(e),a=this.smoothness*4,c=Math.max(a-Math.abs(i+n),0);return Math.max(i,-n)+c*c*.25/a}getLocalBoundingRadius(){return this.prim1.getLocalBoundingRadius()}getWorldPosition(){return this.prim1.getWorldPosition()}}class gt extends z{primitive;spacing;constructor(t,e){super(t.transform),this.primitive=t,this.spacing=e}localSdf(t){const e=b(),s=w();N(s,this.transform),X(e,t,s);const i=b();return i[0]=e[0]-this.spacing[0]*Math.round(e[0]/this.spacing[0]),i[1]=e[1]-this.spacing[1]*Math.round(e[1]/this.spacing[1]),i[2]=e[2]-this.spacing[2]*Math.round(e[2]/this.spacing[2]),this.primitive.sdf(i)}getLocalBoundingRadius(){return 1/0}getWorldPosition(){return this.primitive.getWorldPosition()}}class l{static getTransform(t,e,s,i){const n=w();i?(ht(n,[t,e,s]),Q(n,n,i[0]),_(n,n,i[1]),ct(n,n,i[2])):ot(n,[0,0,0,1],[t,e,s],[1,1,1]);const a=w();return N(a,n),a}static createSphere(t,e,s,i,n){return new ft(l.getTransform(t,e,s,n),i)}static createBox(t,e,s,i,n){return new ut(l.getTransform(t,e,s,n),i)}static createTorus(t,e,s,i,n){return new xt(l.getTransform(t,e,s,n),i,i/4)}static createSmoothUnion(t,e,s){return new pt(t,e,s)}static createSmoothSubtract(t,e,s){return new Pt(t,e,s)}static createTwist(t,e){return new vt(t,e)}static createRound(t,e){return new yt(t,e)}static createRepetition(t,e){return new gt(t,e)}static presets=[{name:"Sphere",objects:[l.createSphere(0,0,0,1.5)]},{name:"Grid of Spheres",objects:[l.createSphere(-1,-1,0,.3),l.createSphere(0,-1,0,.3),l.createSphere(1,-1,0,.3),l.createSphere(-1,0,0,.3),l.createSphere(0,0,0,.3),l.createSphere(1,0,0,.3),l.createSphere(-1,1,0,.3),l.createSphere(0,1,0,.3),l.createSphere(1,1,0,.3)]},{name:"Atom",objects:[l.createSphere(0,0,0,.5),l.createSphere(1.2,0,0,.3),l.createSphere(-1.2,0,0,.3),l.createSphere(0,1.2,0,.3),l.createSphere(0,-1.2,0,.3),l.createSphere(0,0,1.2,.3),l.createSphere(0,0,-1.2,.3)]},{name:"Random Spheres",objects:[l.createSphere(.8,-.3,.2,.4),l.createSphere(-.5,.9,-.1,.5),l.createSphere(.2,.1,.8,.3),l.createSphere(-.9,-.4,-.6,.6),l.createSphere(.4,-.8,.5,.35),l.createSphere(-.2,.6,-.9,.4),l.createSphere(.7,.3,-.4,.25)]},{name:"Cube",objects:[l.createBox(0,0,0,d(1,1,1))]},{name:"Sphere and Cube",objects:[l.createSphere(-.7,0,0,.5),l.createBox(1,0,0,d(.5,.5,.5))]},{name:"Pyramid of Boxes",objects:[l.createBox(0,.5,0,d(.9,.25,.9)),l.createBox(0,0,0,d(.6,.25,.6)),l.createBox(0,-.5,0,d(.3,.25,.3))]},{name:"Torus",objects:[l.createTorus(0,0,0,1.3,d(-Math.PI/2,0,0))]},{name:"Dense Sphere Grid",objects:(()=>{const t=[];for(let n=0;n<5;n++)for(let a=0;a<5;a++)for(let c=0;c<5;c++)t.push(l.createSphere(n*.6-1.2,a*.6-1.2,c*.6-1.2,.15));return t})()},{name:"Smooth Union",objects:[l.createSmoothUnion(l.createSphere(0,0,0,.5),l.createBox(0,.5,0,d(1,.2,1)),.2)]},{name:"Smooth Subtraction",objects:[l.createSmoothSubtract(l.createRound(l.createBox(0,0,0,d(1,1,1),d(0,Math.PI/4,0)),.1),l.createSphere(0,0,0,.9),.2)]},{name:"Rounded Box",objects:[l.createRound(l.createBox(0,0,0,d(.4,.4,.4)),.3)]},{name:"Twisted Torus",objects:[l.createTwist(l.createTorus(0,0,0,1.3,d(-Math.PI/2,0,0)),3)]},{name:"Screw",objects:[l.createRound(l.createTwist(l.createBox(0,0,0,d(.4,1.5,.4)),4),.1)]},{name:"Chicken",objects:[l.createBox(0,0,0,d(.6,.6,.8)),l.createBox(0,-.2,0,d(.8,.4,.6)),l.createBox(0,-.8,.8,d(.4,.6,.3)),l.createBox(0,-.8,1.2,d(.4,.2,.2)),l.createBox(0,-.4,1,d(.2,.2,.2)),l.createBox(.3,1,0,d(.1,.6,.01)),l.createBox(-.3,1,0,d(.1,.6,.01)),l.createBox(0,1.6,.2,d(.6,.01,.2)),l.createBox(.3,1.6,.5,d(.1,.01,.1)),l.createBox(-.3,1.6,.5,d(.1,.01,.1))]},{name:"Infinite Spheres",objects:[l.createRepetition(l.createSphere(0,0,0,.3),d(1.5,1.5,1.5))]},{name:"67",objects:[l.createRound(l.createBox(-1.25,-.8,0,d(.05,.7,.05),d(0,0,Math.PI/5)),.2),l.createRound(l.createTorus(-1.25,.5,0,.8,d(-Math.PI/2,0,0)),.05),l.createRound(l.createBox(1.35,0,0,d(.05,1.5,.05),d(0,0,Math.PI/7)),.2),l.createRound(l.createBox(1.25,-1.4,0,d(.05,.8,.05),d(0,0,Math.PI/2)),.2)]}];static getPreset(t){return this.presets[Math.max(0,Math.min(t,this.presets.length-1))]}static getPresetCount(){return this.presets.length}static populateSceneDropdown(t,e=0){t.innerHTML="";for(let s=0;s<this.presets.length;s++){const i=this.getPreset(s),n=document.createElement("option");n.value=s.toString(),n.textContent=i.name,n.selected=s===e,t.appendChild(n)}}}class E{min;max;constructor(t,e){this.min=Z(t),this.max=Z(e)}contains(t){return t[0]>=this.min[0]&&t[0]<=this.max[0]&&t[1]>=this.min[1]&&t[1]<=this.max[1]&&t[2]>=this.min[2]&&t[2]<=this.max[2]}intersects(t){return this.min[0]<=t.max[0]&&this.max[0]>=t.min[0]&&this.min[1]<=t.max[1]&&this.max[1]>=t.min[1]&&this.min[2]<=t.max[2]&&this.max[2]>=t.min[2]}distanceToBox(t){let e=0;this.max[0]<t.min[0]?e=t.min[0]-this.max[0]:t.max[0]<this.min[0]&&(e=this.min[0]-t.max[0]);let s=0;this.max[1]<t.min[1]?s=t.min[1]-this.max[1]:t.max[1]<this.min[1]&&(s=this.min[1]-t.max[1]);let i=0;return this.max[2]<t.min[2]?i=t.min[2]-this.max[2]:t.max[2]<this.min[2]&&(i=this.min[2]-t.max[2]),Math.hypot(e,s,i)}distanceToPoint(t){let e=0;t[0]<this.min[0]?e=this.min[0]-t[0]:t[0]>this.max[0]&&(e=t[0]-this.max[0]);let s=0;t[1]<this.min[1]?s=this.min[1]-t[1]:t[1]>this.max[1]&&(s=t[1]-this.max[1]);let i=0;return t[2]<this.min[2]?i=this.min[2]-t[2]:t[2]>this.max[2]&&(i=t[2]-this.max[2]),Math.hypot(e,s,i)}intersectRay(t,e){let s=-1/0,i=1/0;for(let n=0;n<3;n++)if(Math.abs(e[n])<1e-10){if(t[n]<this.min[n]||t[n]>this.max[n])return null}else{const a=1/e[n];let c=(this.min[n]-t[n])*a,h=(this.max[n]-t[n])*a;if(c>h){const o=c;c=h,h=o}if(s=Math.max(s,c),i=Math.min(i,h),s>i)return null}return[s,i]}center(){return d((this.min[0]+this.max[0])/2,(this.min[1]+this.max[1])/2,(this.min[2]+this.max[2])/2)}merge(t){return new E(d(Math.min(this.min[0],t.min[0]),Math.min(this.min[1],t.min[1]),Math.min(this.min[2],t.min[2])),d(Math.max(this.max[0],t.max[0]),Math.max(this.max[1],t.max[1]),Math.max(this.max[2],t.max[2])))}static fromPrimitive(t){const e=t.getWorldPosition(),s=t.getLocalBoundingRadius(),i=w(),a=N(i,t.transform)?i:t.transform,c=Math.hypot(a[0],a[1],a[2]),h=Math.hypot(a[4],a[5],a[6]),o=Math.hypot(a[8],a[9],a[10]),m=Math.max(c,h,o),f=s*m*1.5;return new E(d(e[0]-f,e[1]-f,e[2]-f),d(e[0]+f,e[1]+f,e[2]+f))}}function J(r){if(r.length===0)return new E(d(0,0,0),d(0,0,0));let t=E.fromPrimitive(r[0]);for(let e=1;e<r.length;e++)t=t.merge(E.fromPrimitive(r[e]));return t}class tt{bounds;primitives;children;level;isEmpty;minDistance;constructor(t,e,s){this.bounds=t,this.primitives=e,this.children=null,this.level=s,this.isEmpty=!0,this.minDistance=0}isLeaf(){return this.children===null}}class St{root;maxDepth;maxPrimitivesPerNode;primitives;sceneBounds;primitiveBounds;constructor(t,e,s=6,i=4){this.maxDepth=s,this.maxPrimitivesPerNode=i,this.primitives=t,this.sceneBounds=e,this.primitiveBounds=t.map(n=>E.fromPrimitive(n)),this.root=this.buildNode(t,e,0),this.computeMinDistances(this.root)}buildNode(t,e,s){const i=new tt(e,[],s);if(s>=this.maxDepth||t.length<=this.maxPrimitivesPerNode)return i.primitives=t,i;const n=e.center(),a=[];for(let h=0;h<2;h++)for(let o=0;o<2;o++)for(let m=0;m<2;m++){const f=m===0?e.min[0]:n[0],u=m===0?n[0]:e.max[0],p=o===0?e.min[1]:n[1],x=o===0?n[1]:e.max[1],v=h===0?e.min[2]:n[2],g=h===0?n[2]:e.max[2];a.push(new E(d(f,p,v),d(u,x,g)))}const c=Array.from({length:8},()=>[]);for(const h of t){const o=E.fromPrimitive(h);for(let m=0;m<8;m++)a[m].intersects(o)&&c[m].push(h)}i.children=[];for(let h=0;h<8;h++)if(c[h].length>0)i.children.push(this.buildNode(c[h],a[h],s+1));else{const o=new tt(a[h],[],s+1);i.children.push(o)}return i}getPrimitivesAt(t){const e=new Set;return this.queryNode(this.root,t,e),Array.from(e)}queryNode(t,e,s){if(t.bounds.contains(e)){if(t.isLeaf()){for(const i of t.primitives)s.add(i);return}if(t.children)for(const i of t.children)this.queryNode(i,e,s)}}computeMinDistances(t){if(t.isLeaf()){const s=t.primitives.length>0;if(t.isEmpty=!s,s)t.minDistance=0;else{let i=1/0;for(let n=0;n<this.primitiveBounds.length;n++){const a=t.bounds.distanceToBox(this.primitiveBounds[n]);a<i&&(i=a)}t.minDistance=i!==1/0?Math.max(0,i):0}return{hasPrims:s}}let e=!1;if(t.children)for(const s of t.children)this.computeMinDistances(s).hasPrims&&(e=!0);if(t.isEmpty=!e,t.isEmpty){let s=1/0;for(let i=0;i<this.primitiveBounds.length;i++){const n=t.bounds.distanceToBox(this.primitiveBounds[i]);n<s&&(s=n)}t.minDistance=s!==1/0?Math.max(0,s):0}else t.minDistance=0;return{hasPrims:e}}intersectRayBox(t,e,s){const i=b(),n=b();for(let h=0;h<3;h++){const o=1/e[h];let m=(s.min[h]-t[h])*o,f=(s.max[h]-t[h])*o;o<0&&([m,f]=[f,m]),i[h]=m,n[h]=f}const a=Math.max(i[0],i[1],i[2]),c=Math.min(n[0],n[1],n[2]);return a>c||c<0?null:[Math.max(0,a),c]}findNode(t){return this.findNodeRecursive(this.root,t)}findNodeRecursive(t,e){if(!t.bounds.contains(e))return null;if(t.isLeaf()||t.level===this.maxDepth)return t;if(t.children)for(const s of t.children){const i=this.findNodeRecursive(s,e);if(i)return i}return t}marchRay(t,e,s){const i=b();k(i,t,e,s);const n=this.findNode(i);if(!n)return 0;if(n.isEmpty){const a=this.intersectRayBox(t,e,n.bounds);if(a){const[c,h]=a,o=Math.max(0,h-s),m=Math.max(0,Math.min(o,n.minDistance*.99));return m>0?m+.001:0}}return 0}onRayMarchStart(t){return{data:null}}onRayMarchStep(t,e){return this.marchRay(t.rayOrigin,t.rayDirection,t.currentDistance)}}class bt{bounds;primitives;left;right;constructor(t,e){this.bounds=t,this.primitives=e,this.left=null,this.right=null}isLeaf(){return this.left===null&&this.right===null}}class Dt{root;maxDepth;maxPrimitivesPerNode;constructor(t,e,s=20,i=4){this.maxDepth=s,this.maxPrimitivesPerNode=i;const n=J(t);this.root=this.buildNode(t,n,0)}buildNode(t,e,s){const i=new bt(e,[]);if(s>=this.maxDepth||t.length<=this.maxPrimitivesPerNode)return i.primitives=t,i;const n=b();mt(n,e.max,e.min);let a=0;n[1]>n[0]&&(a=1),n[2]>n[a]&&(a=2);const c=[...t].sort((p,x)=>{const v=p.getWorldPosition()[a],g=x.getWorldPosition()[a];return v-g}),h=Math.floor(c.length/2),o=c.slice(0,h),m=c.slice(h);if(o.length===0||m.length===0)return i.primitives=t,i;const f=J(o),u=J(m);return i.left=this.buildNode(o,f,s+1),i.right=this.buildNode(m,u,s+1),i}getPrimitivesAt(t){const e=new Set;return this.queryNode(this.root,t,e),Array.from(e)}queryNode(t,e,s){if(t.bounds.contains(e)){if(t.isLeaf()){for(const i of t.primitives)s.add(i);return}t.left&&this.queryNode(t.left,e,s),t.right&&this.queryNode(t.right,e,s)}}findRayIntersections(t,e,s=0,i=1/0){const n=[],a=[this.root];for(;a.length>0;){const c=a.pop(),h=c.bounds.intersectRay(t,e);if(!h)continue;const[o,m]=h;if(m<s||o>i)continue;const f=Math.max(o,s),u=Math.min(m,i);c.isLeaf()?c.primitives&&c.primitives.length>0&&n.push({tEnter:f,tExit:u,node:c}):(c.left&&a.push(c.left),c.right&&a.push(c.right))}return n.sort((c,h)=>c.tEnter-h.tEnter),n}onRayMarchStart(t){const e=this.findRayIntersections(t.rayOrigin,t.rayDirection,0,t.maxDistance);return e.length===0?{data:{intervals:[],terminate:!0}}:{data:{intervals:e,currentIntervalIdx:0,terminate:!1}}}onRayMarchStep(t,e){if(!e.data||e.data.terminate)return-1;const{intervals:s,currentIntervalIdx:i}=e.data;if(i>=s.length)return-1;const n=s[i];if(t.currentDistance<n.tEnter)return n.tEnter-t.currentDistance;if(t.currentDistance>n.tExit)if(e.data.currentIntervalIdx++,e.data.currentIntervalIdx<s.length){const a=s[e.data.currentIntervalIdx];if(a.tEnter>t.currentDistance)return a.tEnter-t.currentDistance}else return-1;return 0}}class Rt{objectSDFs;camera;octree=null;bvh=null;accelerationStructure="None";currentPresetIndex=0;cachedBounds=null;constructor(t="None"){this.camera=new dt,this.objectSDFs=new Array,this.accelerationStructure=t,this.loadPreset(0)}getAccelerationStructure(){return this.accelerationStructure==="Octree"?this.octree:this.accelerationStructure==="BVH"?this.bvh:null}loadPreset(t){this.currentPresetIndex=Math.max(0,Math.min(t,l.getPresetCount()-1));const e=l.getPreset(this.currentPresetIndex);this.objectSDFs=[...e.objects],this.cachedBounds=null,this.accelerationStructure=="Octree"?(this.buildOctree(),this.bvh=null):this.accelerationStructure=="BVH"?(this.buildBVH(),this.octree=null):(this.octree=null,this.bvh=null)}buildOctree(){const t=this.getSceneBounds();this.octree=new St(this.objectSDFs,t)}buildBVH(){const t=this.getSceneBounds();this.bvh=new Dt(this.objectSDFs,t)}getSceneBounds(){return this.cachedBounds||(this.cachedBounds=this.calculateSceneBounds()),this.cachedBounds}calculateSceneBounds(){return new E(d(-10,-10,-10),d(10,10,10))}nextPreset(){this.loadPreset(Math.min(this.currentPresetIndex+1,l.getPresetCount()))}previousPreset(){this.loadPreset(Math.max(this.currentPresetIndex-1,0))}getCurrentPresetInfo(){const t=l.getPreset(this.currentPresetIndex);return{index:this.currentPresetIndex,name:t.name,total:l.getPresetCount()}}getDistance(t,e){let i=10;if(this.accelerationStructure==="Octree"&&this.octree){const n=this.octree.findNode(t);if(n){if(n.primitives.length>0)for(const a of n.primitives)e&&e.count++,i=Math.min(a.sdf(t),i);else n.isEmpty&&(i=Math.min(i,n.minDistance*.99));return i}}else if(this.accelerationStructure==="BVH"&&this.bvh){let n=this.bvh.getPrimitivesAt(t);n=n.length===0?this.objectSDFs:n;for(const a of n)e&&e.count++,i=Math.min(a.sdf(t),i);return i}for(const n of this.objectSDFs)e&&e.count++,i=Math.min(n.sdf(t),i);return i}}class K{}const Mt=100,W=10,Tt=.001;class et extends K{runRaymarcher(t,e,s,i,n,a,c,h,o=0,m=c){const f=t.camera.getRotationMatrix(w()),u=U();V(u,f);const p=b();t.camera.getPosition(p);for(let x=o;x<m;x++){const v=x-o,g=(x/c-.5)*2;for(let y=0;y<a;y++){const S=v*a+y,M=S*3;i[S]=0,n[S]=0;const I=(y/a-.5)*2,P=d(I,g,-1);F(P,P,u),C(P,P);const R=this.rayMarch(t,p,P,S,i,n),B=b();k(B,p,P,R);let D;R>=W?D=d(0,0,0):D=this.getNormal(t,B,S,i),s[M]=(D[0]+1)*.5*255,s[M+1]=(D[1]+1)*.5*255,s[M+2]=(D[2]+1)*.5*255,e[S]=R}}}getSceneDistance(t,e,s,i){const n={count:0},a=t.getDistance(e,n);return i[s]+=n.count,a}getNormal(t,e,s,i){let n=this.getSceneDistance(t,e,s,i);const a=[.01,0,0],c=b();return c[0]=n-this.getSceneDistance(t,d(e[0]-a[0],e[1],e[2]),s,i),c[1]=n-this.getSceneDistance(t,d(e[0],e[1]-a[0],e[2]),s,i),c[2]=n-this.getSceneDistance(t,d(e[0],e[1],e[2]-a[0]),s,i),C(c,c),c}rayMarch(t,e,s,i,n,a){let c=0;const h=t.getAccelerationStructure();let o=null;if(h&&h.onRayMarchStart&&(o=h.onRayMarchStart({rayOrigin:e,rayDirection:s,currentDistance:c,maxDistance:W}),o&&o.data&&o.data.terminate))return W;for(let m=0;m<Mt;m++){const f=b();if(k(f,e,s,c),h&&h.onRayMarchStep&&o){const p=h.onRayMarchStep({rayOrigin:e,rayDirection:s,currentDistance:c,maxDistance:W},o);if(p===-1)return W;if(p>0){if(c+=p,c>W)break;continue}}const u=this.getSceneDistance(t,f,i,n);if(c+=u,a[i]+=1,u<Tt||c>W)break}return h&&h.onRayMarchEnd&&o&&h.onRayMarchEnd(o),c}}const wt=200,j=10,It=.001,Bt=.1;class Et extends K{runRaymarcher(t,e,s,i,n,a,c,h,o=0,m=c){const f=t.camera.getRotationMatrix(w()),u=U();V(u,f);const p=b();t.camera.getPosition(p);for(let x=o;x<m;x++){const v=x-o,g=(x/c-.5)*2;for(let y=0;y<a;y++){const S=v*a+y,M=S*3;i[S]=0,n[S]=0;const I=(y/a-.5)*2,P=d(I,g,-1);F(P,P,u),C(P,P);const R=this.fixedStepMarch(t,p,P,S,i,n),B=b();k(B,p,P,R);let D;R>=j?D=d(0,0,0):D=this.getNormal(t,B,S,i),s[M]=(D[0]+1)*.5*255,s[M+1]=(D[1]+1)*.5*255,s[M+2]=(D[2]+1)*.5*255,e[S]=R}}}getSceneDistance(t,e,s,i){const n={count:0},a=t.getDistance(e,n);return i[s]+=n.count,a}getNormal(t,e,s,i){let n=this.getSceneDistance(t,e,s,i);const a=[.01,0,0],c=b();return c[0]=n-this.getSceneDistance(t,d(e[0]-a[0],e[1],e[2]),s,i),c[1]=n-this.getSceneDistance(t,d(e[0],e[1]-a[0],e[2]),s,i),c[2]=n-this.getSceneDistance(t,d(e[0],e[1],e[2]-a[0]),s,i),C(c,c),c}fixedStepMarch(t,e,s,i,n,a){let c=0,h=!1;const o=t.getAccelerationStructure();let m=null;if(o&&o.onRayMarchStart&&(m=o.onRayMarchStart({rayOrigin:e,rayDirection:s,currentDistance:c,maxDistance:j}),m&&m.data&&m.data.terminate))return j;for(let f=0;f<wt;f++){const u=b();if(k(u,e,s,c),o&&o.onRayMarchStep&&m){const x=o.onRayMarchStep({rayOrigin:e,rayDirection:s,currentDistance:c,maxDistance:j},m);if(x===-1)return j;if(x>0){if(c+=x,c>j)break;continue}}const p=this.getSceneDistance(t,u,i,n);if(a[i]+=1,p<It){h=!0;break}if(c+=Bt,c>j)break}return o&&o.onRayMarchEnd&&m&&o.onRayMarchEnd(m),h?c:j}}const At=200,L=10,Nt=.001,rt=.1,zt=.8,st=rt*.25,it=rt*5,jt=.1,Lt=.01;class kt extends K{runRaymarcher(t,e,s,i,n,a,c,h,o=0,m=c){const f=t.camera.getRotationMatrix(w()),u=U();V(u,f);const p=b();t.camera.getPosition(p);for(let x=o;x<m;x++){const v=x-o,g=(x/c-.5)*2;for(let y=0;y<a;y++){const S=v*a+y,M=S*3;i[S]=0,n[S]=0;const I=(y/a-.5)*2,P=d(I,g,-1);F(P,P,u),C(P,P);const R=this.adaptiveStepMarch(t,p,P,S,i,n),B=b();k(B,p,P,R);let D;R>=L?D=d(0,0,0):D=this.getNormal(t,B,S,i),s[M]=(D[0]+1)*.5*255,s[M+1]=(D[1]+1)*.5*255,s[M+2]=(D[2]+1)*.5*255,e[S]=R}}}getSceneDistance(t,e,s,i){const n={count:0},a=t.getDistance(e,n);return i[s]+=n.count,a}getNormal(t,e,s,i){let n=this.getSceneDistance(t,e,s,i);const a=[.01,0,0],c=b();return c[0]=n-this.getSceneDistance(t,d(e[0]-a[0],e[1],e[2]),s,i),c[1]=n-this.getSceneDistance(t,d(e[0],e[1]-a[0],e[2]),s,i),c[2]=n-this.getSceneDistance(t,d(e[0],e[1],e[2]-a[0]),s,i),C(c,c),c}adaptiveStepMarch(t,e,s,i,n,a){let c=0,h=!1;const o=t.getAccelerationStructure();let m=null;if(o&&o.onRayMarchStart&&(m=o.onRayMarchStart({rayOrigin:e,rayDirection:s,currentDistance:c,maxDistance:L}),m&&m.data&&m.data.terminate))return L;for(let f=0;f<At;f++){const u=b();if(k(u,e,s,c),o&&o.onRayMarchStep&&m){const v=o.onRayMarchStep({rayOrigin:e,rayDirection:s,currentDistance:c,maxDistance:L},m);if(v===-1)return L;if(v>0){if(c+=v,c>L)break;continue}}const p=this.getSceneDistance(t,u,i,n);if(a[i]+=1,p<Nt){h=!0;break}let x;if(p<jt?x=Lt:(x=zt*p,x<st&&(x=st),x>it&&(x=it)),c+=x,c>L)break}return o&&o.onRayMarchEnd&&m&&o.onRayMarchEnd(m),h?c:L}}self.onmessage=r=>{const{width:t,height:e,time:s,yStart:i,yEnd:n,camera:a,algorithm:c,scenePresetIndex:h,accelerationStructure:o}=r.data,m=new Rt(o);m.loadPreset(h),m.camera.setAngles(a.pitch,a.yaw);const f=Math.max(0,n-i),u=new Uint8ClampedArray(t*f),p=new Uint8ClampedArray(t*f*3),x=new Uint16Array(t*f),v=new Uint16Array(t*f);let g;switch(c){case"sphere-tracer":g=new et;break;case"fixed-step":g=new Et;break;case"adaptive-step":g=new kt;break;default:g=new et}g.runRaymarcher(m,u,p,x,v,t,e,s,i,n);const y={yStart:i,yEnd:n,depth:u,normal:p,sdfEval:x,iters:v};self.postMessage(y,[u.buffer,p.buffer,x.buffer,v.buffer])}})();
