(function(){"use strict";var N=typeof Float32Array<"u"?Float32Array:Array;function $(){var e=new N(9);return N!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function Y(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function R(){var e=new N(16);return N!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function et(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function rt(e,t){var r=t[0],s=t[1],n=t[2],c=t[3],i=t[4],a=t[5],h=t[6],o=t[7],m=t[8],f=t[9],l=t[10],v=t[11],x=t[12],b=t[13],y=t[14],S=t[15],g=r*a-s*i,M=r*h-n*i,A=r*o-c*i,P=s*h-n*a,D=s*o-c*a,z=n*o-c*h,T=m*b-f*x,X=m*y-l*x,O=m*S-v*x,u=f*y-l*b,L=f*S-v*b,k=l*S-v*y,w=g*k-M*L+A*u+P*O-D*X+z*T;return w?(w=1/w,e[0]=(a*k-h*L+o*u)*w,e[1]=(n*L-s*k-c*u)*w,e[2]=(b*z-y*D+S*P)*w,e[3]=(l*D-f*z-v*P)*w,e[4]=(h*O-i*k-o*X)*w,e[5]=(r*k-n*O+c*X)*w,e[6]=(y*A-x*z-S*M)*w,e[7]=(m*z-l*A+v*M)*w,e[8]=(i*L-a*O+o*T)*w,e[9]=(s*O-r*L-c*T)*w,e[10]=(x*D-b*A+S*g)*w,e[11]=(f*A-m*D-v*g)*w,e[12]=(a*X-i*u-h*T)*w,e[13]=(r*u-s*X+n*T)*w,e[14]=(b*M-x*P-y*g)*w,e[15]=(m*P-f*M+l*g)*w,e):null}function st(e,t,r){var s=r[0],n=r[1],c=r[2],i,a,h,o,m,f,l,v,x,b,y,S;return t===e?(e[12]=t[0]*s+t[4]*n+t[8]*c+t[12],e[13]=t[1]*s+t[5]*n+t[9]*c+t[13],e[14]=t[2]*s+t[6]*n+t[10]*c+t[14],e[15]=t[3]*s+t[7]*n+t[11]*c+t[15]):(i=t[0],a=t[1],h=t[2],o=t[3],m=t[4],f=t[5],l=t[6],v=t[7],x=t[8],b=t[9],y=t[10],S=t[11],e[0]=i,e[1]=a,e[2]=h,e[3]=o,e[4]=m,e[5]=f,e[6]=l,e[7]=v,e[8]=x,e[9]=b,e[10]=y,e[11]=S,e[12]=i*s+m*n+x*c+t[12],e[13]=a*s+f*n+b*c+t[13],e[14]=h*s+l*n+y*c+t[14],e[15]=o*s+v*n+S*c+t[15]),e}function nt(e,t,r){var s=Math.sin(r),n=Math.cos(r),c=t[4],i=t[5],a=t[6],h=t[7],o=t[8],m=t[9],f=t[10],l=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=c*n+o*s,e[5]=i*n+m*s,e[6]=a*n+f*s,e[7]=h*n+l*s,e[8]=o*n-c*s,e[9]=m*n-i*s,e[10]=f*n-a*s,e[11]=l*n-h*s,e}function ct(e,t,r){var s=Math.sin(r),n=Math.cos(r),c=t[0],i=t[1],a=t[2],h=t[3],o=t[8],m=t[9],f=t[10],l=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=c*n-o*s,e[1]=i*n-m*s,e[2]=a*n-f*s,e[3]=h*n-l*s,e[8]=c*s+o*n,e[9]=i*s+m*n,e[10]=a*s+f*n,e[11]=h*s+l*n,e}function q(e,t,r,s){var n=t[0],c=t[1],i=t[2],a=t[3],h=n+n,o=c+c,m=i+i,f=n*h,l=n*o,v=n*m,x=c*o,b=c*m,y=i*m,S=a*h,g=a*o,M=a*m,A=s[0],P=s[1],D=s[2];return e[0]=(1-(x+y))*A,e[1]=(l+M)*A,e[2]=(v-g)*A,e[3]=0,e[4]=(l-M)*P,e[5]=(1-(f+y))*P,e[6]=(b+S)*P,e[7]=0,e[8]=(v+g)*D,e[9]=(b-S)*D,e[10]=(1-(f+x))*D,e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function I(){var e=new N(3);return N!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function U(e){var t=new N(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function Z(e){var t=e[0],r=e[1],s=e[2];return Math.sqrt(t*t+r*r+s*s)}function p(e,t,r){var s=new N(3);return s[0]=e,s[1]=t,s[2]=r,s}function C(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e[2]=t[2]+r[2]*s,e}function j(e,t){var r=t[0],s=t[1],n=t[2],c=r*r+s*s+n*n;return c>0&&(c=1/Math.sqrt(c)),e[0]=t[0]*c,e[1]=t[1]*c,e[2]=t[2]*c,e}function it(e,t,r){var s=t[0],n=t[1],c=t[2],i=r[3]*s+r[7]*n+r[11]*c+r[15];return i=i||1,e[0]=(r[0]*s+r[4]*n+r[8]*c+r[12])/i,e[1]=(r[1]*s+r[5]*n+r[9]*c+r[13])/i,e[2]=(r[2]*s+r[6]*n+r[10]*c+r[14])/i,e}function W(e,t,r){var s=t[0],n=t[1],c=t[2];return e[0]=s*r[0]+n*r[3]+c*r[6],e[1]=s*r[1]+n*r[4]+c*r[7],e[2]=s*r[2]+n*r[5]+c*r[8],e}(function(){var e=I();return function(t,r,s,n,c,i){var a,h;for(r||(r=3),s||(s=0),n?h=Math.min(n*r+s,t.length):h=t.length,a=s;a<h;a+=r)e[0]=t[a],e[1]=t[a+1],e[2]=t[a+2],c(e,e,i),t[a]=e[0],t[a+1]=e[1],t[a+2]=e[2];return t}})();class at{orbitCentre;cameraDistance;cameraTransform;pitch;yaw;constructor(){this.orbitCentre=R(),this.cameraDistance=3,this.pitch=0,this.yaw=0,this.cameraTransform=R(),this.updateCameraTransform()}rotateCamera(t,r){this.pitch=Math.min(Math.max(this.pitch+t,-Math.PI/2),Math.PI/2),this.yaw+=r,this.updateCameraTransform()}getAngles(){return[this.pitch,this.yaw]}getRotationMatrix(t){return t[0]=this.cameraTransform[0],t[1]=this.cameraTransform[1],t[2]=this.cameraTransform[2],t[3]=0,t[4]=this.cameraTransform[4],t[5]=this.cameraTransform[5],t[6]=this.cameraTransform[6],t[7]=0,t[8]=this.cameraTransform[8],t[9]=this.cameraTransform[9],t[10]=this.cameraTransform[10],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}getCameraPosition(t){return t[0]=this.cameraTransform[12],t[1]=this.cameraTransform[13],t[2]=this.cameraTransform[14],t}getCameraMatrix(t){return et(t,this.cameraTransform),t}setAngles(t,r){this.pitch=Math.min(Math.max(t,-Math.PI/2),Math.PI/2),this.yaw=r,this.updateCameraTransform()}getPosition(t){return t[0]=this.cameraTransform[12],t[1]=this.cameraTransform[13],t[2]=this.cameraTransform[14],t}transformDirection(t,r){const s=this.cameraTransform,n=r[0],c=r[1],i=r[2];return t[0]=s[0]*n+s[4]*c+s[8]*i,t[1]=s[1]*n+s[5]*c+s[9]*i,t[2]=s[2]*n+s[6]*c+s[10]*i,t}updateCameraTransform(){const t=R();ct(t,R(),this.yaw),nt(this.orbitCentre,t,this.pitch),st(this.cameraTransform,this.orbitCentre,p(0,0,Math.abs(this.cameraDistance)))}}class G{transform;constructor(t){this.transform=t}getWorldPosition(){const t=R();return rt(t,this.transform),p(t[12],t[13],t[14])}sdf(t){const r=I();return it(r,t,this.transform),this.localSdf(r)}}class ht extends G{radius;constructor(t,r){super(t),this.radius=r}localSdf(t){return Z(t)-this.radius}getLocalBoundingRadius(){return this.radius}}class mt extends G{halfSize;constructor(t,r){super(t),this.halfSize=U(r)}localSdf(t){const r=p(Math.abs(t[0])-this.halfSize[0],Math.abs(t[1])-this.halfSize[1],Math.abs(t[2])-this.halfSize[2]),s=p(Math.max(r[0],0),Math.max(r[1],0),Math.max(r[2],0)),n=Z(s),c=Math.min(Math.max(r[0],Math.max(r[1],r[2])),0);return n+c}getLocalBoundingRadius(){return Z(this.halfSize)}}class ot extends G{majorRadius;minorRadius;constructor(t,r,s){super(t),this.majorRadius=r,this.minorRadius=s}localSdf(t){const r=t[0],s=t[1],n=t[2],c=Math.sqrt(r*r+n*n)-this.majorRadius,i=s;return Math.sqrt(c*c+i*i)-this.minorRadius}getLocalBoundingRadius(){return this.majorRadius+this.minorRadius}}class d{static createSphere(t,r,s,n){const c=R();return q(c,[0,0,0,1],[t,r,s],[1,1,1]),new ht(c,n)}static createBox(t,r,s,n){const c=R();return q(c,[0,0,0,1],[t,r,s],[1,1,1]),new mt(c,n)}static createTorus(t,r,s,n){const c=R();return q(c,[0,0,0,1],[t,r,s],[1,1,1]),new ot(c,n,n/4)}static presets=[{name:"Sphere",objects:[d.createSphere(0,0,0,1.5)]},{name:"Grid of Spheres",objects:[d.createSphere(-1,-1,0,.3),d.createSphere(0,-1,0,.3),d.createSphere(1,-1,0,.3),d.createSphere(-1,0,0,.3),d.createSphere(0,0,0,.3),d.createSphere(1,0,0,.3),d.createSphere(-1,1,0,.3),d.createSphere(0,1,0,.3),d.createSphere(1,1,0,.3)]},{name:"Atom",objects:[d.createSphere(0,0,0,.5),d.createSphere(1.2,0,0,.3),d.createSphere(-1.2,0,0,.3),d.createSphere(0,1.2,0,.3),d.createSphere(0,-1.2,0,.3),d.createSphere(0,0,1.2,.3),d.createSphere(0,0,-1.2,.3)]},{name:"Random Spheres",objects:[d.createSphere(.8,-.3,.2,.4),d.createSphere(-.5,.9,-.1,.5),d.createSphere(.2,.1,.8,.3),d.createSphere(-.9,-.4,-.6,.6),d.createSphere(.4,-.8,.5,.35),d.createSphere(-.2,.6,-.9,.4),d.createSphere(.7,.3,-.4,.25)]},{name:"Cube",objects:[d.createBox(0,0,0,p(1,1,1))]},{name:"Sphere and Cube",objects:[d.createSphere(-.7,0,0,.5),d.createBox(1,0,0,p(.5,.5,.5))]},{name:"Pyramid of Boxes",objects:[d.createBox(0,-.5,0,p(.9,.25,.9)),d.createBox(0,0,0,p(.6,.25,.6)),d.createBox(0,.5,0,p(.3,.25,.3))]},{name:"Torus",objects:[d.createTorus(0,0,0,1.3)]},{name:"Dense Sphere Grid",objects:(()=>{const t=[];for(let c=0;c<5;c++)for(let i=0;i<5;i++)for(let a=0;a<5;a++)t.push(d.createSphere(c*.6-1.2,i*.6-1.2,a*.6-1.2,.15));return t})()}];static getPreset(t){return this.presets[Math.max(0,Math.min(t,this.presets.length-1))]}static getPresetCount(){return this.presets.length}static populateSceneDropdown(t,r=0){t.innerHTML="";for(let s=0;s<this.presets.length;s++){const n=this.getPreset(s),c=document.createElement("option");c.value=s.toString(),c.textContent=n.name,c.selected=s===r,t.appendChild(c)}}}class E{min;max;constructor(t,r){this.min=U(t),this.max=U(r)}contains(t){return t[0]>=this.min[0]&&t[0]<=this.max[0]&&t[1]>=this.min[1]&&t[1]<=this.max[1]&&t[2]>=this.min[2]&&t[2]<=this.max[2]}intersects(t){return this.min[0]<=t.max[0]&&this.max[0]>=t.min[0]&&this.min[1]<=t.max[1]&&this.max[1]>=t.min[1]&&this.min[2]<=t.max[2]&&this.max[2]>=t.min[2]}center(){return p((this.min[0]+this.max[0])/2,(this.min[1]+this.max[1])/2,(this.min[2]+this.max[2])/2)}static fromPrimitive(t){const r=t.getWorldPosition(),n=t.getLocalBoundingRadius()*1.1;return new E(p(r[0]-n,r[1]-n,r[2]-n),p(r[0]+n,r[1]+n,r[2]+n))}}class K{bounds;primitives;children;constructor(t,r){this.bounds=t,this.primitives=r,this.children=null}isLeaf(){return this.children===null}}class lt{root;maxDepth;maxPrimitivesPerNode;constructor(t,r,s=6,n=4){this.maxDepth=s,this.maxPrimitivesPerNode=n,this.root=this.buildNode(t,r,0)}buildNode(t,r,s){const n=new K(r,[]);if(s>=this.maxDepth||t.length<=this.maxPrimitivesPerNode)return n.primitives=t,n;const c=r.center(),i=[];for(let h=0;h<2;h++)for(let o=0;o<2;o++)for(let m=0;m<2;m++){const f=m===0?r.min[0]:c[0],l=m===0?c[0]:r.max[0],v=o===0?r.min[1]:c[1],x=o===0?c[1]:r.max[1],b=h===0?r.min[2]:c[2],y=h===0?c[2]:r.max[2];i.push(new E(p(f,v,b),p(l,x,y)))}const a=Array.from({length:8},()=>[]);for(const h of t){const o=E.fromPrimitive(h);for(let m=0;m<8;m++)i[m].intersects(o)&&a[m].push(h)}n.children=[];for(let h=0;h<8;h++)a[h].length>0?n.children.push(this.buildNode(a[h],i[h],s+1)):n.children.push(new K(i[h],[]));return n}getPrimitivesAt(t){const r=new Set;return this.queryNode(this.root,t,r),Array.from(r)}queryNode(t,r,s){if(t.bounds.contains(r)){if(t.isLeaf()){for(const n of t.primitives)s.add(n);return}if(t.children)for(const n of t.children)this.queryNode(n,r,s)}}}class dt{objectSDFs;camera;octree=null;accelerationStructure="None";currentPresetIndex=0;constructor(t="None"){this.camera=new at,this.objectSDFs=new Array,this.accelerationStructure=t,this.loadPreset(0)}loadPreset(t){this.currentPresetIndex=Math.max(0,Math.min(t,d.getPresetCount()-1));const r=d.getPreset(this.currentPresetIndex);this.objectSDFs=[...r.objects],this.accelerationStructure=="Octree"?this.buildOctree():this.octree=null}buildOctree(){const t=this.calculateSceneBounds();this.octree=new lt(this.objectSDFs,t)}calculateSceneBounds(){const t=p(-10,-10,-10),r=p(10,10,10);return new E(t,r)}nextPreset(){this.loadPreset(Math.min(this.currentPresetIndex+1,d.getPresetCount()))}previousPreset(){this.loadPreset(Math.max(this.currentPresetIndex-1,0))}getCurrentPresetInfo(){const t=d.getPreset(this.currentPresetIndex);return{index:this.currentPresetIndex,name:t.name,total:d.getPresetCount()}}getDistance(t,r){let n=.5;if(this.accelerationStructure==="Octree"&&this.octree){const c=this.octree.getPrimitivesAt(t);for(const i of c)r&&r.count++,n=Math.min(i.sdf(t),n)}else for(const c of this.objectSDFs)r&&r.count++,n=Math.min(c.sdf(t),n);return n}}class H{}const ft=100,Q=10,xt=.001;class F extends H{runRaymarcher(t,r,s,n,c,i,a,h,o=0,m=a){const f=t.camera.getRotationMatrix(R()),l=$();Y(l,f);const v=I();t.camera.getPosition(v);for(let x=o;x<m;x++){const b=x-o,y=(x/a-.5)*2;for(let S=0;S<i;S++){const g=b*i+S,M=g*3;n[g]=0,c[g]=0;const A=(S/i-.5)*2,P=p(A,y,-1);W(P,P,l),j(P,P);const D=this.rayMarch(t,v,P,g,n,c),z=I();C(z,v,P,D);let T;D>=Q?T=p(0,0,0):T=this.getNormal(t,z,g,n),s[M]=(T[0]+1)*.5*255,s[M+1]=(T[1]+1)*.5*255,s[M+2]=(T[2]+1)*.5*255,r[g]=D}}}getSceneDistance(t,r,s,n){const c={count:0},i=t.getDistance(r,c);return n[s]+=c.count,i}getNormal(t,r,s,n){let c=this.getSceneDistance(t,r,s,n);const i=[.01,0,0],a=I();return a[0]=c-this.getSceneDistance(t,p(r[0]-i[0],r[1],r[2]),s,n),a[1]=c-this.getSceneDistance(t,p(r[0],r[1]-i[0],r[2]),s,n),a[2]=c-this.getSceneDistance(t,p(r[0],r[1],r[2]-i[0]),s,n),j(a,a),a}rayMarch(t,r,s,n,c,i){let a=0;for(let h=0;h<ft;h++){const o=I();C(o,r,s,a);const m=this.getSceneDistance(t,o,n,c);if(a+=m,i[n]+=1,m<xt||a>Q)break}return a}}const pt=200,V=10,vt=.001,St=.1;class Pt extends H{runRaymarcher(t,r,s,n,c,i,a,h,o=0,m=a){const f=t.camera.getRotationMatrix(R()),l=$();Y(l,f);const v=I();t.camera.getPosition(v);for(let x=o;x<m;x++){const b=x-o,y=(x/a-.5)*2;for(let S=0;S<i;S++){const g=b*i+S,M=g*3;n[g]=0,c[g]=0;const A=(S/i-.5)*2,P=p(A,y,-1);W(P,P,l),j(P,P);const D=this.fixedStepMarch(t,v,P,g,n,c),z=I();C(z,v,P,D);let T;D>=V?T=p(0,0,0):T=this.getNormal(t,z,g,n),s[M]=(T[0]+1)*.5*255,s[M+1]=(T[1]+1)*.5*255,s[M+2]=(T[2]+1)*.5*255,r[g]=D}}}getSceneDistance(t,r,s,n){const c={count:0},i=t.getDistance(r,c);return n[s]+=c.count,i}getNormal(t,r,s,n){let c=this.getSceneDistance(t,r,s,n);const i=[.01,0,0],a=I();return a[0]=c-this.getSceneDistance(t,p(r[0]-i[0],r[1],r[2]),s,n),a[1]=c-this.getSceneDistance(t,p(r[0],r[1]-i[0],r[2]),s,n),a[2]=c-this.getSceneDistance(t,p(r[0],r[1],r[2]-i[0]),s,n),j(a,a),a}fixedStepMarch(t,r,s,n,c,i){let a=0,h=!1;for(let o=0;o<pt;o++){const m=I();C(m,r,s,a);const f=this.getSceneDistance(t,m,n,c);if(i[n]+=1,f<vt){h=!0;break}if(a+=St,a>V)break}return h?a:V}}const gt=200,J=10,yt=.001,B=.1,bt=.8,_=B*.25,tt=B*5,Tt=.1,Dt=.01;class Mt extends H{runRaymarcher(t,r,s,n,c,i,a,h,o=0,m=a){const f=t.camera.getRotationMatrix(R()),l=$();Y(l,f);const v=I();t.camera.getPosition(v);for(let x=o;x<m;x++){const b=x-o,y=(x/a-.5)*2;for(let S=0;S<i;S++){const g=b*i+S,M=g*3;n[g]=0,c[g]=0;const A=(S/i-.5)*2,P=p(A,y,-1);W(P,P,l),j(P,P);const D=this.adaptiveStepMarch(t,v,P,g,n,c),z=I();C(z,v,P,D);let T;D>=J?T=p(0,0,0):T=this.getNormal(t,z,g,n),s[M]=(T[0]+1)*.5*255,s[M+1]=(T[1]+1)*.5*255,s[M+2]=(T[2]+1)*.5*255,r[g]=D}}}getSceneDistance(t,r,s,n){const c={count:0},i=t.getDistance(r,c);return n[s]+=c.count,i}getNormal(t,r,s,n){let c=this.getSceneDistance(t,r,s,n);const i=[.01,0,0],a=I();return a[0]=c-this.getSceneDistance(t,p(r[0]-i[0],r[1],r[2]),s,n),a[1]=c-this.getSceneDistance(t,p(r[0],r[1]-i[0],r[2]),s,n),a[2]=c-this.getSceneDistance(t,p(r[0],r[1],r[2]-i[0]),s,n),j(a,a),a}adaptiveStepMarch(t,r,s,n,c,i){let a=0,h=!1;for(let o=0;o<gt;o++){const m=I();C(m,r,s,a);const f=this.getSceneDistance(t,m,n,c);if(i[n]+=1,f<yt){h=!0;break}let l;if(f<Tt?l=Dt:(l=bt*f,l<_&&(l=_),l>tt&&(l=tt)),a+=l,a>J)break}return h?a:J}}self.onmessage=e=>{const{width:t,height:r,time:s,yStart:n,yEnd:c,camera:i,algorithm:a,scenePresetIndex:h,accelerationStructure:o}=e.data,m=new dt(o);m.loadPreset(h),m.camera.setAngles(i.pitch,i.yaw);const f=Math.max(0,c-n),l=new Uint8ClampedArray(t*f),v=new Uint8ClampedArray(t*f*3),x=new Uint16Array(t*f),b=new Uint16Array(t*f);let y;switch(a){case"sphere-tracer":y=new F;break;case"fixed-step":y=new Pt;break;case"adaptive-step":y=new Mt;break;default:y=new F}y.runRaymarcher(m,l,v,x,b,t,r,s,n,c);const S={yStart:n,yEnd:c,depth:l,normal:v,sdfEval:x,iters:b};self.postMessage(S,[l.buffer,v.buffer,x.buffer,b.buffer])}})();
