(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();var R=typeof Float32Array<"u"?Float32Array:Array;function D(){var r=new R(16);return R!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function Z(r,e){var t=e[0],n=e[1],s=e[2],a=e[3],c=e[4],i=e[5],l=e[6],o=e[7],h=e[8],m=e[9],p=e[10],g=e[11],S=e[12],w=e[13],u=e[14],M=e[15],I=t*i-n*c,d=t*l-s*c,v=t*o-a*c,f=n*l-s*i,y=n*o-a*i,z=s*o-a*l,E=h*w-m*S,A=h*u-p*S,O=h*M-g*S,U=m*u-p*w,q=m*M-g*w,B=p*M-g*u,P=I*B-d*q+v*U+f*O-y*A+z*E;return P?(P=1/P,r[0]=(i*B-l*q+o*U)*P,r[1]=(s*q-n*B-a*U)*P,r[2]=(w*z-u*y+M*f)*P,r[3]=(p*y-m*z-g*f)*P,r[4]=(l*O-c*B-o*A)*P,r[5]=(t*B-s*O+a*A)*P,r[6]=(u*v-S*z-M*d)*P,r[7]=(h*z-p*v+g*d)*P,r[8]=(c*q-i*O+o*E)*P,r[9]=(n*O-t*q-a*E)*P,r[10]=(S*y-w*v+M*I)*P,r[11]=(m*v-h*y-g*I)*P,r[12]=(i*A-c*U-l*E)*P,r[13]=(t*U-n*A+s*E)*P,r[14]=(w*d-S*f-u*I)*P,r[15]=(h*f-m*d+p*I)*P,r):null}function he(r,e,t){var n=e[0],s=e[1],a=e[2],c=e[3],i=e[4],l=e[5],o=e[6],h=e[7],m=e[8],p=e[9],g=e[10],S=e[11],w=e[12],u=e[13],M=e[14],I=e[15],d=t[0],v=t[1],f=t[2],y=t[3];return r[0]=d*n+v*i+f*m+y*w,r[1]=d*s+v*l+f*p+y*u,r[2]=d*a+v*o+f*g+y*M,r[3]=d*c+v*h+f*S+y*I,d=t[4],v=t[5],f=t[6],y=t[7],r[4]=d*n+v*i+f*m+y*w,r[5]=d*s+v*l+f*p+y*u,r[6]=d*a+v*o+f*g+y*M,r[7]=d*c+v*h+f*S+y*I,d=t[8],v=t[9],f=t[10],y=t[11],r[8]=d*n+v*i+f*m+y*w,r[9]=d*s+v*l+f*p+y*u,r[10]=d*a+v*o+f*g+y*M,r[11]=d*c+v*h+f*S+y*I,d=t[12],v=t[13],f=t[14],y=t[15],r[12]=d*n+v*i+f*m+y*w,r[13]=d*s+v*l+f*p+y*u,r[14]=d*a+v*o+f*g+y*M,r[15]=d*c+v*h+f*S+y*I,r}function le(r,e,t){var n=t[0],s=t[1],a=t[2],c,i,l,o,h,m,p,g,S,w,u,M;return e===r?(r[12]=e[0]*n+e[4]*s+e[8]*a+e[12],r[13]=e[1]*n+e[5]*s+e[9]*a+e[13],r[14]=e[2]*n+e[6]*s+e[10]*a+e[14],r[15]=e[3]*n+e[7]*s+e[11]*a+e[15]):(c=e[0],i=e[1],l=e[2],o=e[3],h=e[4],m=e[5],p=e[6],g=e[7],S=e[8],w=e[9],u=e[10],M=e[11],r[0]=c,r[1]=i,r[2]=l,r[3]=o,r[4]=h,r[5]=m,r[6]=p,r[7]=g,r[8]=S,r[9]=w,r[10]=u,r[11]=M,r[12]=c*n+h*s+S*a+e[12],r[13]=i*n+m*s+w*a+e[13],r[14]=l*n+p*s+u*a+e[14],r[15]=o*n+g*s+M*a+e[15]),r}function me(r,e,t){var n=Math.sin(t),s=Math.cos(t),a=e[4],c=e[5],i=e[6],l=e[7],o=e[8],h=e[9],m=e[10],p=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=a*s+o*n,r[5]=c*s+h*n,r[6]=i*s+m*n,r[7]=l*s+p*n,r[8]=o*s-a*n,r[9]=h*s-c*n,r[10]=m*s-i*n,r[11]=p*s-l*n,r}function pe(r,e,t){var n=Math.sin(t),s=Math.cos(t),a=e[0],c=e[1],i=e[2],l=e[3],o=e[8],h=e[9],m=e[10],p=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=a*s-o*n,r[1]=c*s-h*n,r[2]=i*s-m*n,r[3]=l*s-p*n,r[8]=a*n+o*s,r[9]=c*n+h*s,r[10]=i*n+m*s,r[11]=l*n+p*s,r}function G(r,e,t,n){var s=e[0],a=e[1],c=e[2],i=e[3],l=s+s,o=a+a,h=c+c,m=s*l,p=s*o,g=s*h,S=a*o,w=a*h,u=c*h,M=i*l,I=i*o,d=i*h,v=n[0],f=n[1],y=n[2];return r[0]=(1-(S+u))*v,r[1]=(p+d)*v,r[2]=(g-I)*v,r[3]=0,r[4]=(p-d)*f,r[5]=(1-(m+u))*f,r[6]=(w+M)*f,r[7]=0,r[8]=(g+I)*y,r[9]=(w-M)*y,r[10]=(1-(m+S))*y,r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r}function Y(){var r=new R(3);return R!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function de(r){var e=new R(3);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e}function ae(r){var e=r[0],t=r[1],n=r[2];return Math.sqrt(e*e+t*t+n*n)}function C(r,e,t){var n=new R(3);return n[0]=r,n[1]=e,n[2]=t,n}function fe(r,e,t){return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r}function ve(r,e,t){return r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r}function W(r,e){var t=e[0],n=e[1],s=e[2],a=t*t+n*n+s*s;return a>0&&(a=1/Math.sqrt(a)),r[0]=e[0]*a,r[1]=e[1]*a,r[2]=e[2]*a,r}function V(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]}function xe(r,e,t){var n=e[0],s=e[1],a=e[2],c=t[3]*n+t[7]*s+t[11]*a+t[15];return c=c||1,r[0]=(t[0]*n+t[4]*s+t[8]*a+t[12])/c,r[1]=(t[1]*n+t[5]*s+t[9]*a+t[13])/c,r[2]=(t[2]*n+t[6]*s+t[10]*a+t[14])/c,r}(function(){var r=Y();return function(e,t,n,s,a,c){var i,l;for(t||(t=3),n||(n=0),s?l=Math.min(s*t+n,e.length):l=e.length,i=n;i<l;i+=t)r[0]=e[i],r[1]=e[i+1],r[2]=e[i+2],a(r,r,c),e[i]=r[0],e[i+1]=r[1],e[i+2]=r[2];return e}})();class ye{constructor(){this.orbitCentre=D(),this.cameraDistance=5,this.pitch=0,this.yaw=0,this.cameraTransform=D(),this.updateCameraTransform()}rotateCamera(e,t){this.pitch=Math.min(Math.max(this.pitch+e,-Math.PI/2),Math.PI/2),this.yaw+=t,this.updateCameraTransform()}getAngles(){return[this.pitch,this.yaw]}setAngles(e,t){this.pitch=Math.min(Math.max(e,-Math.PI/2),Math.PI/2),this.yaw=t,this.updateCameraTransform()}getPosition(e){return e[0]=this.cameraTransform[12],e[1]=this.cameraTransform[13],e[2]=this.cameraTransform[14],e}transformDirection(e,t){const n=this.cameraTransform,s=t[0],a=t[1],c=t[2];return e[0]=n[0]*s+n[4]*a+n[8]*c,e[1]=n[1]*s+n[5]*a+n[9]*c,e[2]=n[2]*s+n[6]*a+n[10]*c,e}updateCameraTransform(){const e=D();pe(e,D(),this.yaw),me(this.orbitCentre,e,this.pitch),le(this.cameraTransform,this.orbitCentre,C(0,0,Math.abs(this.cameraDistance)))}}class Q{constructor(e){this.transform=e,this.invSceneTransform=D()}updateInverseSceneTransform(e){const t=D();Z(t,e),he(this.invSceneTransform,t,this.transform),Z(this.invSceneTransform,this.invSceneTransform)}sdf(e){const t=Y();return xe(t,e,this.invSceneTransform),this.localSdf(t)}}class ge extends Q{constructor(e,t){super(e),this.radius=t}localSdf(e){return ae(e)-this.radius}}class Se extends Q{constructor(e,t){super(e),this.halfSize=de(t)}localSdf(e){const t=C(Math.abs(e[0])-this.halfSize[0],Math.abs(e[1])-this.halfSize[1],Math.abs(e[2])-this.halfSize[2]),n=C(Math.max(t[0],0),Math.max(t[1],0),Math.max(t[2],0)),s=ae(n),a=Math.min(Math.max(t[0],Math.max(t[1],t[2])),0);return s+a}}class we extends Q{constructor(e,t,n){super(e),this.majorRadius=t,this.minorRadius=n}localSdf(e){const t=e[0],n=e[1],s=e[2],a=Math.sqrt(t*t+s*s)-this.majorRadius,c=n;return Math.sqrt(a*a+c*c)-this.minorRadius}}const x=class x{static createSphere(e,t,n,s){const a=D();return G(a,[0,0,0,1],[e,t,n],[1,1,1]),new ge(a,s)}static createBox(e,t,n,s){const a=D();return G(a,[0,0,0,1],[e,t,n],[1,1,1]),new Se(a,s)}static createTorus(e,t,n,s){const a=D();return G(a,[0,0,0,1],[e,t,n],[1,1,1]),new we(a,s,s/4)}static getPreset(e){return this.presets[Math.max(0,Math.min(e,this.presets.length-1))]}static getPresetCount(){return this.presets.length}static populateSceneDropdown(e,t=0){e.innerHTML="";for(let n=0;n<this.presets.length;n++){const s=this.getPreset(n),a=document.createElement("option");a.value=n.toString(),a.textContent=s.name,a.selected=n===t,e.appendChild(a)}}};x.presets=[{name:"Single sphere",objects:[x.createSphere(0,0,0,1.5)]},{name:"Grid of spheres",objects:[x.createSphere(-1,-1,0,.3),x.createSphere(0,-1,0,.3),x.createSphere(1,-1,0,.3),x.createSphere(-1,0,0,.3),x.createSphere(0,0,0,.3),x.createSphere(1,0,0,.3),x.createSphere(-1,1,0,.3),x.createSphere(0,1,0,.3),x.createSphere(1,1,0,.3)]},{name:"Atom",objects:[x.createSphere(0,0,0,.5),x.createSphere(1.2,0,0,.3),x.createSphere(-1.2,0,0,.3),x.createSphere(0,1.2,0,.3),x.createSphere(0,-1.2,0,.3),x.createSphere(0,0,1.2,.3),x.createSphere(0,0,-1.2,.3)]},{name:"Random spheres",objects:[x.createSphere(.8,-.3,.2,.4),x.createSphere(-.5,.9,-.1,.5),x.createSphere(.2,.1,.8,.3),x.createSphere(-.9,-.4,-.6,.6),x.createSphere(.4,-.8,.5,.35),x.createSphere(-.2,.6,-.9,.4),x.createSphere(.7,.3,-.4,.25)]},{name:"Cube",objects:[x.createBox(0,0,0,C(1,1,1))]},{name:"Sphere and Cube",objects:[x.createSphere(-.7,0,0,.5),x.createBox(1,0,0,C(.5,.5,.5))]},{name:"Pyramid of Boxes",objects:[x.createBox(0,.5,0,C(.9,.25,.9)),x.createBox(0,0,0,C(.6,.25,.6)),x.createBox(0,-.5,0,C(.3,.25,.3))]},{name:"Torus",objects:[x.createTorus(0,0,0,1.3)]}];let F=x;class Me{constructor(){this.currentPresetIndex=0,this.camera=new ye,this.objectSDFs=new Array,this.loadPreset(0)}loadPreset(e){this.currentPresetIndex=Math.max(0,Math.min(e,F.getPresetCount()-1));const t=F.getPreset(this.currentPresetIndex);this.objectSDFs=[...t.objects]}nextPreset(){this.loadPreset(Math.min(this.currentPresetIndex+1,F.getPresetCount()))}previousPreset(){this.loadPreset(Math.max(this.currentPresetIndex-1,0))}getCurrentPresetInfo(){const e=F.getPreset(this.currentPresetIndex);return{index:this.currentPresetIndex,name:e.name,total:F.getPresetCount()}}updateInverseSceneTransforms(){for(const e of this.objectSDFs)e.updateInverseSceneTransform(this.camera.cameraTransform)}}class K{}class ue extends K{shade(e,t,n,s,a,c,i){const l=C(1,-1,1.5);W(l,l);const o=Y(),h=Y(),m=C(0,0,1),p=.1,g=.5,S=32;for(let w=0;w<i;w++)for(let u=0;u<c;u++){const M=w*c+u,I=M*3,d=M*4,v=t[M];if(v>=255){e[d+0]=10,e[d+1]=10,e[d+2]=20,e[d+3]=255;continue}o[0]=n[I]/127.5-1,o[1]=n[I+1]/127.5-1,o[2]=n[I+2]/127.5-1,W(o,o);const f=Math.max(V(o,l),0);ve(h,o,2*V(o,l)),fe(h,h,l),W(h,h);const y=g*Math.pow(Math.max(V(m,h),0),S),z=Math.min(p+f+y,1),E=1-v/255,A=255*z*E;e[d+0]=A,e[d+1]=A,e[d+2]=A,e[d+3]=255}return e}}class X extends K{shade(e,t,n,s,a,c,i){for(let l=0;l<i;l++)for(let o=0;o<c;o++){const h=l*c+o,m=h*3,p=h*4;e[p]=n[m],e[p+1]=n[m+1],e[p+2]=n[m+2],e[p+3]=255}return e}}class Ie extends K{shade(e,t,n,s,a,c,i){const o=C(1,-1,1.5);W(o,o);for(let h=0;h<i;h++)for(let m=0;m<c;m++){const p=h*c+m,g=p*4,S=s[p]*5%256;e[g+0]=Math.min(2*S,255),e[g+1]=Math.min(-2*S+512,255),e[g+2]=0,e[g+3]=255}return e}}class Pe extends K{shade(e,t,n,s,a,c,i){const o=C(1,-1,1.5);W(o,o);for(let h=0;h<i;h++)for(let m=0;m<c;m++){const p=h*c+m,g=p*4,S=a[p]*5%256;e[g+0]=Math.min(2*S,255),e[g+1]=Math.min(-2*S+512,255),e[g+2]=0,e[g+3]=255}return e}}const N=document.getElementById("shader-canvas"),be=N.getContext("2d"),T=N.width,b=N.height,Ce=document.getElementById("fps"),Te=document.getElementById("status");let k=new X;document.getElementById("shading-models").addEventListener("change",r=>{switch(r.target.value){case"phong":k=new ue;break;case"normal":k=new X;break;case"sdf-heatmap":k=new Ie;break;case"iteration-heatmap":k=new Pe;break;default:k=new X}});let H="sphere-tracer";document.getElementById("algorithm").addEventListener("change",r=>{switch(r.target.value){case"sphere-tracer":H="sphere-tracer";break;case"fixed-step":H="fixed-step";break;default:H="sphere-tracer"}});let _=performance.now();const L=new Me,ce=document.getElementById("scene-select");ce.addEventListener("change",r=>{const e=parseInt(r.target.value);L.loadPreset(e)});const Ae=L.getCurrentPresetInfo();F.populateSceneDropdown(ce,Ae.index);const ie=Math.max(1,Math.min(4,(navigator.hardwareConcurrency||4)-1)),De=Array.from({length:ie},()=>new Worker(new URL("/raymarcher-test/assets/raymarchWorker-C5_W1wH6.js",import.meta.url),{type:"module"})),ee=new Uint8ClampedArray(T*b),re=new Uint8ClampedArray(T*b*3),te=new Uint16Array(T*b),ne=new Uint16Array(T*b),se=new Uint8ClampedArray(T*b*4);let j=1;function J(){N.style.width=`${T*j}px`,N.style.height=`${b*j}px`,Te.textContent=`Status: scale ${j.toFixed(2)}x`}J();async function oe(r){const e=Math.ceil(b/ie),[t,n]=L.camera.getAngles(),s=De.map((i,l)=>{const o=Math.min(l*e,b),h=Math.min((l+1)*e,b);return o>=h?Promise.resolve(null):new Promise(m=>{const p=S=>{i.removeEventListener("message",p);const{yStart:w,yEnd:u,depth:M,normal:I,sdfEval:d,iters:v}=S.data,f=w*T;ee.set(M,f),te.set(d,f),ne.set(v,f);const y=w*T*3;re.set(I,y),m(null)};i.addEventListener("message",p);const g=L.getCurrentPresetInfo();i.postMessage({width:T,height:b,time:r,yStart:o,yEnd:h,camera:{pitch:t,yaw:n},algorithm:H,scenePresetIndex:g.index})})});await Promise.all(s),k.shade(se,ee,re,te,ne,T,b);const a=new ImageData(se,T,b);be.putImageData(a,0,0);const c=performance.now();Ce.textContent=`Frame length: ${(c-_).toPrecision(4)}`,_=c,L.updateInverseSceneTransforms(),requestAnimationFrame(oe)}window.addEventListener("keydown",r=>{switch(r.key){case"ArrowUp":$(0,.1);break;case"ArrowDown":$(0,-.1);break;case"ArrowLeft":$(.1,0);break;case"ArrowRight":$(-.1,0);break;case"-":case"_":j=Math.max(.25,j-.25),J();break;case"+":case"=":j=Math.min(8,j+.25),J();break}});function $(r,e){L.camera.rotateCamera(-e,r),L.updateInverseSceneTransforms()}requestAnimationFrame(oe);
