var le=Object.defineProperty;var fe=(j,D,N)=>D in j?le(j,D,{enumerable:!0,configurable:!0,writable:!0,value:N}):j[D]=N;var I=(j,D,N)=>fe(j,typeof D!="symbol"?D+"":D,N);(function(){"use strict";var j=typeof Float32Array<"u"?Float32Array:Array;function D(){var r=new j(16);return j!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function N(r,e){var t=e[0],s=e[1],a=e[2],n=e[3],c=e[4],i=e[5],f=e[6],m=e[7],o=e[8],S=e[9],h=e[10],g=e[11],M=e[12],d=e[13],T=e[14],P=e[15],b=t*i-s*c,x=t*f-a*c,v=t*m-n*c,l=s*f-a*i,y=s*m-n*i,E=a*m-n*f,z=o*d-S*M,Y=o*T-h*M,A=o*P-g*M,k=S*T-h*d,F=S*P-g*d,L=h*P-g*T,w=b*L-x*F+v*k+l*A-y*Y+E*z;return w?(w=1/w,r[0]=(i*L-f*F+m*k)*w,r[1]=(a*F-s*L-n*k)*w,r[2]=(d*E-T*y+P*l)*w,r[3]=(h*y-S*E-g*l)*w,r[4]=(f*A-c*L-m*Y)*w,r[5]=(t*L-a*A+n*Y)*w,r[6]=(T*v-M*E-P*x)*w,r[7]=(o*E-h*v+g*x)*w,r[8]=(c*F-i*A+m*z)*w,r[9]=(s*A-t*F-n*z)*w,r[10]=(M*y-d*v+P*b)*w,r[11]=(S*v-o*y-g*b)*w,r[12]=(i*Y-c*k-f*z)*w,r[13]=(t*k-s*Y+a*z)*w,r[14]=(d*x-M*l-T*b)*w,r[15]=(o*l-S*x+h*b)*w,r):null}function K(r,e,t){var s=e[0],a=e[1],n=e[2],c=e[3],i=e[4],f=e[5],m=e[6],o=e[7],S=e[8],h=e[9],g=e[10],M=e[11],d=e[12],T=e[13],P=e[14],b=e[15],x=t[0],v=t[1],l=t[2],y=t[3];return r[0]=x*s+v*i+l*S+y*d,r[1]=x*a+v*f+l*h+y*T,r[2]=x*n+v*m+l*g+y*P,r[3]=x*c+v*o+l*M+y*b,x=t[4],v=t[5],l=t[6],y=t[7],r[4]=x*s+v*i+l*S+y*d,r[5]=x*a+v*f+l*h+y*T,r[6]=x*n+v*m+l*g+y*P,r[7]=x*c+v*o+l*M+y*b,x=t[8],v=t[9],l=t[10],y=t[11],r[8]=x*s+v*i+l*S+y*d,r[9]=x*a+v*f+l*h+y*T,r[10]=x*n+v*m+l*g+y*P,r[11]=x*c+v*o+l*M+y*b,x=t[12],v=t[13],l=t[14],y=t[15],r[12]=x*s+v*i+l*S+y*d,r[13]=x*a+v*f+l*h+y*T,r[14]=x*n+v*m+l*g+y*P,r[15]=x*c+v*o+l*M+y*b,r}function Q(r,e,t){var s=t[0],a=t[1],n=t[2],c,i,f,m,o,S,h,g,M,d,T,P;return e===r?(r[12]=e[0]*s+e[4]*a+e[8]*n+e[12],r[13]=e[1]*s+e[5]*a+e[9]*n+e[13],r[14]=e[2]*s+e[6]*a+e[10]*n+e[14],r[15]=e[3]*s+e[7]*a+e[11]*n+e[15]):(c=e[0],i=e[1],f=e[2],m=e[3],o=e[4],S=e[5],h=e[6],g=e[7],M=e[8],d=e[9],T=e[10],P=e[11],r[0]=c,r[1]=i,r[2]=f,r[3]=m,r[4]=o,r[5]=S,r[6]=h,r[7]=g,r[8]=M,r[9]=d,r[10]=T,r[11]=P,r[12]=c*s+o*a+M*n+e[12],r[13]=i*s+S*a+d*n+e[13],r[14]=f*s+h*a+T*n+e[14],r[15]=m*s+g*a+P*n+e[15]),r}function B(r,e,t){var s=Math.sin(t),a=Math.cos(t),n=e[4],c=e[5],i=e[6],f=e[7],m=e[8],o=e[9],S=e[10],h=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=n*a+m*s,r[5]=c*a+o*s,r[6]=i*a+S*s,r[7]=f*a+h*s,r[8]=m*a-n*s,r[9]=o*a-c*s,r[10]=S*a-i*s,r[11]=h*a-f*s,r}function u(r,e,t){var s=Math.sin(t),a=Math.cos(t),n=e[0],c=e[1],i=e[2],f=e[3],m=e[8],o=e[9],S=e[10],h=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=n*a-m*s,r[1]=c*a-o*s,r[2]=i*a-S*s,r[3]=f*a-h*s,r[8]=n*s+m*a,r[9]=c*s+o*a,r[10]=i*s+S*a,r[11]=f*s+h*a,r}function O(r,e,t,s){var a=e[0],n=e[1],c=e[2],i=e[3],f=a+a,m=n+n,o=c+c,S=a*f,h=a*m,g=a*o,M=n*m,d=n*o,T=c*o,P=i*f,b=i*m,x=i*o,v=s[0],l=s[1],y=s[2];return r[0]=(1-(M+T))*v,r[1]=(h+x)*v,r[2]=(g-b)*v,r[3]=0,r[4]=(h-x)*l,r[5]=(1-(S+T))*l,r[6]=(d+P)*l,r[7]=0,r[8]=(g+b)*y,r[9]=(d-P)*y,r[10]=(1-(S+M))*y,r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r}function R(){var r=new j(3);return j!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function _(r){var e=new j(3);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e}function H(r){var e=r[0],t=r[1],s=r[2];return Math.sqrt(e*e+t*t+s*s)}function C(r,e,t){var s=new j(3);return s[0]=r,s[1]=e,s[2]=t,s}function ee(r,e,t,s){return r[0]=e,r[1]=t,r[2]=s,r}function G(r,e,t){return r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r}function U(r,e){var t=e[0],s=e[1],a=e[2],n=t*t+s*s+a*a;return n>0&&(n=1/Math.sqrt(n)),r[0]=e[0]*n,r[1]=e[1]*n,r[2]=e[2]*n,r}function re(r,e,t){var s=e[0],a=e[1],n=e[2],c=t[3]*s+t[7]*a+t[11]*n+t[15];return c=c||1,r[0]=(t[0]*s+t[4]*a+t[8]*n+t[12])/c,r[1]=(t[1]*s+t[5]*a+t[9]*n+t[13])/c,r[2]=(t[2]*s+t[6]*a+t[10]*n+t[14])/c,r}(function(){var r=R();return function(e,t,s,a,n,c){var i,f;for(t||(t=3),s||(s=0),a?f=Math.min(a*t+s,e.length):f=e.length,i=s;i<f;i+=t)r[0]=e[i],r[1]=e[i+1],r[2]=e[i+2],n(r,r,c),e[i]=r[0],e[i+1]=r[1],e[i+2]=r[2];return e}})();class te{constructor(){I(this,"orbitCentre");I(this,"cameraDistance");I(this,"cameraTransform");I(this,"pitch");I(this,"yaw");this.orbitCentre=D(),this.cameraDistance=5,this.pitch=0,this.yaw=0,this.cameraTransform=D(),this.updateCameraTransform()}rotateCamera(e,t){this.pitch=Math.min(Math.max(this.pitch+e,-Math.PI/2),Math.PI/2),this.yaw+=t,this.updateCameraTransform()}getAngles(){return[this.pitch,this.yaw]}setAngles(e,t){this.pitch=Math.min(Math.max(e,-Math.PI/2),Math.PI/2),this.yaw=t,this.updateCameraTransform()}getPosition(e){return e[0]=this.cameraTransform[12],e[1]=this.cameraTransform[13],e[2]=this.cameraTransform[14],e}transformDirection(e,t){const s=this.cameraTransform,a=t[0],n=t[1],c=t[2];return e[0]=s[0]*a+s[4]*n+s[8]*c,e[1]=s[1]*a+s[5]*n+s[9]*c,e[2]=s[2]*a+s[6]*n+s[10]*c,e}updateCameraTransform(){const e=D();u(e,D(),this.yaw),B(this.orbitCentre,e,this.pitch),Q(this.cameraTransform,this.orbitCentre,C(0,0,Math.abs(this.cameraDistance)))}}class ${constructor(e){I(this,"transform");I(this,"invSceneTransform");this.transform=e,this.invSceneTransform=D()}updateInverseSceneTransform(e){const t=D();N(t,e),K(this.invSceneTransform,t,this.transform),N(this.invSceneTransform,this.invSceneTransform)}sdf(e){const t=R();return re(t,e,this.invSceneTransform),this.localSdf(t)}}class se extends ${constructor(t,s){super(t);I(this,"radius");this.radius=s}localSdf(t){return H(t)-this.radius}}class ae extends ${constructor(t,s){super(t);I(this,"halfSize");this.halfSize=_(s)}localSdf(t){const s=C(Math.abs(t[0])-this.halfSize[0],Math.abs(t[1])-this.halfSize[1],Math.abs(t[2])-this.halfSize[2]),a=C(Math.max(s[0],0),Math.max(s[1],0),Math.max(s[2],0)),n=H(a),c=Math.min(Math.max(s[0],Math.max(s[1],s[2])),0);return n+c}}class ne extends ${constructor(t,s,a){super(t);I(this,"majorRadius");I(this,"minorRadius");this.majorRadius=s,this.minorRadius=a}localSdf(t){const s=t[0],a=t[1],n=t[2],c=Math.sqrt(s*s+n*n)-this.majorRadius,i=a;return Math.sqrt(c*c+i*i)-this.minorRadius}}const p=class p{static createSphere(e,t,s,a){const n=D();return O(n,[0,0,0,1],[e,t,s],[1,1,1]),new se(n,a)}static createBox(e,t,s,a){const n=D();return O(n,[0,0,0,1],[e,t,s],[1,1,1]),new ae(n,a)}static createTorus(e,t,s,a){const n=D();return O(n,[0,0,0,1],[e,t,s],[1,1,1]),new ne(n,a,a/4)}static getPreset(e){return this.presets[Math.max(0,Math.min(e,this.presets.length-1))]}static getPresetCount(){return this.presets.length}static populateSceneDropdown(e,t=0){e.innerHTML="";for(let s=0;s<this.presets.length;s++){const a=this.getPreset(s),n=document.createElement("option");n.value=s.toString(),n.textContent=a.name,n.selected=s===t,e.appendChild(n)}}};I(p,"presets",[{name:"Single sphere",objects:[p.createSphere(0,0,0,1.5)]},{name:"Grid of spheres",objects:[p.createSphere(-1,-1,0,.3),p.createSphere(0,-1,0,.3),p.createSphere(1,-1,0,.3),p.createSphere(-1,0,0,.3),p.createSphere(0,0,0,.3),p.createSphere(1,0,0,.3),p.createSphere(-1,1,0,.3),p.createSphere(0,1,0,.3),p.createSphere(1,1,0,.3)]},{name:"Atom",objects:[p.createSphere(0,0,0,.5),p.createSphere(1.2,0,0,.3),p.createSphere(-1.2,0,0,.3),p.createSphere(0,1.2,0,.3),p.createSphere(0,-1.2,0,.3),p.createSphere(0,0,1.2,.3),p.createSphere(0,0,-1.2,.3)]},{name:"Random spheres",objects:[p.createSphere(.8,-.3,.2,.4),p.createSphere(-.5,.9,-.1,.5),p.createSphere(.2,.1,.8,.3),p.createSphere(-.9,-.4,-.6,.6),p.createSphere(.4,-.8,.5,.35),p.createSphere(-.2,.6,-.9,.4),p.createSphere(.7,.3,-.4,.25)]},{name:"Cube",objects:[p.createBox(0,0,0,C(1,1,1))]},{name:"Sphere and Cube",objects:[p.createSphere(-.7,0,0,.5),p.createBox(1,0,0,C(.5,.5,.5))]},{name:"Pyramid of Boxes",objects:[p.createBox(0,.5,0,C(.9,.25,.9)),p.createBox(0,0,0,C(.6,.25,.6)),p.createBox(0,-.5,0,C(.3,.25,.3))]},{name:"Torus",objects:[p.createTorus(0,0,0,1.3)]}]);let X=p;class ce{constructor(){I(this,"objectSDFs");I(this,"camera");I(this,"currentPresetIndex",0);this.camera=new te,this.objectSDFs=new Array,this.loadPreset(0)}loadPreset(e){this.currentPresetIndex=Math.max(0,Math.min(e,X.getPresetCount()-1));const t=X.getPreset(this.currentPresetIndex);this.objectSDFs=[...t.objects]}nextPreset(){this.loadPreset(Math.min(this.currentPresetIndex+1,X.getPresetCount()))}previousPreset(){this.loadPreset(Math.max(this.currentPresetIndex-1,0))}getCurrentPresetInfo(){const e=X.getPreset(this.currentPresetIndex);return{index:this.currentPresetIndex,name:e.name,total:X.getPresetCount()}}updateInverseSceneTransforms(){for(const e of this.objectSDFs)e.updateInverseSceneTransform(this.camera.cameraTransform)}}class V{}const ie=100,W=500,he=.001;class Z extends V{runRaymarcher(e,t,s,a,n,c,i,f,m=0,o=i){for(let S=m;S<o;S++){const h=S-m,g=S/i-.5;for(let M=0;M<c;M++){const d=h*c+M,T=d*3;a[d]=0,n[d]=0;const P=R(),b=M/c-.5;U(P,C(b,g,-1));const x=this.rayMarch(e,P,d,a,n),v=R();G(v,P,x);const l=this.getNormal(e,v,d,a);s[T]=(l[0]+1)*.5*255,s[T+1]=(l[1]+1)*.5*255,s[T+2]=(l[2]+1)*.5*255,t[d]=x}}}getSceneDistance(e,t,s,a){a[s]+=1;let n=W;for(const c of e.objectSDFs)n=Math.min(c.sdf(t),n);return n}getNormal(e,t,s,a){let n=this.getSceneDistance(e,t,s,a);const c=[.01,0,0],i=R();return i[0]=n-this.getSceneDistance(e,C(t[0]-c[0],t[1],t[2]),s,a),i[1]=n-this.getSceneDistance(e,C(t[0],t[1]-c[0],t[2]),s,a),i[2]=n-this.getSceneDistance(e,C(t[0],t[1],t[2]-c[0]),s,a),U(i,i),i}rayMarch(e,t,s,a,n){let c=0;for(let i=0;i<ie;i++){const f=C(0,0,0);G(f,t,c);let m=this.getSceneDistance(e,f,s,a);if(c+=m,c>W||m<he)break;n[s]+=1}return Math.min(c,255)}}const q=10,J=.2,me=.01;class ve extends V{runRaymarcher(e,t,s,a,n,c,i,f,m=0,o=i){const S=Math.ceil(q/J),h=R(),g=R(),M=R();for(let d=m;d<o;d++){const T=d-m,P=d/i-.5;for(let b=0;b<c;b++){const x=b/c-.5;ee(h,x,P,-1),U(h,h),e.camera.transformDirection(h,h),U(h,h),e.camera.getPosition(M);let v=0,l=0,y=0,E=!1;for(;l<S&&v<=q;l++,v+=J){g[0]=M[0]+h[0]*v,g[1]=M[1]+h[1]*v,g[2]=M[2]+h[2]*v;let A=q;for(const k of e.objectSDFs){const F=k.sdf(g);F<A&&(A=F),y++}if(A<me){E=!0;break}}const z=T*c+b,Y=Math.min(v,q);if(t[z]=Math.round(255*Y/q),n[z]=l,a[z]=y,E){const A=this.getNormal(e,g);s[z*3+0]=Math.round((A[0]*.5+.5)*255),s[z*3+1]=Math.round((A[1]*.5+.5)*255),s[z*3+2]=Math.round((A[2]*.5+.5)*255)}else s[z*3+0]=127,s[z*3+1]=127,s[z*3+2]=255}}}getSceneDistance(e,t){let s=q;for(const a of e.objectSDFs)s=Math.min(a.sdf(t),s);return s}getNormal(e,t){let s=this.getSceneDistance(e,t);const a=[.01,0,0],n=R();return n[0]=s-this.getSceneDistance(e,C(t[0]-a[0],t[1],t[2])),n[1]=s-this.getSceneDistance(e,C(t[0],t[1]-a[0],t[2])),n[2]=s-this.getSceneDistance(e,C(t[0],t[1],t[2]-a[0])),U(n,n),n}}self.onmessage=r=>{const{width:e,height:t,time:s,yStart:a,yEnd:n,camera:c,algorithm:i,scenePresetIndex:f}=r.data,m=new ce;m.loadPreset(f),m.camera.setAngles(c.pitch,c.yaw),m.updateInverseSceneTransforms();const o=Math.max(0,n-a),S=new Uint8ClampedArray(e*o),h=new Uint8ClampedArray(e*o*3),g=new Uint16Array(e*o),M=new Uint16Array(e*o);let d;switch(i){case"sphere-tracer":d=new Z;break;case"fixed-step":d=new ve;break;default:d=new Z}d.runRaymarcher(m,S,h,g,M,e,t,s,a,n);const T={yStart:a,yEnd:n,depth:S,normal:h,sdfEval:g,iters:M};self.postMessage(T,[S.buffer,h.buffer,g.buffer,M.buffer])}})();
